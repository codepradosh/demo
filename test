import { useState, useEffect, useRef, useMemo, useCallback } from "react";
import { flushSync } from "react-dom";
import { useNavigate } from "react-router-dom";
import { useTheme } from "next-themes";
import { motion, AnimatePresence } from "framer-motion";
import { Button } from "@/components/ui/button";
import { Textarea } from "@/components/ui/textarea";
import { Input } from "@/components/ui/input";
import { Badge } from "@/components/ui/badge";
import ReactECharts from "echarts-for-react";
import {
  Send,
  Plus,
  Sparkles,
  FileText,
  AlertTriangle,
  Download,
  Clipboard,
  CheckCircle2,
  BarChart3,
  ChevronRight,
  PanelRightClose,
  PanelRight,
  Menu,
  ChevronDown,
  ChevronUp,
  MessageSquare,
  Square,
  Mic,
  Zap,
  Brain,
  GraduationCap,
  Search,
  Check,
  ThumbsUp,
  ThumbsDown,
  Loader2,
  Settings,
  User,
  History,
  TrendingUp,
  PieChart,
  X,
  Maximize2,
  LogOut,
} from "lucide-react";
import { ThemeToggle } from "@/components/ThemeToggle";
import { ChatHistory } from "@/components/ChatHistory";
import { TypewriterText } from "@/components/TypewriterText";
import { exportToCSV, exportTextToCSV, exportGzipToCSV } from "@/lib/csvExport";
import { authenticatedFetch, logout as apiLogout, getToken, getUser, createSession, addMessage, getSession, ChatMessage as BackendChatMessage, isAuthenticated } from "@/lib/api";
import { toast } from "sonner";
import { useFlashlightHover } from "@/hooks/useFlashlightHover";
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuLabel,
  DropdownMenuSeparator,
  DropdownMenuTrigger,
} from "@/components/ui/dropdown-menu";

const API_BASE = "http://localhost:8000";
const REQUEST_TIMEOUT = 1200000;

const prettyJson = (obj: unknown): string => {
  try { return JSON.stringify(obj, null, 2); } catch { return String(obj); }
};

// Unified Icon Container - Fixed dimensions, perfect alignment
const IconContainer = ({
  icon: Icon,
  label,
  isActive = false,
  onClick,
  tooltip,
  isCollapsed = false,
  size = "default"
}: {
  icon: any;
  label: string;
  isActive?: boolean;
  onClick: () => void;
  tooltip: string;
  isCollapsed?: boolean;
  size?: "default" | "small";
}) => {
  const { theme } = useTheme();
  const [mounted, setMounted] = useState(false);
  const [isHovered, setIsHovered] = useState(false);

  useEffect(() => { setMounted(true); }, []);
  const isDark = mounted && theme === "dark";

  const opacityHover = "0.08";
  const opacityActive = "0.12";
  const textMuted = isDark ? `rgba(255,255,255,0.4)` : `rgba(61,57,41,0.5)`;
  const textPrimary = isDark ? `rgba(255,255,255,0.9)` : `rgba(61,57,41,0.9)`;
  const borderColor = isDark ? `rgba(255,255,255,0.06)` : `rgba(61,57,41,0.06)`;

  // Fixed dimensions - CRITICAL for alignment
  const iconSize = size === "small" ? "h-4 w-4" : "h-5 w-5";
  const containerSize = size === "small" ? "w-8 h-8" : "w-10 h-10";

  return (
    <div
      className="relative w-full flex justify-center"
      style={{
        width: '100%',
        display: 'flex',
        justifyContent: 'center',
        alignItems: 'center'
      }}
    >
      <button
        onClick={onClick}
        onMouseEnter={() => setIsHovered(true)}
        onMouseLeave={() => setIsHovered(false)}
        className="flex items-center justify-center rounded-lg transition-all duration-150 ease-out cursor-pointer"
        style={{
          // Fixed container dimensions - CRITICAL for alignment
          width: isCollapsed ? '40px' : '100%',
          height: size === "small" ? '32px' : '40px',
          minWidth: isCollapsed ? '40px' : 'auto',
          minHeight: size === "small" ? '32px' : '40px',
          maxWidth: isCollapsed ? '40px' : '100%',
          // Only background changes - NO padding/margin/size changes
          background: isActive
            ? (isDark ? "rgba(227,93,36,0.12)" : "rgba(227,93,36,0.1)")
            : isHovered
              ? (isDark ? `rgba(255,255,255,${opacityHover})` : `rgba(61,57,41,${opacityHover})`)
              : "transparent",
          color: isActive
            ? (isDark ? "rgba(255,255,255,0.9)" : "rgba(61,57,41,0.9)")
            : textMuted,
          // Transform only - NO layout shift
          transform: isHovered ? "translateY(-1px)" : "translateY(0)",
          // Fixed padding - consistent across all states
          padding: isCollapsed ? 0 : '0 12px',
          margin: 0,
        }}
        aria-label={label}
        title={tooltip}
      >
        {isCollapsed ? (
          <Icon className={iconSize} />
        ) : (
          <div className="w-full flex items-center gap-3" style={{ minHeight: size === "small" ? '32px' : '40px' }}>
            <Icon className={iconSize} style={{ flexShrink: 0 }} />
            <span
              className="text-sm font-medium transition-opacity duration-150 ease-out"
              style={{
                color: isActive
                  ? (isDark ? "rgba(255,255,255,0.9)" : "rgba(61,57,41,0.9)")
                  : textMuted,
                whiteSpace: 'nowrap',
                overflow: 'hidden',
                textOverflow: 'ellipsis'
              }}
            >
              {label}
            </span>
          </div>
        )}
      </button>
      {/* Tooltip - only show when collapsed */}
      {isHovered && isCollapsed && (
        <div
          className="absolute left-full ml-2 px-2 py-1 rounded text-xs whitespace-nowrap z-50 pointer-events-none"
          style={{
            background: isDark ? "rgba(30,30,30,0.95)" : "rgba(250,247,242,0.95)",
            color: textPrimary,
            border: `1px solid ${borderColor}`,
            boxShadow: isDark
              ? "0 4px 12px rgba(0,0,0,0.3)"
              : "0 4px 12px rgba(61,57,41,0.15)",
          }}
        >
          {tooltip}
        </div>
      )}
    </div>
  );
};

const CopyButton = ({ text }: { text: string }) => {
  const { theme } = useTheme();
  const [mounted, setMounted] = useState(false);
  const [copied, setCopied] = useState(false);
  const [isHovered, setIsHovered] = useState(false);
  useEffect(() => { setMounted(true); }, []);
  const isDark = mounted && theme === "dark";

  const opacityLight = "0.08";
  const opacitySoft = "0.12";
  const textMuted = isDark ? `rgba(255,255,255,0.4)` : `rgba(61,57,41,0.4)`;
  const textMutedHover = isDark ? `rgba(255,255,255,0.6)` : `rgba(61,57,41,0.6)`;

  const copy = async () => {
    try {
      // Try modern Clipboard API first
      if (navigator.clipboard && window.isSecureContext) {
        await navigator.clipboard.writeText(text);
        setCopied(true);
        toast.success("Copied!", { duration: 2000 });
        setTimeout(() => setCopied(false), 2000);
      } else {
        // Fallback for older browsers or non-HTTPS contexts
        const textArea = document.createElement("textarea");
        textArea.value = text;
        textArea.style.position = "fixed";
        textArea.style.left = "-999999px";
        textArea.style.top = "-999999px";
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        try {
          const successful = document.execCommand('copy');
          if (successful) {
            setCopied(true);
            toast.success("Copied!", { duration: 2000 });
            setTimeout(() => setCopied(false), 2000);
          } else {
            throw new Error('Copy command failed');
          }
        } finally {
          document.body.removeChild(textArea);
        }
      }
    } catch (error) {
      console.error('Copy failed:', error);
      toast.error("Failed to copy");
    }
  };

  return (
    <button
      onClick={copy}
      onMouseEnter={() => setIsHovered(true)}
      onMouseLeave={() => setIsHovered(false)}
      className="p-1.5 rounded transition-all focus:outline-none focus:ring-1 focus:ring-offset-0"
      style={{
        background: isHovered
          ? (isDark ? `rgba(255,255,255,${opacitySoft})` : `rgba(61,57,41,${opacitySoft})`)
          : "transparent",
        color: copied ? "#10b981" : (isHovered ? textMutedHover : textMuted),
        border: "none",
        transition: "background 150ms ease, color 150ms ease",
      }}
      aria-label={copied ? "Copied" : "Copy to clipboard"}
      title={copied ? "Copied!" : "Copy"}
    >
      {copied ? (
        <CheckCircle2 className="h-3.5 w-3.5" />
      ) : (
        <Clipboard className="h-3.5 w-3.5" />
      )}
    </button>
  );
};

interface RcaResult { ticket_data: Record<string, unknown>; generated_rca: string; }
interface AgentData { summary?: string; sql?: string; rows?: any[]; needs_visualization?: boolean; chart_type?: string; chart_spec?: any; error?: boolean; errorMessage?: string; partial?: boolean; type?: string; ticket_data?: Record<string, unknown>; generated_rca?: string; row_count?: number; filename?: string; csv_content?: string; }
type ActiveMode = "agent" | "ticket" | "csv";

interface ChatMessage {
  id: string;
  role: "user" | "assistant";
  content: string;
  agentData?: AgentData;
  timestamp: number;
}

interface RcaItem {
  id: string;
  state: "loading" | "success" | "error";
  data: RcaResult | null;
  error: string | null;
  ticketNumber: string;
  ticketMode: "TASK" | "RITM";
  timestamp: number;
  showTypewriter: boolean;
}

export function CopilotLayout() {
  const navigate = useNavigate();
  const { theme } = useTheme();
  const [mounted, setMounted] = useState(false);
  const [activeMode, setActiveMode] = useState<ActiveMode>("agent");
  const [modeDropdownOpen, setModeDropdownOpen] = useState(false);
  const [sidebarOpen, setSidebarOpen] = useState(false); // Start collapsed (icon-only)
  const [rightPanelOpen, setRightPanelOpen] = useState(false);
  const [insightsPanelWidth, setInsightsPanelWidth] = useState(460); // Default 460px
  const [isResizing, setIsResizing] = useState(false);
  const [activeNavItem, setActiveNavItem] = useState<string>("chat");
  const [chartFullscreen, setChartFullscreen] = useState(false);

  const [ticketMode, setTicketMode] = useState<"TASK" | "RITM">("TASK");
  const [taskNumber, setTaskNumber] = useState("");
  const [ritmNumber, setRitmNumber] = useState("");
  const [rcaItems, setRcaItems] = useState<RcaItem[]>([]);
  // Keep rcaLoading for backward compatibility with other parts of the code
  const rcaLoading = rcaItems.some(item => item.state === "loading");

  const [agentQuery, setAgentQuery] = useState("");
  const [agentLoading, setAgentLoading] = useState(false);
  const [messageFeedback, setMessageFeedback] = useState<Record<string, "up" | "down">>({});
  const [agentError, setAgentError] = useState("");
  const [agentResult, setAgentResult] = useState<string>("");
  const [agentData, setAgentData] = useState<AgentData | null>(null);
  const [showTypewriter, setShowTypewriter] = useState(false);
  const [conversation, setConversation] = useState<ChatMessage[]>([]);
  const [activeVisualizationMessageId, setActiveVisualizationMessageId] = useState<string | null>(null);
  const [currentSessionId, setCurrentSessionId] = useState<number | null>(null);
  const [historyRefreshTrigger, setHistoryRefreshTrigger] = useState(0);

  // CSV Generator state
  const [csvQuery, setCsvQuery] = useState("");
  const [csvLoading, setCsvLoading] = useState(false);
  const [csvError, setCsvError] = useState("");
  const [csvResult, setCsvResult] = useState<{ sql: string; row_count: number; filename: string; csv_content?: string; query?: string; sessionId?: number } | null>(null);

  const [queryCount, setQueryCount] = useState(0);
  const [loadingMessage, setLoadingMessage] = useState("Processing...");
  const [selectedHistoryId, setSelectedHistoryId] = useState<string | null>(null);
  const [chartKey, setChartKey] = useState(0);
  const [chatLoading, setChatLoading] = useState(false); // Loading state for chat switching

  // Chart interaction state for Insights panel
  const [hoveredElement, setHoveredElement] = useState<any>(null);
  const [insightContext, setInsightContext] = useState<"default" | "comparison" | "anomaly" | "trend">("default");
  const [hiddenSeries, setHiddenSeries] = useState<Set<string>>(new Set());
  const [isolatedSeries, setIsolatedSeries] = useState<string | null>(null);

  const chartRef = useRef<any>(null);
  const chartContainerRef = useRef<HTMLDivElement>(null);
  const textareaRef = useRef<HTMLTextAreaElement>(null);
  const inputRef = useRef<HTMLInputElement>(null);
  const [chatFocused, setChatFocused] = useState(false);
  const [chatBarCollapsed, setChatBarCollapsed] = useState(false);
  const [inputExpanded, setInputExpanded] = useState(false);
  const [inputHeight, setInputHeight] = useState(44); // Default height in px
  const [submitAcknowledged, setSubmitAcknowledged] = useState(false);
  const messagesEndRef = useRef<HTMLDivElement>(null);
  const chatContainerRef = useRef<HTMLDivElement>(null);
  const [isUserScrolling, setIsUserScrolling] = useState(false);
  const [shouldAutoScroll, setShouldAutoScroll] = useState(true);
  const abortControllerRef = useRef<AbortController | null>(null);
  const insightsPanelRef = useRef<HTMLDivElement>(null);
  const resizeHandleRef = useRef<HTMLDivElement>(null);
  const chatInputBarRef = useRef<HTMLDivElement>(null);
  const rcaUpdateRef = useRef<{ id: string; text: string } | null>(null);
  const agentUpdateRef = useRef<{ id: string; text: string } | null>(null);

  // Saved state for Agent mode (preserves session across mode switches)
  const [savedAgentState, setSavedAgentState] = useState<{
    sessionId: number | null;
    conversation: ChatMessage[];
    agentData: AgentData | null;
  } | null>(null);

  // Helper function to switch modes
  const switchToMode = useCallback((newMode: ActiveMode) => {
    // If switching FROM Agent mode to another mode, save Agent state
    if (activeMode === "agent" && newMode !== "agent") {
      setSavedAgentState({
        sessionId: currentSessionId,
        conversation: conversation,
        agentData: agentData
      });
    }

    // If switching TO Agent mode from another mode
    if (newMode === "agent" && activeMode !== "agent") {
      if (savedAgentState) {
        // Restore saved Agent state
        setCurrentSessionId(savedAgentState.sessionId);
        setConversation(savedAgentState.conversation);
        setAgentData(savedAgentState.agentData);
      } else {
        // No saved state, start fresh
        setCurrentSessionId(null);
        setConversation([]);
        setAgentData(null);
      }
    }

    // Switch the mode
    setActiveMode(newMode);
  }, [activeMode, currentSessionId, conversation, agentData, savedAgentState]);

  useEffect(() => {
    setMounted(true);
    const stored = localStorage.getItem("query-count");
    if (stored) setQueryCount(parseInt(stored, 10) || 0);

    // Load saved insights panel width
    const savedWidth = localStorage.getItem("insights-panel-width");
    if (savedWidth) {
      const width = parseInt(savedWidth, 10);
      if (width >= 380 && width <= 560) {
        setInsightsPanelWidth(width);
      }
    }
  }, []);

  // Force immediate UI update when tab becomes visible
  // This ensures pending state updates from background streaming are rendered immediately
  const [, forceUpdate] = useState(0);
  useEffect(() => {
    const handleVisibilityChange = () => {
      if (document.visibilityState === 'visible') {
        // Force React to re-render to display any accumulated state changes
        forceUpdate(n => n + 1);
      }
    };

    document.addEventListener('visibilitychange', handleVisibilityChange);
    return () => {
      document.removeEventListener('visibilitychange', handleVisibilityChange);
    };
  }, []);

  // Auto-resize textarea based on content
  useEffect(() => {
    if (textareaRef.current) {
      const textarea = textareaRef.current;
      // Reset height to auto to get the correct scrollHeight
      textarea.style.height = 'auto';
      const scrollHeight = textarea.scrollHeight;
      const minHeight = 44; // Default height
      const maxHeight = 200; // Max height before scrolling

      if (scrollHeight > minHeight) {
        const newHeight = Math.min(scrollHeight, maxHeight);
        textarea.style.height = `${newHeight}px`;
        setInputHeight(newHeight);
        setInputExpanded(newHeight > minHeight);

        // Enable scrolling if content exceeds max height
        if (scrollHeight > maxHeight) {
          textarea.style.overflowY = 'auto';
        } else {
          textarea.style.overflowY = 'hidden';
        }
      } else {
        textarea.style.height = `${minHeight}px`;
        setInputHeight(minHeight);
        setInputExpanded(false);
        textarea.style.overflowY = 'hidden';
      }
    }
  }, [agentQuery]);


  // Handle collapse button click
  const handleInputCollapse = useCallback(() => {
    if (textareaRef.current) {
      const textarea = textareaRef.current;
      const currentScrollTop = textarea.scrollTop;
      const currentSelectionStart = textarea.selectionStart;

      textarea.style.height = '44px';
      textarea.style.overflowY = 'hidden';
      setInputHeight(44);
      setInputExpanded(false);

      // Preserve cursor position and scroll
      setTimeout(() => {
        textarea.focus();
        textarea.setSelectionRange(currentSelectionStart, currentSelectionStart);
      }, 0);
    }
  }, []);

  // Handle panel resizing
  useEffect(() => {
    if (!isResizing || !resizeHandleRef.current) return;

    const handleMouseMove = (e: MouseEvent) => {
      const newWidth = window.innerWidth - e.clientX;
      const clampedWidth = Math.max(380, Math.min(560, newWidth));
      setInsightsPanelWidth(clampedWidth);
      localStorage.setItem("insights-panel-width", clampedWidth.toString());
    };

    const handleMouseUp = () => {
      setIsResizing(false);
    };

    document.addEventListener("mousemove", handleMouseMove);
    document.addEventListener("mouseup", handleMouseUp);
    document.body.style.cursor = "col-resize";
    document.body.style.userSelect = "none";

    return () => {
      document.removeEventListener("mousemove", handleMouseMove);
      document.removeEventListener("mouseup", handleMouseUp);
      document.body.style.cursor = "";
      document.body.style.userSelect = "";
    };
  }, [isResizing]);

  // Get the active visualization data (from active message or current agentData)
  const activeVizData = useMemo(() => {
    if (activeVisualizationMessageId) {
      const activeMessage = conversation.find(msg => msg.id === activeVisualizationMessageId);
      if (activeMessage?.agentData?.needs_visualization) {
        return activeMessage.agentData;
      }
    }
    return agentData;
  }, [activeVisualizationMessageId, conversation, agentData]);

  // Dispose chart when agentData is cleared
  useEffect(() => {
    if (!agentData?.needs_visualization && chartRef.current) {
      try {
        const instance = chartRef.current.getEchartsInstance();
        if (instance && instance.dispose) {
          instance.dispose();
        }
      } catch (error) {
        console.warn('[Chart Cleanup] Error disposing chart:', error);
      }
    }
  }, [agentData?.needs_visualization]);

  // Handle chart resize on various events (window resize, zoom changes, panel width changes)
  useEffect(() => {
    const chartData = activeVizData || agentData;
    if (chartData?.needs_visualization && chartRef.current && rightPanelOpen) {
      const resizeChart = () => {
        if (chartRef.current && chartContainerRef.current) {
          try {
            const instance = chartRef.current.getEchartsInstance();
            if (instance && instance.resize) {
              // Get actual container dimensions (not viewport)
              const container = chartContainerRef.current;
              const containerWidth = container.offsetWidth;
              const containerHeight = container.offsetHeight;

              // Use requestAnimationFrame for smooth resizing
              requestAnimationFrame(() => {
                instance.resize({
                  width: containerWidth,
                  height: containerHeight
                });
              });
            }
          } catch (error) {
            console.warn('[Chart Resize] Error resizing chart:', error);
          }
        }
      };

      // Initial resize with multiple attempts to handle timing issues
      const timeouts = [
        setTimeout(resizeChart, 50),
        setTimeout(resizeChart, 150),
        setTimeout(resizeChart, 300),
        setTimeout(resizeChart, 500),
      ];

      // Window resize listener (handles both window resize and zoom changes)
      const handleResize = () => {
        resizeChart();
      };

      // Add listeners
      window.addEventListener('resize', handleResize);

      // Also listen for orientation changes (mobile/tablet)
      window.addEventListener('orientationchange', handleResize);

      return () => {
        timeouts.forEach(clearTimeout);
        window.removeEventListener('resize', handleResize);
        window.removeEventListener('orientationchange', handleResize);
      };
    }
  }, [activeVizData?.chart_spec, agentData?.chart_spec, rightPanelOpen, activeVizData?.needs_visualization, agentData?.needs_visualization]);

  // Additional resize handler when panel opens/closes
  useEffect(() => {
    if (rightPanelOpen && chartRef.current) {
      const resizeChart = () => {
        if (chartRef.current) {
          const instance = chartRef.current.getEchartsInstance();
          if (instance) {
            instance.resize();
          }
        }
      };

      // Multiple resize attempts to ensure chart renders properly
      const timeouts = [
        setTimeout(resizeChart, 50),
        setTimeout(resizeChart, 150),
        setTimeout(resizeChart, 300),
        setTimeout(resizeChart, 500),
      ];

      return () => {
        timeouts.forEach(clearTimeout);
      };
    }
  }, [rightPanelOpen]);

  // Use ResizeObserver for better container size tracking (tracks actual container width, not viewport)
  useEffect(() => {
    const chartData = activeVizData || agentData;
    if (!chartContainerRef.current || !chartRef.current || !chartData?.needs_visualization || !rightPanelOpen) return;

    const resizeObserver = new ResizeObserver((entries) => {
      if (chartRef.current && entries.length > 0) {
        try {
          const entry = entries[0];
          const { width, height } = entry.contentRect;

          const instance = chartRef.current.getEchartsInstance();
          if (instance && instance.resize) {
            // Resize using actual container dimensions (not viewport/zoom dependent)
            requestAnimationFrame(() => {
              instance.resize({
                width: width,
                height: height
              });
            });
          }
        } catch (error) {
          console.warn('[ResizeObserver] Error resizing chart:', error);
        }
      }
    });

    resizeObserver.observe(chartContainerRef.current);

    return () => {
      resizeObserver.disconnect();
    };
  }, [activeVizData?.needs_visualization, agentData?.needs_visualization, rightPanelOpen]);

  // Auto-close Insights panel when switching to Ticket/RCA Analyser mode
  useEffect(() => {
    if (activeMode === "ticket" && rightPanelOpen) {
      setRightPanelOpen(false);
    }
  }, [activeMode]);

  // Handle ESC key to close fullscreen modal
  useEffect(() => {
    const handleEscape = (e: KeyboardEvent) => {
      if (e.key === 'Escape' && chartFullscreen) {
        setChartFullscreen(false);
      }
    };
    window.addEventListener('keydown', handleEscape);
    return () => window.removeEventListener('keydown', handleEscape);
  }, [chartFullscreen]);

  // Reset insight context and interactions when chart changes
  useEffect(() => {
    if (agentData?.chart_spec) {
      setHoveredElement(null);
      setInsightContext("default");
      setHiddenSeries(new Set());
      setIsolatedSeries(null);
    }
  }, [agentData?.chart_spec, chartKey]);

  // Force chart re-render when metrics are toggled
  useEffect(() => {
    const chartData = activeVizData || agentData;
    if (chartData?.needs_visualization && (hiddenSeries.size > 0 || isolatedSeries !== null)) {
      setChartKey(prev => prev + 1);
    }
  }, [hiddenSeries, isolatedSeries, agentData?.needs_visualization]);

  // Check if user is at bottom of chat (within 2px threshold - Copilot-style)
  const isAtBottom = useCallback(() => {
    if (!chatContainerRef.current) return true;
    const container = chatContainerRef.current;
    const threshold = 2; // pixels from bottom (strict Copilot-style)
    const distanceFromBottom = container.scrollHeight - container.scrollTop - container.clientHeight;
    return distanceFromBottom <= threshold;
  }, []);

  // Force scroll to bottom (always, used when user sends a message)
  const forceScrollToBottom = useCallback(() => {
    if (!chatContainerRef.current) return;
    const container = chatContainerRef.current;
    container.scrollTo({
      top: container.scrollHeight,
      behavior: "smooth"
    });
  }, []);

  // Auto-scroll to bottom function (only if user is at bottom)
  const scrollToBottom = useCallback(() => {
    if (!shouldAutoScroll || !chatContainerRef.current) return;
    if (!isAtBottom()) return; // Don't auto-scroll if user scrolled up

    const container = chatContainerRef.current;
    // Use scrollTo for smoother behavior instead of scrollIntoView
    container.scrollTo({
      top: container.scrollHeight,
      behavior: "smooth"
    });
  }, [shouldAutoScroll, isAtBottom]);

  // Force scroll when user sends a message (new user message added)
  useEffect(() => {
    const lastMessage = conversation[conversation.length - 1];
    // If the last message is from user, force scroll to bottom
    if (lastMessage?.role === "user") {
      // Small delay to ensure DOM is updated
      setTimeout(() => {
        forceScrollToBottom();
      }, 50);
    }
  }, [conversation, forceScrollToBottom]);

  // Auto-scroll to latest message - continuous during generation (only if user is at bottom)
  useEffect(() => {
    // Only auto-scroll if user is at bottom
    if (isAtBottom() && shouldAutoScroll) {
      // Use requestAnimationFrame for smoother initial scroll
      requestAnimationFrame(() => {
        scrollToBottom();
      });
    }

    // Continuous scroll during generation - throttled for smooth scrolling
    let intervalId: NodeJS.Timeout | null = null;

    if (agentLoading || rcaLoading) {
      // Use a longer interval (300ms) to avoid interrupting smooth scroll animations
      // This allows the smooth scroll to complete before the next scroll call
      intervalId = setInterval(() => {
        if (shouldAutoScroll && isAtBottom()) {
          scrollToBottom();
        }
      }, 300); // Increased from 150ms to 300ms for smoother scrolling
    }

    return () => {
      if (intervalId) {
        clearInterval(intervalId);
      }
    };
  }, [conversation, agentLoading, rcaLoading, scrollToBottom, shouldAutoScroll, isAtBottom]);

  // Track user scroll behavior for auto-scroll
  useEffect(() => {
    const container = chatContainerRef.current;
    if (!container) return;

    const handleScroll = () => {
      const atBottom = isAtBottom();

      if (atBottom) {
        // User is at bottom - enable auto-scroll
        setShouldAutoScroll(true);
      } else {
        // User scrolled up - disable auto-scroll
        setShouldAutoScroll(false);
      }
    };

    container.addEventListener("scroll", handleScroll, { passive: true });

    // Also check on content changes (ResizeObserver for scrollHeight changes)
    const resizeObserver = new ResizeObserver(() => {
      handleScroll();
    });

    resizeObserver.observe(container);

    // Initial check
    handleScroll();

    return () => {
      container.removeEventListener("scroll", handleScroll);
      resizeObserver.disconnect();
    };
  }, [isAtBottom]);

  // Stop auto-scroll during streaming if user scrolls up
  useEffect(() => {
    if (!(agentLoading || rcaLoading)) return;

    // Check periodically during streaming - if user scrolls up, stop auto-scroll
    const checkInterval = setInterval(() => {
      if (!isAtBottom()) {
        setShouldAutoScroll(false); // STOP auto-scroll if user scrolled up
      }
    }, 100);

    return () => clearInterval(checkInterval);
  }, [agentLoading, rcaLoading, isAtBottom]);

  // Mode-specific loading messages
  const agentLoadingMessages = useMemo(() => [
    "ðŸ” Agent Scout: Interpreting query intent...",
    "ðŸ§  Agent Cortex: Activating data pipelines...",
    "ðŸ” Agent Scout: Querying knowledge base...",
    "ðŸ§  Agent Cortex: Analyzing data relationships...",
    "ðŸ” Agent Scout: Gathering contextual insights...",
    "ðŸ§  Agent Cortex: Validating response accuracy...",
    "ðŸ¤ Both agents: Crafting intelligent response...",
    "âœ¨ Finalizing answer..."
  ], []);

  const ticketLoadingMessages = useMemo(() => [
    "ðŸ” Agent Scout: Analyzing ticket structure...",
    "ðŸ§  Agent Cortex: Mining historical incidents...",
    "ðŸ” Agent Scout: Identifying root cause indicators...",
    "ðŸ§  Agent Cortex: Cross-referencing patterns...",
    "ðŸ” Agent Scout: Building RCA framework...",
    "ðŸ§  Agent Cortex: Validating conclusions...",
    "ðŸ¤ Both agents: Synthesizing comprehensive report...",
    "âœ¨ Finalizing RCA document..."
  ], []);
  const msgIdx = useRef(0);
  useEffect(() => {
    if (!rcaLoading && !agentLoading) { setLoadingMessage("Processing..."); msgIdx.current = 0; return; }

    // Select appropriate messages based on active mode
    const currentMessages = activeMode === "ticket" ? ticketLoadingMessages : agentLoadingMessages;

    setLoadingMessage(currentMessages[0]);
    const interval = setInterval(() => {
      msgIdx.current = (msgIdx.current + 1) % currentMessages.length;
      setLoadingMessage(currentMessages[msgIdx.current]);
    }, 2500);
    return () => clearInterval(interval);
  }, [rcaLoading, agentLoading, activeMode, agentLoadingMessages, ticketLoadingMessages]);

  const isDark = mounted && theme === "dark";

  // Flashlight hover effect for chat input bar
  const { mouseX, mouseY, isHovering } = useFlashlightHover(chatInputBarRef, isDark);

  // Warm Claude-style colors - Using CSS variables for consistency
  const bgMain = isDark ? "#151513" : "#FAF7F2";
  const bgSurface = isDark ? "#1C1B18" : "#FFFFFF";
  const textPrimary = isDark ? "#E8E4DC" : "#3D3929";
  const textMuted = isDark ? "rgba(232,228,220,0.5)" : "rgba(61,57,41,0.55)";
  const borderColor = isDark ? "rgba(255,255,255,0.06)" : "rgba(61,57,41,0.08)";

  // Opacity tokens for consistent styling
  const opacitySubtle = "0.03";
  const opacityLight = "0.05";
  const opacitySoft = "0.08";
  const opacityMedium = "0.12";
  const opacityMuted = "0.5";
  const opacityDefault = "0.55";
  const opacityEmphasis = "0.75";

  const submitRca = async () => {
    const ticketNumber = ticketMode === "TASK" ? taskNumber.trim() : ritmNumber.trim();
    const rcaId = `rca-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;

    // Create session immediately (before API call) for instant sidebar update
    let sessionId: number | null = null;
    if (isAuthenticated()) {
      try {
        const session = await createSession(`${ticketMode}: ${ticketNumber}`);
        sessionId = session.id;
        setSelectedHistoryId(`session-${sessionId}`); // Highlight the new session in sidebar
        // Refresh history list immediately so session appears in sidebar
        setHistoryRefreshTrigger(prev => prev + 1);
      } catch (error) {
        console.error('Failed to create session:', error);
        // Continue without session saving
      }
    }

    // Immediately create loading placeholder
    const loadingItem: RcaItem = {
      id: rcaId,
      state: "loading",
      data: null,
      error: null,
      ticketNumber,
      ticketMode,
      timestamp: Date.now(),
      showTypewriter: false
    };

    setRcaItems(prev => [...prev, loadingItem]);
    setShouldAutoScroll(true);

    // Force scroll to bottom immediately
    setTimeout(() => {
      forceScrollToBottom();
    }, 50);

    // Clear input
    if (ticketMode === "TASK") {
      setTaskNumber("");
    } else {
      setRitmNumber("");
    }

    // Make API call asynchronously
    const controller = new AbortController();
    const timeout = setTimeout(() => controller.abort(), REQUEST_TIMEOUT);

    try {
      const body = ticketMode === "TASK" ? { rtsk_number: ticketNumber } : { ritm_number: ticketNumber };
      const token = getToken();
      const headers: HeadersInit = {
        "Content-Type": "application/json",
        "Accept": "text/event-stream",
        "Cache-Control": "no-cache"
      };
      if (token) {
        headers["Authorization"] = `Bearer ${token}`;
      }
      const res = await fetch(`${API_BASE}/get-details`, {
        method: "POST",
        headers,
        body: JSON.stringify(body),
        signal: controller.signal
      });
      clearTimeout(timeout);

      if (!res.ok) {
        throw new Error(await res.text() || `HTTP ${res.status}`);
      }

      // Handle SSE stream
      const reader = res.body?.getReader();
      const decoder = new TextDecoder();

      if (!reader) {
        throw new Error("Response body is not readable");
      }

      let ticketData: Record<string, unknown> | null = null;
      let rcaChunks: string[] = [];
      let buffer = "";
      let streamComplete = false;

      // Process buffer and update UI immediately - NO throttling
      const processBuffer = () => {
        while (true) {
          const newlineIndex = buffer.indexOf('\n');
          if (newlineIndex === -1) break;

          const line = buffer.slice(0, newlineIndex).trim();
          buffer = buffer.slice(newlineIndex + 1);

          if (line.startsWith('data: ')) {
            try {
              const jsonStr = line.slice(6);
              const parsed = JSON.parse(jsonStr);

              if (parsed.type === 'ticket_data') {
                ticketData = parsed.data;
                flushSync(() => {
                  setRcaItems(prev => prev.map(item =>
                    item.id === rcaId
                      ? { ...item, data: { ticket_data: ticketData!, generated_rca: "" } }
                      : item
                  ));
                });
              } else if (parsed.type === 'rca_chunk') {
                rcaChunks.push(parsed.content);
                const currentRca = rcaChunks.join('');

                // Update UI IMMEDIATELY for EVERY chunk - no batching
                // Set state to "success" immediately so text renders (not loading spinner)
                flushSync(() => {
                  setRcaItems(prev => prev.map(item =>
                    item.id === rcaId
                      ? {
                        ...item,
                        state: "success", // Change to success immediately so text section renders
                        data: { ticket_data: ticketData || {}, generated_rca: currentRca },
                        showTypewriter: false // Show text immediately, no typewriter animation during streaming
                      }
                      : item
                  ));
                });
              } else if (parsed.type === 'done') {
                // Final update
                const finalRca = rcaChunks.join('');
                flushSync(() => {
                  setRcaItems(prev => prev.map(item =>
                    item.id === rcaId
                      ? { ...item, state: "success", data: { ticket_data: ticketData || {}, generated_rca: finalRca }, showTypewriter: true }
                      : item
                  ));
                });
                streamComplete = true;
                return true;
              } else if (parsed.type === 'error') {
                throw new Error(parsed.message || 'Stream error');
              }
            } catch (e) {
              console.error('Error parsing SSE chunk:', e, line);
            }
          }
        }
        return false;
      };

      // Read stream chunks continuously - process immediately
      while (!streamComplete) {
        const { done, value } = await reader.read();

        if (done) {
          if (buffer.trim()) {
            processBuffer();
          }
          break;
        }

        // Decode immediately
        buffer += decoder.decode(value, { stream: true });

        // Process all complete lines immediately
        const shouldStop = processBuffer();
        if (shouldStop) break;
      }

      // Finalize with complete data
      const data: RcaResult = {
        ticket_data: ticketData || {},
        generated_rca: rcaChunks.join('')
      };

      // Update the loading item with success data
      setRcaItems(prev => prev.map(item =>
        item.id === rcaId
          ? { ...item, state: "success", data, showTypewriter: true }
          : item
      ));

      setQueryCount(prev => {
        const n = prev + 1;
        localStorage.setItem("query-count", n.toString());
        return n;
      });

      // Save RCA to backend session (session already created above)
      if (sessionId && isAuthenticated()) {
        try {
          // Save user query (ticket lookup) as user message
          await addMessage(sessionId, {
            role: "user",
            content: `${ticketMode}: ${ticketNumber}`,
            timestamp: Date.now(),
          });

          // Save RCA response as assistant message
          await addMessage(sessionId, {
            role: "assistant",
            content: data.generated_rca || JSON.stringify(data.ticket_data, null, 2),
            agent_data: {
              type: "rca",
              ticket_data: data.ticket_data,
              generated_rca: data.generated_rca
            },
            timestamp: Date.now(),
          });
        } catch (error) {
          console.error('Failed to save RCA to session:', error);
        }
      }

      (window as any).addChatHistory?.({
        type: "rca",
        query: `${ticketMode}: ${ticketNumber}`,
        response: data.generated_rca || JSON.stringify(data.ticket_data, null, 2)
      });
    } catch (e: any) {
      clearTimeout(timeout);
      const errorMessage = e.name === "AbortError" ? "Request timed out." : (e.message || "Error");

      // Update the loading item with error state
      setRcaItems(prev => prev.map(item =>
        item.id === rcaId
          ? { ...item, state: "error", error: errorMessage }
          : item
      ));

      // Save error to session so it persists in chat history
      if (sessionId && isAuthenticated()) {
        try {
          // Save user query as user message (if not already saved)
          await addMessage(sessionId, {
            role: "user",
            content: `${ticketMode}: ${ticketNumber}`,
            timestamp: Date.now(),
          });

          // Save error as assistant message with error flag
          await addMessage(sessionId, {
            role: "assistant",
            content: "", // Empty content - placeholder will show based on error flag
            agent_data: {
              type: "rca",
              error: true,
              errorMessage: errorMessage
            },
            timestamp: Date.now(),
          });
        } catch (err) {
          console.error('Failed to save RCA error to session:', err);
        }
      }
    }
  };

  const stopGeneration = () => {
    if (abortControllerRef.current) {
      abortControllerRef.current.abort();
      abortControllerRef.current = null;
    }
    setAgentLoading(false);
    setShowTypewriter(false);
    setShouldAutoScroll(false);
  };

  const submitAgent = async () => {
    const userQuery = agentQuery.trim();
    if (!userQuery) return;

    // Close visualization panel if open to prevent crashes on repeated queries
    if (rightPanelOpen) {
      setRightPanelOpen(false);
    }

    // Ensure we have a session (create if needed)
    let sessionId = currentSessionId;
    if (!sessionId && isAuthenticated()) {
      try {
        const session = await createSession(userQuery.substring(0, 100)); // Use query as title
        sessionId = session.id;
        setCurrentSessionId(sessionId);
        setSelectedHistoryId(`session-${sessionId}`); // Highlight the new session in sidebar
        // Refresh history list after creating session
        setHistoryRefreshTrigger(prev => prev + 1);
      } catch (error) {
        console.error('Failed to create session:', error);
        // Continue without session saving
      }
    }

    // Add user message to conversation
    const userMessage: ChatMessage = {
      id: `user-${Date.now()}`,
      role: "user",
      content: userQuery,
      timestamp: Date.now(),
    };
    setConversation(prev => [...prev, userMessage]);

    // Save user message to session
    if (sessionId && isAuthenticated()) {
      try {
        await addMessage(sessionId, {
          role: "user",
          content: userQuery,
          timestamp: userMessage.timestamp,
        });
      } catch (error) {
        console.error('Failed to save user message:', error);
      }
    }

    setAgentError("");
    setAgentData(null);
    setAgentResult(""); // Clear previous result to show loading indicator
    setChartKey(prev => prev + 1); // Force chart remount
    setAgentLoading(true);
    setAgentQuery(""); // Clear input immediately
    setShouldAutoScroll(true);

    // Create new AbortController and store in ref
    const controller = new AbortController();
    abortControllerRef.current = controller;
    const timeout = setTimeout(() => controller.abort(), REQUEST_TIMEOUT);

    // Create assistant message ID before try block so it's accessible in error handler
    const assistantMessageId = `assistant-${Date.now()}`;

    try {
      const token = getToken();
      const headers: HeadersInit = {
        "Content-Type": "application/json",
        "Accept": "text/event-stream",
        "Cache-Control": "no-cache"
      };
      if (token) {
        headers["Authorization"] = `Bearer ${token}`;
      }

      // Build context from recent conversation (last 4 messages for memory)
      const recentContext = conversation.slice(-4).map(msg => ({
        role: msg.role,
        content: msg.content
      }));

      const res = await fetch(`${API_BASE}/agent-query`, {
        method: "POST",
        headers,
        body: JSON.stringify({
          query: userQuery,
          theme: theme === "dark" ? "dark" : "light",
          context: recentContext
        }),
        signal: controller.signal
      });
      clearTimeout(timeout);
      if (!res.ok) {
        if (res.status === 401) {
          apiLogout();
          navigate('/');
          throw new Error("Authentication expired. Please login again.");
        }
        throw new Error(await res.text() || `HTTP ${res.status}`);
      }

      // Handle SSE stream
      const reader = res.body?.getReader();
      const decoder = new TextDecoder();

      if (!reader) {
        throw new Error("Response body is not readable");
      }

      let metadata: any = null;
      let summaryChunks: string[] = [];
      let buffer = "";
      let streamComplete = false;

      // Create initial assistant message placeholder
      const initialMessage: ChatMessage = {
        id: assistantMessageId,
        role: "assistant",
        content: "",
        agentData: undefined,
        timestamp: Date.now(),
      };
      setConversation(prev => [...prev, initialMessage]);

      // Process buffer and update UI immediately - NO throttling
      const processBuffer = () => {
        while (true) {
          const newlineIndex = buffer.indexOf('\n');
          if (newlineIndex === -1) break;

          const line = buffer.slice(0, newlineIndex).trim();
          buffer = buffer.slice(newlineIndex + 1);

          if (line.startsWith('data: ')) {
            try {
              const jsonStr = line.slice(6);
              const parsed = JSON.parse(jsonStr);

              if (parsed.type === 'metadata') {
                metadata = {
                  sql: parsed.sql,
                  rows: parsed.rows,
                  needs_visualization: parsed.needs_visualization,
                  chart_type: parsed.chart_type,
                  chart_spec: parsed.chart_spec,
                  csv_data: parsed.csv_data,
                  is_downloadable: parsed.is_downloadable
                };

                // Update message with metadata immediately
                flushSync(() => {
                  setConversation(prev => prev.map(msg =>
                    msg.id === assistantMessageId
                      ? { ...msg, agentData: metadata }
                      : msg
                  ));
                  setAgentData(metadata);
                  // Set this message as the active visualization
                  setActiveVisualizationMessageId(assistantMessageId);
                });

                // Debug logging
                if (metadata.needs_visualization) {
                  console.log('[Chart Debug] needs_visualization:', metadata.needs_visualization);
                  console.log('[Chart Debug] chart_type:', metadata.chart_type);
                  console.log('[Chart Debug] has chart_spec:', !!metadata.chart_spec);
                  console.log('[Chart Debug] chart_spec keys:', metadata.chart_spec ? Object.keys(metadata.chart_spec) : 'none');
                  if (metadata.chart_spec?.series) {
                    console.log('[Chart Debug] series count:', metadata.chart_spec.series.length);
                    console.log('[Chart Debug] first series:', metadata.chart_spec.series[0]);
                  }
                }

                // Open right panel if visualization needed
                if (metadata.needs_visualization) {
                  setRightPanelOpen(true);
                }
              } else if (parsed.type === 'summary_chunk') {
                summaryChunks.push(parsed.content);
                const currentSummary = summaryChunks.join('');

                // Update UI IMMEDIATELY for EVERY chunk - no batching
                flushSync(() => {
                  setConversation(prev => prev.map(msg =>
                    msg.id === assistantMessageId
                      ? { ...msg, content: currentSummary, agentData: metadata }
                      : msg
                  ));
                  setAgentResult(currentSummary);
                });
              } else if (parsed.type === 'done') {
                // Final update
                const finalSummary = summaryChunks.join('');
                flushSync(() => {
                  setConversation(prev => prev.map(msg =>
                    msg.id === assistantMessageId
                      ? { ...msg, content: finalSummary, agentData: metadata }
                      : msg
                  ));
                  setAgentResult(finalSummary);
                  setAgentData({ summary: finalSummary, ...metadata });
                });
                streamComplete = true;
                return true;
              } else if (parsed.type === 'error') {
                throw new Error(parsed.message || 'Stream error');
              }
            } catch (e) {
              console.error('Error parsing SSE chunk:', e, line);
            }
          }
        }
        return false;
      };

      // Read stream chunks continuously - process immediately
      while (!streamComplete) {
        const { done, value } = await reader.read();

        if (done) {
          if (buffer.trim()) {
            processBuffer();
          }
          break;
        }

        // Decode immediately
        buffer += decoder.decode(value, { stream: true });

        // Process all complete lines immediately
        const shouldStop = processBuffer();
        if (shouldStop) break;

        // CRITICAL: Yield to browser after processing to allow rendering
        // Using MessageChannel instead of setTimeout because setTimeout gets
        // throttled to 1 second in background tabs, pausing the stream
        await new Promise(resolve => {
          const channel = new MessageChannel();
          channel.port1.onmessage = () => resolve(undefined);
          channel.port2.postMessage(null);
        });
      }

      // Finalize with complete data
      const summary = summaryChunks.join('');
      const finalData = {
        summary,
        ...metadata
      };

      // Update final message
      setConversation(prev => prev.map(msg =>
        msg.id === assistantMessageId
          ? { ...msg, content: summary, agentData: finalData }
          : msg
      ));

      // Keep legacy state for compatibility
      setAgentResult(summary);
      setAgentData(finalData);
      setShowTypewriter(true);
      setQueryCount(prev => { const n = prev + 1; localStorage.setItem("query-count", n.toString()); return n; });
      (window as any).addChatHistory?.({ type: "agent", query: userQuery, response: summary, agentData: finalData });

      // Save assistant message to session
      if (sessionId && isAuthenticated()) {
        try {
          await addMessage(sessionId, {
            role: "assistant",
            content: summary,
            agent_data: finalData,
            timestamp: Date.now(),
          });
          // Refresh history list after saving message
          setHistoryRefreshTrigger(prev => prev + 1);
        } catch (error) {
          console.error('Failed to save assistant message:', error);
        }
      }
    } catch (e: any) {
      clearTimeout(timeout);
      // Don't show error if user manually stopped generation
      if (e.name === "AbortError") {
        // User stopped generation - save partial response if any
        // Get the current conversation to find partial response
        setConversation(prev => {
          const lastAssistantMsg = [...prev].reverse().find(
            msg => msg.role === "assistant"
          );
          // Save partial response to session if we have content or mark as interrupted
          if (sessionId && isAuthenticated() && lastAssistantMsg) {
            const partialContent = lastAssistantMsg.content || "";
            addMessage(sessionId, {
              role: "assistant",
              content: partialContent,
              agent_data: { ...lastAssistantMsg.agentData, partial: true },
              timestamp: lastAssistantMsg.timestamp,
            }).catch(err => console.error('Failed to save partial response:', err));
          }
          return prev;
        });
        return;
      }
      // Only show error for non-abort errors
      setAgentError(e.message || "Error");
      const errorTimestamp = Date.now();

      // Update existing assistant message if present, otherwise add new error message
      setConversation(prev => {
        // Find the specific assistant message created for this request
        const existingAssistantIdx = prev.findIndex(msg => msg.id === assistantMessageId);

        if (existingAssistantIdx !== -1) {
          // Update the existing assistant message with error
          const updated = [...prev];
          updated[existingAssistantIdx] = {
            ...updated[existingAssistantIdx],
            content: "", // Empty content - placeholder will be shown based on error flag
            agentData: { error: true, errorMessage: e.message },
          };
          return updated;
        } else {
          // Add new error message (error occurred before assistant message was created)
          const errorMessage: ChatMessage = {
            id: assistantMessageId, // Use the same ID we intended to use
            role: "assistant",
            content: "", // Empty content - placeholder will be shown based on error flag
            agentData: { error: true, errorMessage: e.message },
            timestamp: errorTimestamp,
          };
          return [...prev, errorMessage];
        }
      });

      // Save error message to session
      if (sessionId && isAuthenticated()) {
        addMessage(sessionId, {
          role: "assistant",
          content: "", // Empty content - placeholder will be shown based on error flag
          agent_data: { error: true, errorMessage: e.message },
          timestamp: errorTimestamp,
        }).catch(err => console.error('Failed to save error to session:', err));
      }
    }
    finally {
      setAgentLoading(false);
      abortControllerRef.current = null;
    }
  };

  const agentSuggestions = [
    { text: "Show automation trends", query: "Show automation success/failure trends for the last 30 days" },
    { text: "Analyze incident spikes", query: "Analyze incident spikes in the last 7 days" },
    { text: "Find anomalies", query: "Find anomalies in ticket patterns this week" },
    { text: "Monthly breakdown", query: "Show monthly ticket breakdown by platform" },
  ];
  const ticketSuggestions = [
    { text: "Recent TASK analysis", action: () => setTicketMode("TASK") },
    { text: "RITM correlation", action: () => setTicketMode("RITM") },
  ];
  const csvSuggestions = [
    { text: "Export last 3 years", query: "get me the data for the last 3 years" },
    { text: "All tickets CSV", query: "export all tickets" },
  ];

  const handleHistorySelect = async (item: { id?: string; type: string; query: string; response: string; sessionId?: number }) => {
    setChatLoading(true); // Show loader while switching chats
    try {
      if (item.id) setSelectedHistoryId(item.id);

      // Clear saved Agent state - loading a history item starts a "new context"
      // Agent should be fresh if switching to it after loading another session
      setSavedAgentState(null);

      // If this is a session from backend, load full session with messages
      if (item.sessionId && isAuthenticated()) {
        try {
          const sessionData = await getSession(item.sessionId);
          setCurrentSessionId(sessionData.session.id);

          // Convert backend messages to frontend format
          const messages: ChatMessage[] = sessionData.messages.map((msg: BackendChatMessage) => ({
            id: `msg-${msg.id}`,
            role: msg.role,
            content: msg.content,
            agentData: msg.agent_data,
            timestamp: msg.timestamp,
          }));

          // Check if this is an RCA session by looking at agent_data.type
          const lastAssistantMsg = messages.filter(m => m.role === "assistant").pop();
          const isRcaSession = lastAssistantMsg?.agentData?.type === "rca";

          if (isRcaSession) {
            // Restore as RCA session
            setActiveMode("ticket");
            setConversation([]); // Clear agent conversation
            setCsvResult(null);  // Clear CSV result
            setCsvError(null);   // Clear CSV error

            // Find the user message to extract ticket info
            const userMsg = messages.find(m => m.role === "user");
            const querySafe = userMsg?.content || "";
            const match = querySafe.match(/(TASK|RITM):\s*(.+)/);
            const ticketModeFromHistory = match ? (match[1] === "TASK" ? "TASK" : "RITM") : "TASK";
            const ticketNumber = match ? match[2].trim() : "";

            setTicketMode(ticketModeFromHistory as "TASK" | "RITM");
            if (ticketModeFromHistory === "TASK") {
              setTaskNumber(ticketNumber);
            } else {
              setRitmNumber(ticketNumber);
            }

            // Check if this is an error or success
            if (lastAssistantMsg?.agentData?.error) {
              // Restore RCA error state
              const errorRcaItem: RcaItem = {
                id: `rca-hist-${Date.now()}`,
                state: "error",
                data: null,
                error: lastAssistantMsg.agentData.errorMessage || "An error occurred",
                ticketNumber,
                ticketMode: ticketModeFromHistory as "TASK" | "RITM",
                timestamp: lastAssistantMsg.timestamp,
                showTypewriter: false
              };
              setRcaItems([errorRcaItem]);
            } else {
              // Restore RCA success state
              const rcaData: RcaResult = {
                ticket_data: lastAssistantMsg?.agentData?.ticket_data || {},
                generated_rca: lastAssistantMsg?.content || lastAssistantMsg?.agentData?.generated_rca || ""
              };
              const successRcaItem: RcaItem = {
                id: `rca-hist-${Date.now()}`,
                state: "success",
                data: rcaData,
                error: null,
                ticketNumber,
                ticketMode: ticketModeFromHistory as "TASK" | "RITM",
                timestamp: lastAssistantMsg?.timestamp || Date.now(),
                showTypewriter: false
              };
              setRcaItems([successRcaItem]);
            }
            setShowTypewriter(false);
            return;
          }

          // Check if this is a CSV session by looking at agent_data.type
          const isCsvSession = lastAssistantMsg?.agentData?.type === "csv";

          if (isCsvSession) {
            // Restore as CSV session
            setActiveMode("csv");
            setRcaItems([]); // Clear RCA items
            setCsvError(null); // Clear CSV error
            setCsvResult(null); // Clear CSV result (Fix ghost issue)

            // Restore CSV result from the saved data
            if (lastAssistantMsg?.agentData) {
              if (lastAssistantMsg.agentData.error) {
                setCsvError(lastAssistantMsg.agentData.errorMessage || "An error occurred");
              } else {
                // Get the user query from the messages
                const userMsg = messages.find(m => m.role === "user");
                setCsvResult({
                  sql: lastAssistantMsg.agentData.sql || "",
                  row_count: lastAssistantMsg.agentData.row_count || 0,
                  filename: lastAssistantMsg.agentData.filename || "",
                  csv_content: lastAssistantMsg.agentData.csv_content,
                  query: userMsg?.content || "",
                  sessionId: item.sessionId
                });
              }
            }
            // Populate conversation to trigger Chat View (bottom input bar) instead of Start View
            // FIXED: Do not populate conversation for CSV mode to maintain isolation (Standalone System)
            setConversation([]);
            setShowTypewriter(false);
            return;
          }

          // Handle as agent conversation
          setConversation(messages);

          // Set active mode and restore state from last message
          setActiveMode("agent");
          setRcaItems([]); // Clear RCA items
          setCsvResult(null); // Clear CSV result
          setCsvError(null); // Clear CSV error
          const lastMessage = messages[messages.length - 1];
          if (lastMessage?.role === "assistant") {
            setAgentResult(lastMessage.content);
            setAgentData(lastMessage.agentData || null);
            if (lastMessage.agentData?.needs_visualization) {
              setRightPanelOpen(true);
            }
          }
          setShowTypewriter(false);
          return;
        } catch (error) {
          console.error("Failed to load session:", error);
          toast.error("Failed to load session");
          // Fall through to legacy handling
        }
      }

      if (item.type === "rca") {
        setActiveMode("ticket");
        const querySafe = item.query || "";
        const match = querySafe.match(/(TASK|RITM):\s*(.+)/);
        const ticketMode = match ? (match[1] === "TASK" ? "TASK" : "RITM") : "TASK";
        const ticketNumber = match ? match[2] : "";
        if (match) {
          setTicketMode(ticketMode);
          if (ticketMode === "TASK") {
            setTaskNumber(ticketNumber);
          } else {
            setRitmNumber(ticketNumber);
          }
        }

        // Create RCA item from history
        let rcaData: RcaResult;
        try {
          const responseSafe = item.response || "{}";
          const p = JSON.parse(responseSafe);
          rcaData = p.task_number || p.ritm_number
            ? { ticket_data: p, generated_rca: "" }
            : { ticket_data: {}, generated_rca: responseSafe };
        } catch {
          rcaData = { ticket_data: {}, generated_rca: item.response || "" };
        }

        const historyRcaItem: RcaItem = {
          id: `rca-hist-${Date.now()}`,
          state: "success",
          data: rcaData,
          error: null,
          ticketNumber,
          ticketMode,
          timestamp: Date.now(),
          showTypewriter: false
        };

        setRcaItems([historyRcaItem]);
      } else {
        setActiveMode("agent");
        setAgentQuery(item.query || "");
        setAgentResult(item.response || "");

        // Safely extract agentData
        const d = (item as any).agentData;
        const safeAgentData = d || {
          summary: item.response || "",
          needs_visualization: false
        };

        setAgentData(safeAgentData);

        if (safeAgentData?.needs_visualization) {
          setRightPanelOpen(true);
        }
        setShowTypewriter(false);

        // Populate conversation from history
        const userMsg: ChatMessage = {
          id: `user-hist-${Date.now()}`,
          role: "user",
          content: item.query || "",
          timestamp: Date.now(),
        };
        const assistantMsg: ChatMessage = {
          id: `assistant-hist-${Date.now()}`,
          role: "assistant",
          content: item.response || "",
          agentData: safeAgentData,
          timestamp: Date.now(),
        };
        setConversation([userMsg, assistantMsg]);
      }
    } catch (error) {
      console.error("Error restoring history item:", error);
      toast.error("Failed to restore this conversation history");
    } finally {
      setChatLoading(false); // Hide loader after chat is loaded or error occurs
    }
  };

  const handleNewChat = () => {
    setActiveMode("agent"); setTicketMode("TASK"); setTaskNumber(""); setRitmNumber("");
    setRcaItems([]); setAgentQuery(""); setAgentResult(""); setAgentData(null);
    setAgentError(""); setShowTypewriter(false); setSelectedHistoryId(null); setRightPanelOpen(false);
    setConversation([]); // Clear conversation
    setCurrentSessionId(null); // Reset session ID so new session is created on next query
    // Clear CSV state
    setCsvResult(null); setCsvError(""); setCsvQuery("");
  };

  const submitCsv = async () => {
    const userQuery = csvQuery.trim();
    if (!userQuery) return;

    // Create session immediately (before API call) for instant sidebar update
    let sessionId: number | null = null;
    if (isAuthenticated()) {
      try {
        const session = await createSession(userQuery.substring(0, 100));
        sessionId = session.id;
        setSelectedHistoryId(`session-${sessionId}`); // Highlight the new session in sidebar
        // Refresh history list immediately so session appears in sidebar
        setHistoryRefreshTrigger(prev => prev + 1);
      } catch (error) {
        console.error('Failed to create session:', error);
        // Continue without session saving
      }
    }

    setCsvError("");
    setCsvResult(null);
    setCsvLoading(true);
    setCsvQuery(""); // Clear input immediately

    try {
      const token = getToken();
      const headers: HeadersInit = { "Content-Type": "application/json" };
      if (token) {
        headers["Authorization"] = `Bearer ${token}`;
      }

      const res = await fetch(`${API_BASE}/generate-csv`, {
        method: "POST",
        headers,
        body: JSON.stringify({ query: userQuery }),
      });

      if (!res.ok) {
        if (res.status === 401) {
          apiLogout();
          navigate('/');
          throw new Error("Authentication expired. Please login again.");
        }
        const errorText = await res.text();
        throw new Error(errorText || `HTTP ${res.status}`);
      }

      const data = await res.json();

      if (!data.success) {
        throw new Error(data.message || "CSV generation failed");
      }

      if (!data.csv_data) {
        throw new Error("No CSV data returned");
      }

      // Download gzip-compressed CSV file
      exportGzipToCSV(data.csv_data, data.filename || "export.csv.gz");

      setCsvResult({
        sql: data.sql,
        row_count: data.row_count,
        filename: data.filename || "export.csv.gz",
        csv_content: data.csv_data,
        query: userQuery,
        sessionId: sessionId || undefined
      });

      // Save CSV query to backend session (session already created above)
      if (sessionId && isAuthenticated()) {
        try {
          // Save user query as user message
          await addMessage(sessionId, {
            role: "user",
            content: userQuery,
            timestamp: Date.now(),
          });

          // Save CSV result as assistant message
          await addMessage(sessionId, {
            role: "assistant",
            content: `CSV exported: ${data.row_count} rows. File: ${data.filename}`,
            agent_data: {
              type: "csv",
              sql: data.sql,
              row_count: data.row_count,
              filename: data.filename,
              csv_content: data.csv_data
            },
            timestamp: Date.now(),
          });
        } catch (error) {
          console.error('Failed to save CSV query to session:', error);
        }
      }

      toast.success(`CSV exported successfully! ${data.row_count} rows`);
    } catch (e: any) {
      const errorMsg = e.message || "Failed to generate CSV";
      setCsvError(errorMsg);
      toast.error(errorMsg);
      console.error("[CSV GENERATOR ERROR]", e);

      // Save error to session so it persists
      if (sessionId && isAuthenticated()) {
        try {
          // Save user query first
          await addMessage(sessionId, {
            role: "user",
            content: userQuery,
            timestamp: Date.now(),
          });

          // Save error message
          await addMessage(sessionId, {
            role: "assistant",
            content: "",
            agent_data: {
              type: "csv",
              error: true,
              errorMessage: errorMsg
            },
            timestamp: Date.now(),
          });
        } catch (err) {
          console.error('Failed to save CSV error to session:', err);
        }
      }
    } finally {
      setCsvLoading(false);
    }
  };

  const handleSubmit = () => {
    // Visual acknowledgment on submit
    setSubmitAcknowledged(true);
    setTimeout(() => setSubmitAcknowledged(false), 300);

    // Always force scroll to bottom when user sends a message
    forceScrollToBottom();
    // Reset auto-scroll state to enable scrolling during streaming
    setShouldAutoScroll(true);

    if (activeMode === "agent" && agentQuery.trim()) submitAgent();
    else if (activeMode === "ticket" && (ticketMode === "TASK" ? taskNumber : ritmNumber).trim()) submitRca();
    else if (activeMode === "csv" && csvQuery.trim()) submitCsv();
  };

  const isLoading = rcaLoading || agentLoading || csvLoading;

  // Insight generation functions
  const generateInsights = useCallback((chartData: any, chartType: string | undefined, rows: any[] | undefined, hovered: any, selected: any, context: string) => {
    const insights: string[] = [];

    if (!chartData || !chartData.series) return insights;

    try {
      const series = chartData.series || [];
      const isPieChart = chartType === "pie";
      const isBarChart = chartType === "bar" || chartType === "column";
      const isLineChart = chartType === "line";

      // Generate insights based on chart type and data
      if (isPieChart && series[0]?.data) {
        const pieData = series[0].data;
        const total = pieData.reduce((sum: number, item: any) => sum + (item.value || 0), 0);
        const sorted = [...pieData].sort((a: any, b: any) => (b.value || 0) - (a.value || 0));

        if (sorted.length > 0) {
          const largest = sorted[0];
          const percentage = total > 0 ? Math.round((largest.value / total) * 100) : 0;
          insights.push(`${largest.name} represents ${percentage}% of the total, making it the dominant category.`);

          if (sorted.length > 1 && sorted[1].value > 0) {
            const secondPercentage = Math.round((sorted[1].value / total) * 100);
            insights.push(`The second largest category, ${sorted[1].name}, accounts for ${secondPercentage}%.`);
          }
        }

        // Hover-specific insights
        if (hovered && hovered.data) {
          const hoveredValue = hovered.data.value || 0;
          const hoveredPct = total > 0 ? Math.round((hoveredValue / total) * 100) : 0;
          insights.unshift(`Focusing on ${hovered.data.name}: ${hoveredValue.toLocaleString()} units (${hoveredPct}% of total).`);
        }
      } else if (isBarChart || isLineChart) {
        // Analyze trends for bar/line charts
        series.forEach((s: any, idx: number) => {
          if (s.data && Array.isArray(s.data)) {
            const values = s.data.map((d: any) => typeof d === 'number' ? d : (d.value || 0));
            if (values.length > 1) {
              const first = values[0];
              const last = values[values.length - 1];
              const change = last - first;
              const changePct = first !== 0 ? Math.round((change / first) * 100) : 0;

              if (Math.abs(changePct) > 5) {
                const direction = change > 0 ? "increased" : "decreased";
                insights.push(`${s.name || `Series ${idx + 1}`} ${direction} by ${Math.abs(changePct)}% from start to end.`);
              }

              // Find peak and trough
              const maxIdx = values.indexOf(Math.max(...values));
              const minIdx = values.indexOf(Math.min(...values));
              if (maxIdx !== minIdx) {
                const xAxisData = chartData.xAxis?.[0]?.data || chartData.xAxis?.data || [];
                if (xAxisData[maxIdx] && xAxisData[minIdx]) {
                  insights.push(`Peak value occurred at ${xAxisData[maxIdx]}, while the lowest was at ${xAxisData[minIdx]}.`);
                }
              }
            }
          }
        });

        // Hover-specific insights
        if (hovered && hovered.seriesName && hovered.data) {
          const seriesName = hovered.seriesName;
          const value = typeof hovered.data === 'number' ? hovered.data : (hovered.data.value || hovered.data);
          const xValue = hovered.name || hovered.axisValue || '';
          insights.unshift(`At ${xValue}, ${seriesName} shows ${value.toLocaleString()}.`);
        }
      }

      // Anomaly detection
      if (rows && rows.length > 2) {
        series.forEach((s: any) => {
          if (s.data && Array.isArray(s.data)) {
            const values = s.data.map((d: any) => typeof d === 'number' ? d : (d.value || 0)).filter((v: number) => !isNaN(v));
            if (values.length > 2) {
              const mean = values.reduce((a: number, b: number) => a + b, 0) / values.length;
              const variance = values.reduce((sum: number, v: number) => sum + Math.pow(v - mean, 2), 0) / values.length;
              const stdDev = Math.sqrt(variance);

              const anomalies = values.filter((v: number) => Math.abs(v - mean) > 2 * stdDev);
              if (anomalies.length > 0) {
                insights.push(`Detected ${anomalies.length} potential outlier${anomalies.length > 1 ? 's' : ''} in ${s.name || 'the data'}.`);
              }
            }
          }
        });
      }

      // Context-specific insights
      if (context === "comparison" && series.length > 1) {
        insights.push(`Comparing ${series.length} series: ${series.map((s: any) => s.name).join(", ")}.`);
      } else if (context === "anomaly") {
        insights.push("Anomaly analysis mode: focusing on unusual patterns and outliers.");
      } else if (context === "trend") {
        insights.push("Trend analysis: examining directional changes over time.");
      }

    } catch (error) {
      console.error("Error generating insights:", error);
    }

    return insights.length > 0 ? insights : ["Analyzing chart data..."];
  }, []);

  // Get current insights based on state
  const currentInsights = useMemo(() => {
    const chartData = activeVizData || agentData;
    if (!chartData?.chart_spec) return [];
    return generateInsights(
      chartData.chart_spec,
      chartData.chart_type,
      chartData.rows,
      hoveredElement,
      null, // No selected element
      insightContext
    );
  }, [activeVizData?.chart_spec, activeVizData?.chart_type, activeVizData?.rows, agentData?.chart_spec, agentData?.chart_type, agentData?.rows, hoveredElement, insightContext, generateInsights]);

  // Build chart option with theme overrides
  const chartOption = useMemo(() => {
    const chartData = activeVizData || agentData;
    if (!chartData?.chart_spec || !mounted) {
      console.log('[Chart Option] Returning null - chart_spec:', !!chartData?.chart_spec, 'mounted:', mounted);
      return null;
    }

    try {
      const spec = chartData.chart_spec;
      console.log('[Chart Option] Building chart option from spec:', Object.keys(spec));
      // Use standardized opacity tokens
      const textColor = isDark ? `rgba(255,255,255,${opacityEmphasis})` : "#3D3929";
      const mutedColor = isDark ? `rgba(255,255,255,${opacityDefault})` : "#5C5745";
      const borderColorChart = isDark ? `rgba(255,255,255,${opacityMedium})` : "#D4CFC4";
      const gridColor = isDark ? `rgba(255,255,255,${opacitySoft})` : `rgba(0,0,0,${opacitySoft})`;

      const option: any = {
        ...spec,
        textStyle: {
          ...(spec.textStyle || {}),
          color: textColor,
        },
      };

      // Handle title
      if (spec.title) {
        option.title = {
          ...spec.title,
          textStyle: {
            ...(spec.title.textStyle || {}),
            color: isDark ? "rgba(255,255,255,0.8)" : "#3D3929",
          },
        };
      }

      // Handle xAxis
      if (spec.xAxis) {
        if (Array.isArray(spec.xAxis)) {
          option.xAxis = spec.xAxis.map((axis: any) => ({
            ...axis,
            axisLabel: {
              ...(axis.axisLabel || {}),
              color: mutedColor,
              // Add responsive behavior for narrow sidebar
              rotate: axis.axisLabel?.rotate ?? 45, // Rotate labels at 45 degrees by default
              fontSize: 10, // Smaller font size for better fit
              interval: 'auto', // Auto-skip labels if needed
              overflow: 'truncate', // Truncate long labels
              width: 60, // Max label width before truncation
            },
            axisLine: {
              ...(axis.axisLine || {}),
              lineStyle: {
                ...(axis.axisLine?.lineStyle || {}),
                color: borderColorChart,
              },
            },
          }));
        } else {
          option.xAxis = {
            ...spec.xAxis,
            axisLabel: {
              ...(spec.xAxis.axisLabel || {}),
              color: mutedColor,
              // Add responsive behavior for narrow sidebar
              rotate: spec.xAxis.axisLabel?.rotate ?? 45, // Rotate labels at 45 degrees by default
              fontSize: 10, // Smaller font size for better fit
              interval: 'auto', // Auto-skip labels if needed
              overflow: 'truncate', // Truncate long labels
              width: 60, // Max label width before truncation
            },
            axisLine: {
              ...(spec.xAxis.axisLine || {}),
              lineStyle: {
                ...(spec.xAxis.axisLine?.lineStyle || {}),
                color: borderColorChart,
              },
            },
          };
        }
      }

      // Handle yAxis
      if (spec.yAxis) {
        if (Array.isArray(spec.yAxis)) {
          option.yAxis = spec.yAxis.map((axis: any) => ({
            ...axis,
            axisLabel: {
              ...(axis.axisLabel || {}),
              color: mutedColor,
            },
            axisLine: {
              ...(axis.axisLine || {}),
              lineStyle: {
                ...(axis.axisLine?.lineStyle || {}),
                color: borderColorChart,
              },
            },
            splitLine: {
              ...(axis.splitLine || {}),
              lineStyle: {
                ...(axis.splitLine?.lineStyle || {}),
                color: gridColor,
              },
            },
          }));
        } else {
          option.yAxis = {
            ...spec.yAxis,
            axisLabel: {
              ...(spec.yAxis.axisLabel || {}),
              color: mutedColor,
            },
            axisLine: {
              ...(spec.yAxis.axisLine || {}),
              lineStyle: {
                ...(spec.yAxis.axisLine?.lineStyle || {}),
                color: borderColorChart,
              },
            },
            splitLine: {
              ...(spec.yAxis.splitLine || {}),
              lineStyle: {
                ...(spec.yAxis.splitLine?.lineStyle || {}),
                color: gridColor,
              },
            },
          };
        }
      }

      // Handle legend - hide built-in legend for pie charts (we render custom legend outside)
      const chartDataForType = activeVizData || agentData;
      const isPieChart = chartDataForType?.chart_type === "pie";

      if (isPieChart) {
        // Hide built-in legend - we render custom legend outside chart
        option.legend = {
          show: false
        };
      } else if (spec.legend) {
        // For other chart types, use spec legend with styling
        option.legend = {
          ...spec.legend,
          show: spec.legend.show !== false,
          textStyle: {
            ...(spec.legend.textStyle || {}),
            color: textColor,
            fontSize: spec.legend.textStyle?.fontSize || 12, // Use --font-size-sm token
            fontFamily: spec.legend.textStyle?.fontFamily || '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',
          },
        };
      }

      // Handle series - apply hidden/isolated states
      if (spec.series && Array.isArray(spec.series)) {
        option.series = spec.series.map((s: any) => {
          const seriesName = s.name || '';
          const isHidden = hiddenSeries.has(seriesName);
          const isIsolated = isolatedSeries !== null && isolatedSeries !== seriesName;

          // Apply visibility based on hidden/isolated state
          const shouldShow = !isHidden && !isIsolated;

          if (s.type === "pie") {
            // For pie charts, filter the data array to exclude hidden items
            let filteredData = s.data || [];
            if (Array.isArray(filteredData)) {
              if (isolatedSeries) {
                // Isolate mode: only show the isolated series
                filteredData = filteredData.filter((item: any) => {
                  const itemName = item.name || item.value?.name || '';
                  return itemName === isolatedSeries;
                });
              } else if (hiddenSeries.size > 0) {
                // Hide mode: filter out hidden items
                filteredData = filteredData.filter((item: any) => {
                  const itemName = item.name || item.value?.name || '';
                  return !hiddenSeries.has(itemName);
                });
              }
            }

            // Pie charts: disable all labels, use legend only (Copilot style)
            return {
              ...s,
              data: filteredData, // Use filtered data
              label: {
                show: false,  // Disable all slice labels completely
              },
              labelLine: {
                show: false,  // Disable label lines
              },
              center: ['50%', '60%'],  // Center vertically below legend
              radius: s.radius || ['45%', '75%'],  // Slightly larger donut for better visibility
              avoidLabelOverlap: false,  // Not needed since labels are disabled
              emphasis: {
                scale: true,
                scaleSize: 8,
                itemStyle: {
                  shadowBlur: 10,
                  shadowOffsetX: 0,
                  shadowColor: isDark ? 'rgba(0, 0, 0, 0.5)' : 'rgba(0, 0, 0, 0.15)'
                }
              }
            };
          }

          // For other chart types, apply visibility via opacity
          return {
            ...s,
            ...(shouldShow ? {} : {
              itemStyle: { opacity: 0 },
              lineStyle: { opacity: 0 },
              areaStyle: { opacity: 0 }
            })
          };
        });
      }

      console.log('[Chart Option] Built option successfully:', {
        hasTitle: !!option.title,
        hasXAxis: !!option.xAxis,
        hasYAxis: !!option.yAxis,
        hasSeries: !!option.series,
        seriesCount: option.series?.length || 0,
        hiddenSeries: Array.from(hiddenSeries),
        isolatedSeries: isolatedSeries
      });
      return option;
    } catch (error) {
      console.error("Error building chart option:", error);
      return null;
    }
  }, [activeVizData?.chart_spec, activeVizData?.chart_type, agentData?.chart_spec, agentData?.chart_type, isDark, mounted, hiddenSeries, isolatedSeries]);

  const hasViz = activeVizData?.needs_visualization && (activeVizData.chart_spec || chartOption);

  // Debug hasViz
  useEffect(() => {
    const chartData = activeVizData || agentData;
    if (chartData?.needs_visualization) {
      console.log('[hasViz Debug] needs_visualization:', chartData.needs_visualization);
      console.log('[hasViz Debug] has chart_spec:', !!chartData.chart_spec);
      console.log('[hasViz Debug] has chartOption:', !!chartOption);
      console.log('[hasViz Debug] hasViz result:', hasViz);
      console.log('[hasViz Debug] rightPanelOpen:', rightPanelOpen);
    }
  }, [activeVizData?.needs_visualization, activeVizData?.chart_spec, agentData?.needs_visualization, agentData?.chart_spec, chartOption, hasViz, rightPanelOpen]);

  // Premium animation config - Microsoft Copilot style
  const animationConfig = {
    duration: 0.24, // 240ms
    ease: [0.22, 1, 0.36, 1] as [number, number, number, number], // cubic-bezier(0.22, 1, 0.36, 1)
  };

  if (!mounted) return null;

  return (
    <div className="h-screen w-full overflow-hidden flex" style={{ background: bgMain }}>
      {/* Fixed Sidebar - Production-Grade Copilot Style (Perfect Icon Alignment) */}
      <aside
        className="shrink-0 flex flex-col h-full overflow-hidden"
        style={{
          width: sidebarOpen ? 280 : 64,
          background: isDark ? "#1a1a18" : "#f5f2ed",
          transition: 'width 200ms ease-out',
          alignItems: 'center',
          justifyContent: 'space-between', // Distribute 3 zones vertically
          borderRight: isDark ? "1px solid rgba(255,255,255,0.08)" : "1px solid rgba(61,57,41,0.12)",
        }}
      >
        {/* ============================================ */}
        {/* ZONE A: TOP - App Identity + Primary Actions */}
        {/* ============================================ */}
        <div
          className="shrink-0 flex flex-col items-center"
          style={{
            width: '100%',
            paddingTop: '16px',
            paddingBottom: '12px',
            paddingLeft: sidebarOpen ? '12px' : '0',
            paddingRight: sidebarOpen ? '12px' : '0',
            gap: sidebarOpen ? '0' : '8px',
          }}
        >
          {sidebarOpen ? (
            <>
              {/* App Identity with Collapser Button */}
              <div className="w-full flex items-center justify-between mb-3" style={{ paddingLeft: '4px', paddingRight: '4px' }}>
                <div className="flex items-center gap-2.5">
                  <img src="/logo.png" alt="Chronicle" className="h-5 w-5" style={{ flexShrink: 0 }} />
                  <span className="text-sm font-semibold" style={{ color: textPrimary }}>
                    Chronicle
                  </span>
                </div>
                {/* Sidebar Collapser Button - Right aligned */}
                <button
                  onClick={() => setSidebarOpen(false)}
                  className="flex items-center justify-center rounded-lg transition-all duration-150 ease-out cursor-pointer"
                  style={{
                    width: '32px',
                    height: '32px',
                    minWidth: '32px',
                    minHeight: '32px',
                    color: textMuted,
                    padding: 0,
                    margin: 0,
                    background: 'transparent',
                  }}
                  onMouseEnter={(e) => {
                    e.currentTarget.style.background = isDark ? `rgba(255,255,255,0.08)` : `rgba(61,57,41,0.08)`;
                    e.currentTarget.style.transform = "translateY(-1px)";
                  }}
                  onMouseLeave={(e) => {
                    e.currentTarget.style.background = "transparent";
                    e.currentTarget.style.transform = "translateY(0)";
                  }}
                  aria-label="Collapse sidebar"
                  title="Collapse sidebar"
                >
                  <Menu className="h-4 w-4" />
                </button>
              </div>
              {/* New Chat Button - Primary Action */}
              <button
                onClick={handleNewChat}
                className="w-full flex items-center gap-2.5 px-3 py-2.5 rounded-lg transition-all duration-150 ease-out"
                style={{
                  background: isDark ? `rgba(227,93,36,0.12)` : `rgba(227,93,36,0.1)`,
                  color: "#E35D24",
                  minHeight: '40px',
                  padding: '8px 12px',
                }}
                onMouseEnter={(e) => {
                  e.currentTarget.style.background = isDark ? `rgba(227,93,36,0.16)` : `rgba(227,93,36,0.14)`;
                  e.currentTarget.style.transform = "translateY(-1px)";
                }}
                onMouseLeave={(e) => {
                  e.currentTarget.style.background = isDark ? `rgba(227,93,36,0.12)` : `rgba(227,93,36,0.1)`;
                  e.currentTarget.style.transform = "translateY(0)";
                }}
              >
                <MessageSquare className="h-4 w-4" style={{ flexShrink: 0 }} />
                <span className="text-sm font-medium">New chat</span>
              </button>
            </>
          ) : (
            <>
              {/* Logo Icon - Collapsed */}
              <button
                onClick={handleNewChat}
                className="flex items-center justify-center rounded-lg transition-all duration-150 ease-out cursor-pointer"
                style={{
                  width: '40px',
                  height: '40px',
                  minWidth: '40px',
                  minHeight: '40px',
                  color: textMuted,
                  padding: 0,
                  margin: 0,
                  background: 'transparent',
                }}
                onMouseEnter={(e) => {
                  e.currentTarget.style.background = isDark ? `rgba(255,255,255,0.08)` : `rgba(61,57,41,0.08)`;
                  e.currentTarget.style.transform = "translateY(-1px)";
                }}
                onMouseLeave={(e) => {
                  e.currentTarget.style.background = "transparent";
                  e.currentTarget.style.transform = "translateY(0)";
                }}
                aria-label="Chronicle"
                title="Chronicle"
              >
                <img src="/logo.png" alt="Chronicle" className="h-5 w-5" />
              </button>
              {/* Sidebar Expander Button - Collapsed */}
              <button
                onClick={() => setSidebarOpen(true)}
                className="flex items-center justify-center rounded-lg transition-all duration-150 ease-out cursor-pointer"
                style={{
                  width: '40px',
                  height: '40px',
                  minWidth: '40px',
                  minHeight: '40px',
                  color: textMuted,
                  padding: 0,
                  margin: 0,
                  background: 'transparent',
                }}
                onMouseEnter={(e) => {
                  e.currentTarget.style.background = isDark ? `rgba(255,255,255,0.08)` : `rgba(61,57,41,0.08)`;
                  e.currentTarget.style.transform = "translateY(-1px)";
                }}
                onMouseLeave={(e) => {
                  e.currentTarget.style.background = "transparent";
                  e.currentTarget.style.transform = "translateY(0)";
                }}
                aria-label="Expand sidebar"
                title="Expand sidebar"
              >
                <Menu className="h-5 w-5" />
              </button>
              {/* New Chat Button Icon - Collapsed */}
              <button
                onClick={handleNewChat}
                className="flex items-center justify-center rounded-lg transition-all duration-150 ease-out cursor-pointer"
                style={{
                  width: '40px',
                  height: '40px',
                  minWidth: '40px',
                  minHeight: '40px',
                  color: "#E35D24",
                  padding: 0,
                  margin: 0,
                  background: isDark ? `rgba(227,93,36,0.12)` : `rgba(227,93,36,0.1)`,
                }}
                onMouseEnter={(e) => {
                  e.currentTarget.style.background = isDark ? `rgba(227,93,36,0.16)` : `rgba(227,93,36,0.14)`;
                  e.currentTarget.style.transform = "translateY(-1px)";
                }}
                onMouseLeave={(e) => {
                  e.currentTarget.style.background = isDark ? `rgba(227,93,36,0.12)` : `rgba(227,93,36,0.1)`;
                  e.currentTarget.style.transform = "translateY(0)";
                }}
                aria-label="New chat"
                title="New chat"
              >
                <MessageSquare className="h-5 w-5" />
              </button>
            </>
          )}
        </div>

        {/* ============================================ */}
        {/* ZONE B: MIDDLE - Navigation + Conversations */}
        {/* ============================================ */}
        <div
          className="flex-1 flex flex-col overflow-hidden"
          style={{
            minHeight: 0,
            width: '100%',
            alignItems: 'center',
            justifyContent: 'flex-start',
          }}
        >
          {/* Navigation Icons - Removed Chat button */}
          <nav
            className="shrink-0 flex flex-col items-center"
            style={{
              width: '100%',
              gap: '4px',
              paddingLeft: sidebarOpen ? '8px' : '0',
              paddingRight: sidebarOpen ? '8px' : '0',
            }}
          >
            {/* Chat button removed */}
          </nav>

          {/* Conversations Section - Only when expanded */}
          {sidebarOpen && (
            <motion.div
              initial={{ opacity: 0 }}
              animate={{ opacity: 1 }}
              exit={{ opacity: 0 }}
              transition={{ duration: 0.15 }}
              className="flex-1 overflow-y-auto w-full"
              style={{ minHeight: 0, marginTop: '16px' }}
            >
              {/* Conversations Header */}
              <div className="px-3 mb-2">
                <h3 className="text-xs font-bold uppercase tracking-wider mb-3" style={{
                  color: isDark ? "rgba(255,255,255,0.7)" : "rgba(61,57,41,0.8)"
                }}>
                  Conversations
                </h3>
              </div>
              {/* Conversations List */}
              <div style={{ paddingLeft: '8px', paddingRight: '8px' }}>
                <ChatHistory
                  onSelectHistory={(item) => {
                    handleHistorySelect(item);
                  }}
                  onNewChat={handleNewChat}
                  selectedItemId={selectedHistoryId}
                  isOpen={true}
                  onClose={() => { }}
                  embedded={true}
                  refreshTrigger={historyRefreshTrigger}
                />
              </div>
            </motion.div>
          )}
        </div>

        {/* ============================================ */}
        {/* ZONE C: BOTTOM - Utilities */}
        {/* ============================================ */}
        <div
          className="shrink-0 flex flex-col items-center"
          style={{
            width: '100%',
            padding: '8px',
            gap: '4px',
          }}
        >
          <IconContainer
            icon={LogOut}
            label="Logout"
            tooltip="Logout"
            isActive={false}
            isCollapsed={!sidebarOpen}
            size="small"
            onClick={() => {
              apiLogout();
              navigate('/');
            }}
          />
        </div>
      </aside>

      {/* Main Chat Area - Copilot Style */}
      <div className="flex-1 flex flex-col h-full overflow-hidden" style={{ minWidth: 0 }}>
        {/* Header */}
        <header className="flex items-center justify-end px-6 h-14 shrink-0">
          {/* Insights, Theme Toggle, and Profile - Right aligned */}
          <div className="flex items-center gap-2">
            {activeMode === "agent" && (
              <button
                onClick={() => setRightPanelOpen(!rightPanelOpen)}
                className="p-2 rounded-lg transition-all"
                style={{
                  background: isDark ? `rgba(255,255,255,${opacitySubtle})` : `rgba(61,57,41,${opacitySubtle})`,
                  border: `1px solid ${borderColor}`,
                  color: textMuted
                }}
                title={rightPanelOpen ? "Hide Insights" : "Show Insights"}
              >
                {rightPanelOpen ? <PanelRightClose className="h-4 w-4" /> : <PanelRight className="h-4 w-4" />}
              </button>
            )}
            <ThemeToggle />
            <DropdownMenu>
              <DropdownMenuTrigger asChild>
                <button
                  className="p-2 rounded-lg transition-all hover:bg-opacity-80"
                  style={{
                    background: isDark ? `rgba(255,255,255,${opacitySubtle})` : `rgba(61,57,41,${opacitySubtle})`,
                    border: `1px solid ${borderColor}`,
                    color: textMuted
                  }}
                  title="Profile"
                >
                  <User className="h-4 w-4" />
                </button>
              </DropdownMenuTrigger>
              <DropdownMenuContent
                align="end"
                className="w-[280px]"
                style={{
                  background: isDark ? '#1F1F1F' : '#FFFFFF',
                  border: `1px solid ${isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)'}`,
                  borderRadius: '12px',
                  padding: '12px',
                  boxShadow: isDark
                    ? '0 8px 32px rgba(0,0,0,0.4)'
                    : '0 8px 32px rgba(0,0,0,0.12)'
                }}
              >
                <DropdownMenuLabel className="px-0 py-0">
                  <div className="flex items-center gap-3">
                    <div
                      className="flex items-center justify-center rounded-full shrink-0"
                      style={{
                        width: '48px',
                        height: '48px',
                        background: isDark
                          ? 'rgba(227,93,36,0.2)'
                          : 'rgba(227,93,36,0.1)',
                      }}
                    >
                      <User
                        className="h-6 w-6"
                        style={{ color: '#E35D24' }}
                      />
                    </div>
                    <div className="flex flex-col min-w-0 flex-1 gap-0.5">
                      <span
                        className="break-words"
                        style={{
                          color: isDark ? `rgba(255,255,255,0.95)` : `rgba(61,57,41,0.95)`,
                          fontSize: '15px',
                          fontWeight: 600,
                          lineHeight: '1.4',
                          wordBreak: 'break-word'
                        }}
                      >
                        {getUser()?.full_name || getUser()?.username || 'User'}
                      </span>
                      {getUser()?.email && (
                        <span
                          className="break-all"
                          style={{
                            color: isDark ? `rgba(255,255,255,0.5)` : `rgba(61,57,41,0.6)`,
                            fontSize: '13px',
                            lineHeight: '1.4',
                            wordBreak: 'break-all'
                          }}
                        >
                          {getUser()?.email}
                        </span>
                      )}
                    </div>
                  </div>
                </DropdownMenuLabel>
                <DropdownMenuSeparator
                  style={{
                    margin: '10px 0',
                    borderColor: isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)'
                  }}
                />
                <DropdownMenuItem
                  onClick={() => {
                    apiLogout();
                    navigate('/');
                  }}
                  className="cursor-pointer px-3 py-2.5 rounded-lg"
                  style={{
                    color: isDark ? `rgba(255,255,255,0.9)` : `rgba(61,57,41,0.9)`,
                    transition: 'all 0.15s ease'
                  }}
                  onMouseEnter={(e) => {
                    e.currentTarget.style.background = isDark
                      ? 'rgba(255,255,255,0.08)'
                      : 'rgba(0,0,0,0.04)';
                  }}
                  onMouseLeave={(e) => {
                    e.currentTarget.style.background = 'transparent';
                  }}
                >
                  <LogOut className="mr-3 h-4 w-4" style={{ color: '#E35D24' }} />
                  <span style={{ fontSize: '14px', fontWeight: 500 }}>Logout</span>
                </DropdownMenuItem>
              </DropdownMenuContent>
            </DropdownMenu>
          </div>
        </header>

        {/* Canvas - Centered Chat Column */}
        <div className="flex-1 overflow-y-auto relative" ref={chatContainerRef} style={{ paddingBottom: inputExpanded ? '200px' : '0' }}>

          <div className={`w-full flex justify-center ${conversation.length === 0 && rcaItems.length === 0 && !agentLoading && !rcaLoading && !csvResult ? 'h-full items-center' : 'py-12'}`}>
            <div className="w-full max-w-[780px] px-8">
              {/* Welcome State - Copilot Style */}
              {/* Show chat loading indicator when switching between chats */}
              {chatLoading ? (
                <motion.div
                  initial={{ opacity: 0, y: 16 }}
                  animate={{ opacity: 1, y: 0 }}
                  className="w-full flex flex-col items-center justify-center gap-4"
                  style={{ minHeight: "400px" }}
                >
                  <motion.div
                    animate={{ rotate: 360 }}
                    transition={{ duration: 1, repeat: Infinity, ease: "linear" }}
                  >
                    <Loader2 className="h-8 w-8" style={{ color: "#E35D24" }} />
                  </motion.div>
                  <p className="text-sm" style={{ color: textMuted }}>Loading conversation...</p>
                </motion.div>
              ) : conversation.length === 0 && rcaItems.length === 0 && !agentLoading && !rcaLoading && !csvResult && (
                <motion.div
                  initial={{ opacity: 0, y: 16 }}
                  animate={{ opacity: 1, y: 0 }}
                  className="w-full flex flex-col items-center gap-8"
                >
                  {/* Hero Greeting - Copilot Style */}
                  <motion.div
                    initial={{ opacity: 0, y: 8 }}
                    animate={{ opacity: 1, y: 0 }}
                    transition={{ delay: 0.1 }}
                    className="text-center"
                  >
                    <h1
                      className="text-5xl font-normal mb-2 leading-tight"
                      style={{
                        color: textPrimary,
                        letterSpacing: "-0.5px",
                        fontWeight: 400,
                        lineHeight: "1.2"
                      }}
                    >
                      Hi, what should we dive into today?
                    </h1>
                  </motion.div>

                  {/* Suggestion Chips - Copilot Style */}
                  <motion.div
                    initial={{ opacity: 0, y: 8 }}
                    animate={{ opacity: 1, y: 0 }}
                    transition={{ delay: 0.2 }}
                    className="w-full grid grid-cols-2 gap-3 max-w-2xl"
                  >
                    {(() => {
                      const suggestions = activeMode === "agent" ? agentSuggestions :
                        activeMode === "csv" ? csvSuggestions :
                          ticketSuggestions;
                      return suggestions;
                    })().map((chip, idx) => (
                      <motion.button
                        key={idx}
                        initial={{ opacity: 0, y: 6 }}
                        animate={{ opacity: 1, y: 0 }}
                        transition={{ delay: 0.25 + idx * 0.03 }}
                        onClick={() => {
                          if ("query" in chip) {
                            if (activeMode === "csv") {
                              setCsvQuery(chip.query);
                            } else {
                              setAgentQuery(chip.query);
                            }
                            textareaRef.current?.focus();
                            setChatFocused(true);
                          } else if ("action" in chip) {
                            chip.action();
                          }
                        }}
                        className="px-5 py-3 rounded-full text-sm font-medium transition-all text-left"
                        style={{
                          background: isDark ? "rgba(255,255,255,0.04)" : "rgba(61,57,41,0.04)",
                          border: "none",
                          color: textPrimary,
                          boxShadow: "none"
                        }}
                        onMouseEnter={(e) => {
                          e.currentTarget.style.background = isDark ? "rgba(255,255,255,0.06)" : "rgba(61,57,41,0.06)";
                          e.currentTarget.style.boxShadow = "0 2px 8px rgba(0,0,0,0.06)";
                        }}
                        onMouseLeave={(e) => {
                          e.currentTarget.style.background = isDark ? "rgba(255,255,255,0.04)" : "rgba(61,57,41,0.04)";
                          e.currentTarget.style.boxShadow = "none";
                        }}
                        onMouseDown={(e) => {
                          e.currentTarget.style.boxShadow = "none";
                        }}
                        onMouseUp={(e) => {
                          e.currentTarget.style.boxShadow = "0 2px 8px rgba(0,0,0,0.06)";
                        }}
                      >
                        {chip.text}
                      </motion.button>
                    ))}
                  </motion.div>

                  {/* Chat Input Bar - Centered when empty, Copilot Style */}
                  <motion.div
                    initial={{ opacity: 0, y: 8 }}
                    animate={{ opacity: 1, y: 0 }}
                    transition={{ delay: 0.3 }}
                    className="w-full max-w-2xl mx-auto"
                  >
                    <motion.div
                      className="rounded-2xl relative overflow-hidden"
                      animate={{
                        scale: chatFocused ? 1.005 : 1,
                      }}
                      transition={animationConfig}
                      style={{
                        // Soft gradient background
                        background: chatFocused
                          ? (isDark
                            ? "linear-gradient(180deg, rgba(255,255,255,0.08) 0%, rgba(255,255,255,0.04) 100%)"
                            : "linear-gradient(180deg, rgba(255,255,255,0.95) 0%, rgba(250,247,242,0.98) 100%)")
                          : (isDark
                            ? "linear-gradient(180deg, rgba(255,255,255,0.06) 0%, rgba(255,255,255,0.03) 100%)"
                            : "linear-gradient(180deg, rgba(255,255,255,0.92) 0%, rgba(250,247,242,0.95) 100%)"),
                        // Glassmorphism
                        backdropFilter: "blur(12px)",
                        WebkitBackdropFilter: "blur(12px)",
                        // Border
                        border: chatFocused
                          ? (isDark ? "1px solid rgba(255,255,255,0.12)" : "1px solid rgba(61,57,41,0.08)")
                          : (isDark ? "1px solid rgba(255,255,255,0.06)" : "1px solid rgba(61,57,41,0.05)"),
                        padding: "8px",
                        position: "relative",
                        // Enhanced shadows with depth
                        boxShadow: chatFocused
                          ? (isDark
                            ? "0 12px 40px rgba(0,0,0,0.2), 0 4px 16px rgba(0,0,0,0.12), inset 0 1px 0 rgba(255,255,255,0.08)"
                            : "0 12px 40px rgba(61,57,41,0.12), 0 4px 16px rgba(61,57,41,0.08), inset 0 1px 0 rgba(255,255,255,0.6)")
                          : (isDark
                            ? "0 6px 24px rgba(0,0,0,0.12), 0 2px 8px rgba(0,0,0,0.08), inset 0 1px 0 rgba(255,255,255,0.05)"
                            : "0 6px 24px rgba(61,57,41,0.08), 0 2px 8px rgba(61,57,41,0.05), inset 0 1px 0 rgba(255,255,255,0.5)"),
                      }}
                    >
                      {(activeMode === "agent" || activeMode === "csv") && (() => {
                        const currentMode = activeMode; // Capture mode to avoid narrowing
                        return (
                          <div className="flex items-center gap-2">
                            {/* Input Container with Mode Selector as Prefix */}
                            <div className="flex-1 flex items-center min-h-[44px]" style={{
                              borderRadius: "24px",
                            }}>
                              {/* Mode Dropdown - Prefix Element */}
                              <div className="shrink-0 pl-3 pr-2 flex items-center">
                                <DropdownMenu open={modeDropdownOpen} onOpenChange={setModeDropdownOpen}>
                                  <DropdownMenuTrigger asChild>
                                    <button
                                      className="shrink-0 px-2.5 py-1 rounded-md transition-all focus:outline-none flex items-center gap-1.5 text-xs font-medium"
                                      style={{
                                        background: isDark ? `rgba(255,255,255,${opacityLight})` : `rgba(61,57,41,${opacityLight})`,
                                        color: textPrimary,
                                        border: "none",
                                        height: "28px",
                                        lineHeight: "1.5",
                                      }}
                                      onMouseEnter={(e) => {
                                        e.currentTarget.style.background = isDark ? `rgba(255,255,255,${opacitySoft})` : `rgba(61,57,41,${opacitySoft})`;
                                      }}
                                      onMouseLeave={(e) => {
                                        e.currentTarget.style.background = isDark ? `rgba(255,255,255,${opacityLight})` : `rgba(61,57,41,${opacityLight})`;
                                      }}
                                      onClick={(e) => {
                                        e.stopPropagation();
                                      }}
                                    >
                                      <div className="shrink-0 w-4 h-4 flex items-center justify-center">
                                        {currentMode === "agent" && <Sparkles className="h-3 w-3" style={{ display: "block" }} />}
                                        {currentMode === "csv" && <Download className="h-3 w-3" style={{ display: "block" }} />}
                                      </div>
                                      <span style={{ lineHeight: "1.5" }}>
                                        {currentMode === "agent" ? "Agent Mode" : "CSV Generator"}
                                      </span>
                                      <ChevronDown className="h-2.5 w-2.5 shrink-0" />
                                    </button>
                                  </DropdownMenuTrigger>
                                  <DropdownMenuContent
                                    align="start"
                                    className="w-64 p-2"
                                    style={{
                                      background: bgSurface,
                                      border: `1px solid ${borderColor}`,
                                      boxShadow: isDark
                                        ? "0 8px 32px rgba(0,0,0,0.24), 0 0 0 1px rgba(255,255,255,0.08)"
                                        : "0 8px 32px rgba(61,57,41,0.12), 0 0 0 1px rgba(61,57,41,0.08)",
                                    }}
                                  >
                                    <DropdownMenuLabel className="px-3 py-2 text-xs font-semibold" style={{ color: textMuted }}>
                                      Select Mode
                                    </DropdownMenuLabel>
                                    <DropdownMenuSeparator style={{ background: borderColor, margin: "4px 0" }} />
                                    {(() => {
                                      const currentMode: ActiveMode = activeMode as ActiveMode; // Type assertion to avoid narrowing
                                      return (
                                        <>
                                          <DropdownMenuItem
                                            onClick={() => {
                                              setActiveMode("agent");
                                              setModeDropdownOpen(false);
                                            }}
                                            className="px-3 py-2.5 rounded-lg cursor-pointer"
                                            style={{
                                              background: currentMode === "agent"
                                                ? (isDark ? "rgba(227,93,36,0.12)" : "rgba(227,93,36,0.1)")
                                                : "transparent",
                                            }}
                                            onMouseEnter={(e) => {
                                              if (currentMode !== "agent") {
                                                e.currentTarget.style.background = isDark ? `rgba(255,255,255,${opacityLight})` : `rgba(61,57,41,${opacityLight})`;
                                              }
                                            }}
                                            onMouseLeave={(e) => {
                                              if (currentMode !== "agent") {
                                                e.currentTarget.style.background = "transparent";
                                              }
                                            }}
                                          >
                                            <div className="flex items-center gap-3 w-full">
                                              <div
                                                className="p-1.5 rounded-lg shrink-0"
                                                style={{
                                                  background: isDark ? "rgba(227,93,36,0.15)" : "rgba(227,93,36,0.12)",
                                                }}
                                              >
                                                <Sparkles className="h-4 w-4" style={{ color: "#E35D24" }} />
                                              </div>
                                              <div className="flex-1 min-w-0">
                                                <div className="flex items-center gap-2">
                                                  <span className="text-sm font-medium" style={{ color: textPrimary }}>Agent Mode</span>
                                                  {currentMode === "agent" && (
                                                    <Check className="h-3.5 w-3.5" style={{ color: "#E35D24" }} />
                                                  )}
                                                </div>
                                                <p className="text-xs mt-0.5" style={{ color: textMuted }}>
                                                  AI-powered query and analysis
                                                </p>
                                              </div>
                                            </div>
                                          </DropdownMenuItem>
                                          <DropdownMenuItem
                                            onClick={() => {
                                              setActiveMode("ticket");
                                              setModeDropdownOpen(false);
                                            }}
                                            className="px-3 py-2.5 rounded-lg cursor-pointer mt-1"
                                            style={{
                                              background: currentMode === "ticket"
                                                ? (isDark ? "rgba(227,93,36,0.12)" : "rgba(227,93,36,0.1)")
                                                : "transparent",
                                            }}
                                            onMouseEnter={(e) => {
                                              if (currentMode !== "ticket") {
                                                e.currentTarget.style.background = isDark ? `rgba(255,255,255,${opacityLight})` : `rgba(61,57,41,${opacityLight})`;
                                              }
                                            }}
                                            onMouseLeave={(e) => {
                                              if (currentMode !== "ticket") {
                                                e.currentTarget.style.background = "transparent";
                                              }
                                            }}
                                          >
                                            <div className="flex items-center gap-3 w-full">
                                              <div
                                                className="p-1.5 rounded-lg shrink-0"
                                                style={{
                                                  background: isDark ? "rgba(227,93,36,0.15)" : "rgba(227,93,36,0.12)",
                                                }}
                                              >
                                                <FileText className="h-4 w-4" style={{ color: "#E35D24" }} />
                                              </div>
                                              <div className="flex-1 min-w-0">
                                                <div className="flex items-center gap-2">
                                                  <span className="text-sm font-medium" style={{ color: textPrimary }}>Ticket Analyser</span>
                                                  {currentMode === "ticket" && (
                                                    <Check className="h-3.5 w-3.5" style={{ color: "#E35D24" }} />
                                                  )}
                                                </div>
                                                <p className="text-xs mt-0.5" style={{ color: textMuted }}>
                                                  Ticket analysis for TASK/RITM
                                                </p>
                                              </div>
                                            </div>
                                          </DropdownMenuItem>
                                          <DropdownMenuItem
                                            onClick={() => {
                                              setActiveMode("csv");
                                              setModeDropdownOpen(false);
                                            }}
                                            className="px-3 py-2.5 rounded-lg cursor-pointer mt-1"
                                            style={{
                                              background: currentMode === "csv"
                                                ? (isDark ? "rgba(227,93,36,0.12)" : "rgba(227,93,36,0.1)")
                                                : "transparent",
                                            }}
                                            onMouseEnter={(e) => {
                                              if (currentMode !== "csv") {
                                                e.currentTarget.style.background = isDark ? `rgba(255,255,255,${opacityLight})` : `rgba(61,57,41,${opacityLight})`;
                                              }
                                            }}
                                            onMouseLeave={(e) => {
                                              if (currentMode !== "csv") {
                                                e.currentTarget.style.background = "transparent";
                                              }
                                            }}
                                          >
                                            <div className="flex items-center gap-3 w-full">
                                              <div
                                                className="p-1.5 rounded-lg shrink-0"
                                                style={{
                                                  background: isDark ? "rgba(227,93,36,0.15)" : "rgba(227,93,36,0.12)",
                                                }}
                                              >
                                                <Download className="h-4 w-4" style={{ color: "#E35D24" }} />
                                              </div>
                                              <div className="flex-1 min-w-0">
                                                <div className="flex items-center gap-2">
                                                  <span className="text-sm font-medium" style={{ color: textPrimary }}>CSV Generator</span>
                                                  {currentMode === "csv" && (
                                                    <Check className="h-3.5 w-3.5" style={{ color: "#E35D24" }} />
                                                  )}
                                                </div>
                                                <p className="text-xs mt-0.5" style={{ color: textMuted }}>
                                                  Generate and download CSV files
                                                </p>
                                              </div>
                                            </div>
                                          </DropdownMenuItem>
                                        </>
                                      );
                                    })()}
                                  </DropdownMenuContent>
                                </DropdownMenu>
                              </div>
                              {/* Textarea - Main input with auto-resize */}
                              <div className="flex-1 relative min-w-0">
                                <Textarea
                                  ref={textareaRef}
                                  placeholder={
                                    activeMode === "agent" ? "Message Chronicle..." :
                                      "Enter query to generate CSV..."
                                  }
                                  value={activeMode === "csv" ? csvQuery : agentQuery}
                                  onChange={(e) => {
                                    if (activeMode === "csv") {
                                      setCsvQuery(e.target.value);
                                    } else {
                                      setAgentQuery(e.target.value);
                                    }
                                    // Auto-resize will be handled by useEffect
                                  }}
                                  onFocus={() => {
                                    setChatFocused(true);
                                    setChatBarCollapsed(false);
                                  }}
                                  onBlur={() => setChatFocused(false)}
                                  onKeyDown={(e) => {
                                    if (e.key === "Enter" && !e.shiftKey) {
                                      e.preventDefault();
                                      handleSubmit();
                                    }
                                    // Escape key to collapse
                                    if (e.key === "Escape" && inputExpanded) {
                                      e.preventDefault();
                                      handleInputCollapse();
                                    }
                                  }}
                                  className="flex-1 resize-none border-0 bg-transparent focus:ring-0 focus-visible:ring-0 text-sm w-full"
                                  style={{
                                    color: textPrimary,
                                    minHeight: "44px",
                                    height: `${inputHeight}px`,
                                    maxHeight: "200px",
                                    paddingLeft: "8px",
                                    paddingRight: "16px",
                                    paddingTop: "12px",
                                    paddingBottom: "12px",
                                    fontSize: "15px",
                                    lineHeight: "1.5",
                                    overflowY: inputHeight >= 200 ? "auto" : "hidden",
                                    transition: "height 0.2s ease-out, padding 0.2s ease-out",
                                  }}
                                  rows={1}
                                  aria-label="Message input"
                                />
                              </div>
                            </div>

                            {/* Action Buttons - Right side */}
                            <div className="flex items-center gap-1.5 shrink-0" style={{ marginRight: "4px" }}>
                              {/* Send Button */}
                              <button
                                onClick={handleSubmit}
                                disabled={(() => {
                                  if (activeMode === "csv") return !csvQuery.trim() || isLoading;
                                  return !agentQuery.trim() || isLoading;
                                })()}
                                className="p-2.5 rounded-full transition-all disabled:opacity-40 focus:outline-none focus:ring-2 focus:ring-offset-0"
                                style={{
                                  background: (() => {
                                    const hasValue = activeMode === "csv" ? csvQuery.trim() : agentQuery.trim();
                                    return hasValue ? "#E35D24" : (isDark ? `rgba(255,255,255,${opacityLight})` : `rgba(61,57,41,${opacityLight})`);
                                  })() ? "#E35D24" : (isDark ? `rgba(255,255,255,${opacityLight})` : `rgba(61,57,41,${opacityLight})`),
                                  color: (() => {
                                    const hasValue = activeMode === "csv" ? csvQuery.trim() : agentQuery.trim();
                                    return hasValue ? "#fff" : textMuted;
                                  })(),
                                  border: "none",
                                  boxShadow: "none",
                                }}
                                onMouseEnter={(e) => {
                                  const hasValue = activeMode === "csv" ? csvQuery.trim() : agentQuery.trim();
                                  if (!e.currentTarget.disabled && hasValue) {
                                    e.currentTarget.style.boxShadow = "0 2px 8px rgba(227,93,36,0.3)";
                                  }
                                }}
                                onMouseLeave={(e) => {
                                  e.currentTarget.style.boxShadow = "none";
                                }}
                                title={activeMode === "csv" ? "Generate CSV" : "Send message"}
                              >
                                {activeMode === "csv" ? <Download className="h-4 w-4" /> : <Send className="h-4 w-4" />}
                              </button>
                            </div>
                          </div>
                        );
                      })()}
                      {activeMode === "ticket" && (
                        <div className="flex flex-col gap-2">
                          <div className="flex items-center gap-1.5 pl-3">
                            {["TASK", "RITM"].map((m) => (
                              <button
                                key={m}
                                onClick={() => setTicketMode(m as "TASK" | "RITM")}
                                className="px-4 py-2 rounded-full text-xs font-medium transition-all focus:outline-none focus:ring-2 focus:ring-offset-0"
                                style={{
                                  background: ticketMode === m
                                    ? (isDark ? "rgba(227,93,36,0.08)" : "rgba(227,93,36,0.06)")
                                    : (isDark ? "rgba(255,255,255,0.03)" : "rgba(61,57,41,0.03)"),
                                  border: "none",
                                  color: ticketMode === m ? "#E35D24" : textMuted,
                                  boxShadow: "none",
                                }}
                                onMouseEnter={(e) => {
                                  if (ticketMode !== m) {
                                    e.currentTarget.style.background = isDark ? "rgba(255,255,255,0.05)" : "rgba(61,57,41,0.05)";
                                    e.currentTarget.style.boxShadow = "0 1px 4px rgba(0,0,0,0.04)";
                                  }
                                }}
                                onMouseLeave={(e) => {
                                  if (ticketMode !== m) {
                                    e.currentTarget.style.background = isDark ? "rgba(255,255,255,0.03)" : "rgba(61,57,41,0.03)";
                                    e.currentTarget.style.boxShadow = "none";
                                  }
                                }}
                                onMouseDown={(e) => {
                                  e.currentTarget.style.boxShadow = "none";
                                }}
                                onMouseUp={(e) => {
                                  if (ticketMode !== m) {
                                    e.currentTarget.style.boxShadow = "0 1px 4px rgba(0,0,0,0.04)";
                                  }
                                }}
                              >
                                {m === "TASK" ? "TASK (RTSK)" : "RITM"}
                              </button>
                            ))}
                          </div>
                          <div className="flex items-center gap-3">
                            {/* Input Container with Mode Selector as Prefix */}
                            <div className="flex-1 flex items-center min-h-[44px]">
                              {/* Mode Dropdown - Prefix Element */}
                              <div className="shrink-0 pl-3 pr-2 flex items-center">
                                <DropdownMenu open={modeDropdownOpen} onOpenChange={setModeDropdownOpen}>
                                  <DropdownMenuTrigger asChild>
                                    <button
                                      className="shrink-0 px-2.5 py-1 rounded-md transition-all focus:outline-none flex items-center gap-1.5 text-xs font-medium"
                                      style={{
                                        background: isDark ? `rgba(255,255,255,${opacityLight})` : `rgba(61,57,41,${opacityLight})`,
                                        color: textPrimary,
                                        border: "none",
                                        height: "28px",
                                        lineHeight: "1.5",
                                      }}
                                      onMouseEnter={(e) => {
                                        e.currentTarget.style.background = isDark ? `rgba(255,255,255,${opacitySoft})` : `rgba(61,57,41,${opacitySoft})`;
                                      }}
                                      onMouseLeave={(e) => {
                                        e.currentTarget.style.background = isDark ? `rgba(255,255,255,${opacityLight})` : `rgba(61,57,41,${opacityLight})`;
                                      }}
                                      onClick={(e) => {
                                        e.stopPropagation();
                                      }}
                                    >
                                      <div className="shrink-0 w-4 h-4 flex items-center justify-center">
                                        <FileText className="h-3 w-3" style={{ display: "block" }} />
                                      </div>
                                      <span style={{ lineHeight: "1.5" }}>Ticket Analyser</span>
                                      <ChevronDown className="h-2.5 w-2.5 shrink-0" />
                                    </button>
                                  </DropdownMenuTrigger>
                                  <DropdownMenuContent
                                    align="start"
                                    className="w-64 p-2"
                                    style={{
                                      background: bgSurface,
                                      border: `1px solid ${borderColor}`,
                                      boxShadow: isDark
                                        ? "0 8px 32px rgba(0,0,0,0.24), 0 0 0 1px rgba(255,255,255,0.08)"
                                        : "0 8px 32px rgba(61,57,41,0.12), 0 0 0 1px rgba(61,57,41,0.08)",
                                    }}
                                  >
                                    <DropdownMenuLabel className="px-3 py-2 text-xs font-semibold" style={{ color: textMuted }}>
                                      Select Mode
                                    </DropdownMenuLabel>
                                    <DropdownMenuSeparator style={{ background: borderColor, margin: "4px 0" }} />
                                    {(() => {
                                      const currentMode: ActiveMode = activeMode as ActiveMode; // Type assertion to avoid narrowing
                                      return (
                                        <>
                                          <DropdownMenuItem
                                            onClick={() => {
                                              setActiveMode("agent");
                                              setModeDropdownOpen(false);
                                            }}
                                            className="px-3 py-2.5 rounded-lg cursor-pointer"
                                            style={{
                                              background: currentMode === "agent"
                                                ? (isDark ? "rgba(227,93,36,0.12)" : "rgba(227,93,36,0.1)")
                                                : "transparent",
                                            }}
                                            onMouseEnter={(e) => {
                                              if (currentMode !== "agent") {
                                                e.currentTarget.style.background = isDark ? `rgba(255,255,255,${opacityLight})` : `rgba(61,57,41,${opacityLight})`;
                                              }
                                            }}
                                            onMouseLeave={(e) => {
                                              if (currentMode !== "agent") {
                                                e.currentTarget.style.background = "transparent";
                                              }
                                            }}
                                          >
                                            <div className="flex items-center gap-3 w-full">
                                              <div
                                                className="p-1.5 rounded-lg shrink-0"
                                                style={{
                                                  background: isDark ? "rgba(227,93,36,0.15)" : "rgba(227,93,36,0.12)",
                                                }}
                                              >
                                                <Sparkles className="h-4 w-4" style={{ color: "#E35D24" }} />
                                              </div>
                                              <div className="flex-1 min-w-0">
                                                <div className="flex items-center gap-2">
                                                  <span className="text-sm font-medium" style={{ color: textPrimary }}>Agent Mode</span>
                                                  {currentMode === "agent" && (
                                                    <Check className="h-3.5 w-3.5" style={{ color: "#E35D24" }} />
                                                  )}
                                                </div>
                                                <p className="text-xs mt-0.5" style={{ color: textMuted }}>
                                                  AI-powered query and analysis
                                                </p>
                                              </div>
                                            </div>
                                          </DropdownMenuItem>
                                          <DropdownMenuItem
                                            onClick={() => {
                                              setActiveMode("ticket");
                                              setModeDropdownOpen(false);
                                            }}
                                            className="px-3 py-2.5 rounded-lg cursor-pointer mt-1"
                                            style={{
                                              background: currentMode === "ticket"
                                                ? (isDark ? "rgba(227,93,36,0.12)" : "rgba(227,93,36,0.1)")
                                                : "transparent",
                                            }}
                                            onMouseEnter={(e) => {
                                              if (currentMode !== "ticket") {
                                                e.currentTarget.style.background = isDark ? `rgba(255,255,255,${opacityLight})` : `rgba(61,57,41,${opacityLight})`;
                                              }
                                            }}
                                            onMouseLeave={(e) => {
                                              if (currentMode !== "ticket") {
                                                e.currentTarget.style.background = "transparent";
                                              }
                                            }}
                                          >
                                            <div className="flex items-center gap-3 w-full">
                                              <div
                                                className="p-1.5 rounded-lg shrink-0"
                                                style={{
                                                  background: isDark ? "rgba(227,93,36,0.15)" : "rgba(227,93,36,0.12)",
                                                }}
                                              >
                                                <FileText className="h-4 w-4" style={{ color: "#E35D24" }} />
                                              </div>
                                              <div className="flex-1 min-w-0">
                                                <div className="flex items-center gap-2">
                                                  <span className="text-sm font-medium" style={{ color: textPrimary }}>Ticket Analyser</span>
                                                  {currentMode === "ticket" && (
                                                    <Check className="h-3.5 w-3.5" style={{ color: "#E35D24" }} />
                                                  )}
                                                </div>
                                                <p className="text-xs mt-0.5" style={{ color: textMuted }}>
                                                  Ticket analysis for TASK/RITM
                                                </p>
                                              </div>
                                            </div>
                                          </DropdownMenuItem>
                                          <DropdownMenuItem
                                            onClick={() => {
                                              setActiveMode("csv");
                                              setModeDropdownOpen(false);
                                            }}
                                            className="px-3 py-2.5 rounded-lg cursor-pointer mt-1"
                                            style={{
                                              background: currentMode === "csv"
                                                ? (isDark ? "rgba(227,93,36,0.12)" : "rgba(227,93,36,0.1)")
                                                : "transparent",
                                            }}
                                            onMouseEnter={(e) => {
                                              if (currentMode !== "csv") {
                                                e.currentTarget.style.background = isDark ? `rgba(255,255,255,${opacityLight})` : `rgba(61,57,41,${opacityLight})`;
                                              }
                                            }}
                                            onMouseLeave={(e) => {
                                              if (currentMode !== "csv") {
                                                e.currentTarget.style.background = "transparent";
                                              }
                                            }}
                                          >
                                            <div className="flex items-center gap-3 w-full">
                                              <div
                                                className="p-1.5 rounded-lg shrink-0"
                                                style={{
                                                  background: isDark ? "rgba(227,93,36,0.15)" : "rgba(227,93,36,0.12)",
                                                }}
                                              >
                                                <Download className="h-4 w-4" style={{ color: "#E35D24" }} />
                                              </div>
                                              <div className="flex-1 min-w-0">
                                                <div className="flex items-center gap-2">
                                                  <span className="text-sm font-medium" style={{ color: textPrimary }}>CSV Generator</span>
                                                  {currentMode === "csv" && (
                                                    <Check className="h-3.5 w-3.5" style={{ color: "#E35D24" }} />
                                                  )}
                                                </div>
                                                <p className="text-xs mt-0.5" style={{ color: textMuted }}>
                                                  Generate and download CSV files
                                                </p>
                                              </div>
                                            </div>
                                          </DropdownMenuItem>
                                        </>
                                      );
                                    })()}
                                  </DropdownMenuContent>
                                </DropdownMenu>
                              </div>
                              {/* Input Field */}
                              <div className="flex-1 relative min-w-0">
                                <Input
                                  ref={inputRef}
                                  placeholder={ticketMode === "TASK" ? "Enter TASK number (e.g., TASK300045)" : "Enter RITM number (e.g., RITM200045)"}
                                  value={ticketMode === "TASK" ? taskNumber : ritmNumber}
                                  onChange={(e) => ticketMode === "TASK" ? setTaskNumber(e.target.value) : setRitmNumber(e.target.value)}
                                  onFocus={() => {
                                    setChatFocused(true);
                                    setChatBarCollapsed(false);
                                  }}
                                  onBlur={() => setChatFocused(false)}
                                  onKeyDown={(e) => {
                                    if (e.key === "Enter") handleSubmit();
                                  }}
                                  className="flex-1 border-0 bg-transparent focus:ring-0 focus-visible:ring-0 text-sm"
                                  style={{
                                    color: textPrimary,
                                    paddingLeft: "8px",
                                    paddingRight: "16px",
                                    paddingTop: "12px",
                                    paddingBottom: "12px",
                                    lineHeight: "1.5",
                                  }}
                                />
                              </div>
                            </div>
                            <div className="flex items-center gap-1.5 shrink-0">
                              <button
                                onClick={handleSubmit}
                                disabled={isLoading || !(ticketMode === "TASK" ? taskNumber : ritmNumber).trim()}
                                className="p-2.5 rounded-full transition-all disabled:opacity-40 focus:outline-none focus:ring-2 focus:ring-offset-0"
                                style={{
                                  background: (ticketMode === "TASK" ? taskNumber : ritmNumber).trim() ? "#E35D24" : (isDark ? `rgba(255,255,255,${opacityLight})` : `rgba(61,57,41,${opacityLight})`),
                                  color: (ticketMode === "TASK" ? taskNumber : ritmNumber).trim() ? "#fff" : textMuted,
                                  border: "none",
                                  boxShadow: "none",
                                }}
                                onMouseEnter={(e) => {
                                  if (!e.currentTarget.disabled && (ticketMode === "TASK" ? taskNumber : ritmNumber).trim()) {
                                    e.currentTarget.style.boxShadow = "0 2px 8px rgba(227,93,36,0.3)";
                                  }
                                }}
                                onMouseLeave={(e) => {
                                  e.currentTarget.style.boxShadow = "none";
                                }}
                                title="Generate RCA"
                              >
                                <Send className="h-4 w-4" />
                              </button>
                            </div>
                          </div>
                        </div>
                      )}
                    </motion.div>
                  </motion.div>
                </motion.div>
              )}

              {/* Conversation Messages - Copilot Style (Agent mode only) */}
              {activeMode === "agent" && conversation.length > 0 && (
                <div className="space-y-8">
                  {conversation.map((message, idx) => {
                    const isLastMessage = idx === conversation.length - 1;

                    // Fix: Hide empty placeholder message during loading to avoid visual duplication
                    // with the dedicated "Analyzing..." indicator below.
                    // We check !message.content (empty string) to ensure we hide it even if 
                    // metadata (agentData) has arrived but text hasn't started streaming yet.
                    if (agentLoading && isLastMessage && message.role === "assistant" && !message.content) {
                      return null;
                    }

                    return (
                      <motion.div
                        key={message.id}
                        initial={{ opacity: 0, y: 12 }}
                        animate={{ opacity: 1, y: 0 }}
                        transition={{ delay: idx * 0.05 }}
                        className={`flex ${message.role === "user" ? "justify-end" : "justify-start"} items-start gap-4 group`}
                      >
                        {message.role === "assistant" && (
                          <div className="shrink-0 mt-1">
                            <img src="/logo.png" alt="Chronicle" className="h-5 w-5" />
                          </div>
                        )}
                        {message.role === "user" ? (
                          <div
                            className="rounded-2xl rounded-br-sm px-4 py-2.5 max-w-[65%]"
                            style={{
                              background: isDark
                                ? "rgba(227,93,36,0.12)"
                                : "rgba(227,93,36,0.08)",
                              color: textPrimary,
                            }}
                          >
                            <div
                              className="text-sm leading-relaxed"
                              style={{
                                fontSize: "14px",
                                lineHeight: "1.6",
                                color: textPrimary,
                              }}
                            >
                              {message.content}
                            </div>
                          </div>
                        ) : (
                          <div className="flex-1 w-full">
                            <div
                              className="leading-relaxed"
                              style={{
                                fontSize: "15px",
                                lineHeight: "1.7",
                                color: textPrimary,
                                fontWeight: 400,
                                letterSpacing: "-0.01em",
                              }}
                            >
                              {message.agentData ? (
                                // First check if this is an error or partial message - always show placeholder
                                message.agentData.error ? (
                                  <span style={{ fontStyle: "italic", opacity: 0.6 }}>
                                    (An error occurred during response)
                                  </span>
                                ) : message.agentData.partial && !message.content ? (
                                  <span style={{ fontStyle: "italic", opacity: 0.6 }}>
                                    (Response was interrupted)
                                  </span>
                                ) : message.content ? (
                                  <TypewriterText
                                    text={message.content}
                                    speed={12}
                                    enableTypewriter={isLastMessage && showTypewriter}
                                    onComplete={() => setShowTypewriter(false)}
                                    onUpdate={scrollToBottom}
                                  />
                                ) : (
                                  // Only show placeholder for historical messages, not during active streaming
                                  (isLastMessage && agentLoading) ? null : (
                                    <span style={{ fontStyle: "italic", opacity: 0.6 }}>
                                      (No response available)
                                    </span>
                                  )
                                )
                              ) : (
                                message.content || (
                                  // Only show placeholder for historical messages, not during active streaming
                                  (isLastMessage && agentLoading) ? null : (
                                    <span style={{ fontStyle: "italic", opacity: 0.6 }}>
                                      (No response available)
                                    </span>
                                  )
                                )
                              )}
                            </div>
                            {/* Inline Action Bar - Copilot Style */}
                            <div className="mt-2 flex items-center gap-1">
                              <CopyButton text={message.content} />
                              {/* Visualization Button - Show if message has visualization */}
                              {message.agentData?.needs_visualization && message.agentData?.chart_spec && (
                                <button
                                  onClick={() => {
                                    setActiveVisualizationMessageId(message.id);
                                    if (!rightPanelOpen) {
                                      setRightPanelOpen(true);
                                    }
                                  }}
                                  className="p-1.5 rounded transition-all focus:outline-none focus:ring-1 focus:ring-offset-0"
                                  style={{
                                    background: activeVisualizationMessageId === message.id
                                      ? (isDark ? "rgba(227,93,36,0.15)" : "rgba(227,93,36,0.12)")
                                      : "transparent",
                                    color: activeVisualizationMessageId === message.id
                                      ? "#E35D24"
                                      : textMuted,
                                    border: "none",
                                    transition: "background 150ms ease, color 150ms ease",
                                  }}
                                  onMouseEnter={(e) => {
                                    if (activeVisualizationMessageId !== message.id) {
                                      e.currentTarget.style.background = isDark ? `rgba(255,255,255,${opacityMedium})` : `rgba(61,57,41,${opacityMedium})`;
                                    }
                                  }}
                                  onMouseLeave={(e) => {
                                    if (activeVisualizationMessageId !== message.id) {
                                      e.currentTarget.style.background = "transparent";
                                    }
                                  }}
                                  aria-label="Show visualization"
                                  title="Show visualization"
                                >
                                  <BarChart3 className="h-3.5 w-3.5" />
                                </button>
                              )}
                              {message.agentData?.rows && (
                                <button
                                  onClick={() => {
                                    try {
                                      const rows = message.agentData!.rows!;
                                      if (Array.isArray(rows) && rows.length > 0) {
                                        // Check if rows are objects (records) or arrays
                                        if (typeof rows[0] === 'object' && !Array.isArray(rows[0])) {
                                          // Convert objects to CSV format
                                          const headers = Object.keys(rows[0]);
                                          const csvRows = rows.map((row: any) =>
                                            headers.map(header => {
                                              const value = row[header];
                                              return value !== null && value !== undefined ? String(value) : '';
                                            })
                                          );
                                          exportToCSV([headers, ...csvRows], "results.csv");
                                        } else {
                                          // Already in array format
                                          exportToCSV(rows as string[][], "results.csv");
                                        }
                                        toast.success("Exported!");
                                      } else {
                                        toast.error("No data to export");
                                      }
                                    } catch (error) {
                                      console.error("Export error:", error);
                                      toast.error("Failed to export data");
                                    }
                                  }}
                                  onMouseEnter={(e) => {
                                    e.currentTarget.style.background = isDark ? `rgba(255,255,255,${opacityMedium})` : `rgba(61,57,41,${opacityMedium})`;
                                    e.currentTarget.style.color = isDark ? `rgba(255,255,255,${opacityDefault})` : `rgba(61,57,41,${opacityDefault})`;
                                  }}
                                  onMouseLeave={(e) => {
                                    e.currentTarget.style.background = "transparent";
                                    e.currentTarget.style.color = textMuted;
                                  }}
                                  className="p-1.5 rounded transition-all focus:outline-none focus:ring-1 focus:ring-offset-0"
                                  style={{
                                    background: "transparent",
                                    color: textMuted,
                                    border: "none",
                                    transition: "background 150ms ease, color 150ms ease",
                                  }}
                                  aria-label="Export to CSV"
                                  title="Export to CSV"
                                >
                                  <Download className="h-3.5 w-3.5" />
                                </button>
                              )}
                              {/* Feedback Buttons - Copilot Style */}
                              <button
                                onClick={() => {
                                  setMessageFeedback(prev => {
                                    const current = prev[message.id];
                                    if (current === "up") {
                                      // Toggle off if already selected
                                      const { [message.id]: _, ...rest } = prev;
                                      return rest;
                                    }
                                    // Set to up (automatically removes down if present)
                                    return { ...prev, [message.id]: "up" };
                                  });
                                }}
                                onMouseEnter={(e) => {
                                  const isActive = messageFeedback[message.id] === "up";
                                  e.currentTarget.style.background = isDark ? `rgba(255,255,255,${opacityMedium})` : `rgba(61,57,41,${opacityMedium})`;
                                  e.currentTarget.style.color = isActive
                                    ? (isDark ? `rgba(255,255,255,${opacityDefault})` : `rgba(61,57,41,${opacityDefault})`)
                                    : (isDark ? `rgba(255,255,255,${opacityDefault})` : `rgba(61,57,41,${opacityDefault})`);
                                }}
                                onMouseLeave={(e) => {
                                  const isActive = messageFeedback[message.id] === "up";
                                  e.currentTarget.style.background = "transparent";
                                  e.currentTarget.style.color = isActive
                                    ? (isDark ? `rgba(255,255,255,${opacityDefault})` : `rgba(61,57,41,${opacityDefault})`)
                                    : textMuted;
                                }}
                                className="p-1.5 rounded transition-all focus:outline-none focus:ring-1 focus:ring-offset-0"
                                style={{
                                  background: "transparent",
                                  color: messageFeedback[message.id] === "up"
                                    ? (isDark ? `rgba(255,255,255,${opacityDefault})` : `rgba(61,57,41,${opacityDefault})`)
                                    : textMuted,
                                  border: "none",
                                  transition: "background 150ms ease, color 150ms ease",
                                }}
                                aria-label="Thumbs up"
                                title="Thumbs up"
                              >
                                <ThumbsUp
                                  className="h-3.5 w-3.5"
                                  style={{
                                    fill: messageFeedback[message.id] === "up"
                                      ? (isDark ? `rgba(255,255,255,${opacityDefault})` : `rgba(61,57,41,${opacityDefault})`)
                                      : "none"
                                  }}
                                />
                              </button>
                              <button
                                onClick={() => {
                                  setMessageFeedback(prev => {
                                    const current = prev[message.id];
                                    if (current === "down") {
                                      const { [message.id]: _, ...rest } = prev;
                                      return rest;
                                    }
                                    return { ...prev, [message.id]: "down" };
                                  });
                                }}
                                onMouseEnter={(e) => {
                                  const isActive = messageFeedback[message.id] === "down";
                                  e.currentTarget.style.background = isDark ? `rgba(255,255,255,${opacityMedium})` : `rgba(61,57,41,${opacityMedium})`;
                                  e.currentTarget.style.color = isActive
                                    ? (isDark ? `rgba(255,255,255,${opacityDefault})` : `rgba(61,57,41,${opacityDefault})`)
                                    : (isDark ? `rgba(255,255,255,${opacityDefault})` : `rgba(61,57,41,${opacityDefault})`);
                                }}
                                onMouseLeave={(e) => {
                                  const isActive = messageFeedback[message.id] === "down";
                                  e.currentTarget.style.background = "transparent";
                                  e.currentTarget.style.color = isActive
                                    ? (isDark ? `rgba(255,255,255,${opacityDefault})` : `rgba(61,57,41,${opacityDefault})`)
                                    : textMuted;
                                }}
                                className="p-1.5 rounded transition-all focus:outline-none focus:ring-1 focus:ring-offset-0"
                                style={{
                                  background: "transparent",
                                  color: messageFeedback[message.id] === "down"
                                    ? (isDark ? `rgba(255,255,255,${opacityDefault})` : `rgba(61,57,41,${opacityDefault})`)
                                    : textMuted,
                                  border: "none",
                                  transition: "background 150ms ease, color 150ms ease",
                                }}
                                aria-label="Thumbs down"
                                title="Thumbs down"
                              >
                                <ThumbsDown
                                  className="h-3.5 w-3.5"
                                  style={{
                                    fill: messageFeedback[message.id] === "down"
                                      ? (isDark ? `rgba(255,255,255,${opacityDefault})` : `rgba(61,57,41,${opacityDefault})`)
                                      : "none"
                                  }}
                                />
                              </button>
                            </div>
                          </div>
                        )}
                      </motion.div>
                    );
                  })}

                  {/* Loading State - Copilot Style */}
                  {/* Show loading indicator only when loading and no response text has started yet */}
                  {agentLoading && !agentResult && (
                    <motion.div
                      initial={{ opacity: 0, y: 12 }}
                      animate={{ opacity: 1, y: 0 }}
                      className="flex justify-start items-center gap-3"
                    >
                      <div className="shrink-0">
                        <motion.img
                          src="/logo.png"
                          alt="Chronicle"
                          className="h-5 w-5"
                          animate={{
                            scale: [1, 1.1, 1],
                            opacity: [0.6, 1, 0.6],
                          }}
                          transition={{
                            duration: 1.5,
                            repeat: Infinity,
                            ease: "easeInOut",
                          }}
                        />
                      </div>
                      <div>
                        <p className="text-sm" style={{ color: textMuted }}>
                          {loadingMessage}
                        </p>
                      </div>
                    </motion.div>
                  )}

                  {/* Error state is now handled inline in conversation messages */}

                  {/* Bottom anchor for auto-scroll */}
                  <div ref={messagesEndRef} className="h-1" />
                </div>
              )}

              {/* CSV Generator Results */}
              {activeMode === "csv" && (csvResult || csvError || csvLoading) && (
                <div className="space-y-6">
                  <motion.article
                    initial={{ opacity: 0, y: 16 }}
                    animate={{ opacity: 1, y: 0 }}
                    className="rounded-xl p-6"
                    style={{
                      background: isDark ? "rgba(255,255,255,0.02)" : "rgba(61,57,41,0.02)",
                      border: `1px solid ${borderColor}`,
                    }}
                  >
                    <header className="flex items-center justify-between mb-5 pb-4" style={{ borderBottom: `1px solid ${borderColor}` }}>
                      <div className="flex items-center gap-2.5">
                        <img src="/logo.png" alt="Bot" className="h-5 w-5" />
                        <span className="text-sm font-medium" style={{ color: textMuted }}>CSV Generator</span>
                      </div>
                    </header>

                    {csvLoading && (
                      <div className="flex flex-col items-center justify-center py-12 gap-4">
                        <motion.div
                          animate={{ rotate: 360 }}
                          transition={{ duration: 1, repeat: Infinity, ease: "linear" }}
                        >
                          <Loader2 className="h-6 w-6" style={{ color: "#E35D24" }} />
                        </motion.div>
                        <p className="text-sm" style={{ color: textMuted }}>Generating CSV...</p>
                      </div>
                    )}

                    {csvError && (
                      <div className="rounded-lg p-4" style={{ background: isDark ? "rgba(239,68,68,0.1)" : "rgba(239,68,68,0.05)" }}>
                        <div className="flex items-center gap-2 mb-2">
                          <AlertTriangle className="h-4 w-4" style={{ color: "#ef4444" }} />
                          <span className="text-sm font-medium" style={{ color: "#ef4444" }}>Error</span>
                        </div>
                        <p className="text-sm" style={{ color: textMuted }}>{csvError}</p>
                      </div>
                    )}

                    {csvResult && (
                      <div className="space-y-4">
                        {/* User Query Bubble */}
                        {csvResult.query && (
                          <div className="flex justify-end">
                            <div
                              className="rounded-2xl rounded-br-sm px-4 py-2.5 max-w-[65%]"
                              style={{
                                background: isDark
                                  ? "rgba(227,93,36,0.12)"
                                  : "rgba(227,93,36,0.08)",
                                color: textPrimary,
                              }}
                            >
                              <div className="text-sm leading-relaxed" style={{ fontSize: "14px", lineHeight: "1.6" }}>
                                {csvResult.query}
                              </div>
                            </div>
                          </div>
                        )}
                        <div className="rounded-lg p-4" style={{ background: isDark ? "rgba(16,185,129,0.1)" : "rgba(16,185,129,0.05)" }}>
                          <div className="flex items-center gap-2 mb-2">
                            <CheckCircle2 className="h-4 w-4" style={{ color: "#10b981" }} />
                            <span className="text-sm font-medium" style={{ color: "#10b981" }}>CSV Generated Successfully</span>
                          </div>
                          <p className="text-sm" style={{ color: textMuted }}>
                            {csvResult.row_count} rows exported to <strong>{csvResult.filename}</strong>
                          </p>
                        </div>

                        {csvResult && csvResult.sessionId && (
                          <div className="flex justify-end">
                            <Button
                              variant="outline"
                              size="sm"
                              onClick={async () => {
                                try {
                                  toast.info("Fetching from server...");
                                  // Fetch fresh data from PostgreSQL
                                  const sessionData = await getSession(csvResult.sessionId!);
                                  const lastAssistantMsg = sessionData.messages
                                    .filter((m: BackendChatMessage) => m.role === "assistant")
                                    .pop();

                                  if (lastAssistantMsg?.agent_data?.csv_content) {
                                    exportGzipToCSV(
                                      lastAssistantMsg.agent_data.csv_content,
                                      lastAssistantMsg.agent_data.filename || csvResult.filename
                                    );
                                    toast.success("Download started");
                                  } else {
                                    toast.error("CSV data not found in session");
                                  }
                                } catch (error) {
                                  console.error("Failed to fetch CSV from backend:", error);
                                  toast.error("Failed to fetch CSV from server");
                                }
                              }}
                              className="gap-2"
                              style={{
                                borderColor: borderColor,
                                color: textPrimary
                              }}
                            >
                              <Download className="h-4 w-4" />
                              Download Again
                            </Button>
                          </div>
                        )}


                      </div>
                    )}
                  </motion.article>
                </div>
              )}

              {/* RCA Responses */}
              {activeMode === "ticket" && rcaItems.length > 0 && (
                <div className="space-y-6">
                  {rcaItems.map((item) => (
                    <motion.article
                      key={item.id}
                      initial={{ opacity: 0, y: 16 }}
                      animate={{ opacity: 1, y: 0 }}
                      exit={{ opacity: 0, y: -16 }}
                    >
                      <header className="flex items-center justify-between mb-5 pb-4" style={{ borderBottom: `1px solid ${borderColor}` }}>
                        <div className="flex items-center gap-2.5">
                          <img src="/logo.png" alt="Bot" className="h-5 w-5" />
                          <span className="text-sm font-medium" style={{ color: textMuted }}>Ticket Analyser</span>
                          <span className="text-xs" style={{ color: textMuted }}>
                            ({item.ticketMode}: {item.ticketNumber})
                          </span>
                        </div>
                        {item.state === "success" && item.data && (
                          <CopyButton text={item.data.generated_rca || prettyJson(item.data.ticket_data)} />
                        )}
                      </header>

                      {/* Loading State - only show if no data yet */}
                      {item.state === "loading" && !item.data?.generated_rca && (
                        <div className="flex flex-col items-center justify-center py-12 gap-4">
                          <motion.div
                            animate={{ rotate: 360 }}
                            transition={{ duration: 1, repeat: Infinity, ease: "linear" }}
                          >
                            <Loader2 className="h-6 w-6" style={{ color: "#E35D24" }} />
                          </motion.div>
                          <p className="text-sm" style={{ color: textMuted }}>Analysing ticket...</p>
                        </div>
                      )}

                      {/* Success State - show text as it streams (even if state is still loading but we have data) */}
                      {(item.state === "success" || (item.state === "loading" && item.data?.generated_rca)) && item.data && (
                        <>
                          {item.data.generated_rca && (
                            <div className="leading-relaxed mb-6" style={{ color: textPrimary, fontSize: "15px", lineHeight: "1.8" }}>
                              <TypewriterText
                                text={item.data.generated_rca}
                                speed={12}
                                enableTypewriter={item.showTypewriter}
                                onComplete={() => {
                                  setRcaItems(prev => prev.map(i =>
                                    i.id === item.id ? { ...i, showTypewriter: false } : i
                                  ));
                                }}
                              />
                            </div>
                          )}
                          {item.data.ticket_data && Object.keys(item.data.ticket_data).length > 0 && (
                            <details className="rounded-2xl overflow-hidden" style={{ background: isDark ? "rgba(255,255,255,0.02)" : "rgba(61,57,41,0.02)", border: `1px solid ${borderColor}` }}>
                              <summary className="px-5 py-3 cursor-pointer flex items-center justify-between text-sm font-medium" style={{ color: textPrimary }}>
                                <span className="flex items-center gap-2"><FileText className="h-4 w-4" />Ticket Data</span>
                                <ChevronRight className="h-4 w-4" />
                              </summary>
                              <pre className="px-5 py-4 text-xs overflow-auto max-h-72" style={{ color: textMuted }}>{prettyJson(item.data.ticket_data)}</pre>
                            </details>
                          )}
                        </>
                      )}

                      {/* Error State */}
                      {item.state === "error" && (
                        <div className="flex items-start gap-3 p-4 rounded-2xl" style={{
                          background: isDark ? "rgba(239,68,68,0.06)" : "rgba(239,68,68,0.04)",
                          border: `1px solid ${isDark ? "rgba(239,68,68,0.2)" : "rgba(239,68,68,0.12)"}`,
                        }}>
                          <AlertTriangle className="h-5 w-5 shrink-0 mt-0.5" style={{ color: isDark ? "#FCA5A5" : "#DC2626" }} />
                          <div>
                            <p className="text-sm font-medium mb-1" style={{ color: isDark ? "#FCA5A5" : "#DC2626" }}>
                              Error analysing ticket
                            </p>
                            <p className="text-sm" style={{ color: textMuted }}>
                              {item.error}
                            </p>
                          </div>
                        </div>
                      )}
                    </motion.article>
                  ))}
                </div>
              )}
            </div>
          </div>
        </div>

        {/* Sticky Input Box - Copilot Style (only show when there are conversations/results) */}
        {(conversation.length > 0 || rcaItems.length > 0 || agentLoading || rcaLoading || csvResult) && (
          <div
            className="shrink-0 w-full flex justify-center relative z-10 sticky bottom-0"
            style={{
              paddingTop: inputExpanded ? '16px' : '24px',
              paddingBottom: '32px',
              background: isDark
                ? `linear-gradient(to top, #151513 0%, #151513 60%, rgba(21,21,19,0.96) 80%, rgba(21,21,19,0.92) 100%)`
                : `linear-gradient(to top, #FAF7F2 0%, #FAF7F2 60%, rgba(250,247,242,0.96) 80%, rgba(250,247,242,0.92) 100%)`,
              borderTop: `1px solid ${isDark ? 'rgba(255,255,255,0.03)' : 'rgba(61,57,41,0.03)'}`,
            }}
          >
            <div className="w-full max-w-[780px] px-8">
              <motion.div
                ref={chatInputBarRef}
                className="rounded-2xl relative overflow-hidden"
                animate={{
                  scale: chatFocused ? 1.002 : submitAcknowledged ? 0.998 : 1,
                  opacity: submitAcknowledged ? 0.96 : 1,
                }}
                transition={{
                  scale: { duration: 0.2, ease: "easeOut" },
                  opacity: { duration: 0.15, ease: "easeOut" }
                }}
                style={{
                  // Soft gradient background with more breathing room
                  background: chatFocused
                    ? (isDark
                      ? "linear-gradient(180deg, rgba(255,255,255,0.09) 0%, rgba(255,255,255,0.05) 100%)"
                      : "linear-gradient(180deg, rgba(255,255,255,0.97) 0%, rgba(250,247,242,0.99) 100%)")
                    : (isDark
                      ? "linear-gradient(180deg, rgba(255,255,255,0.07) 0%, rgba(255,255,255,0.04) 100%)"
                      : "linear-gradient(180deg, rgba(255,255,255,0.94) 0%, rgba(250,247,242,0.97) 100%)"),
                  // Glassmorphism
                  backdropFilter: "blur(16px)",
                  WebkitBackdropFilter: "blur(16px)",
                  // Subtle border - no hard edges
                  border: chatFocused
                    ? (isDark ? "1px solid rgba(255,255,255,0.1)" : "1px solid rgba(61,57,41,0.06)")
                    : (isDark ? "1px solid rgba(255,255,255,0.05)" : "1px solid rgba(61,57,41,0.04)"),
                  padding: "12px",
                  position: "relative",
                  // Soft elevation with subtle glow on focus
                  boxShadow: chatFocused
                    ? (isDark
                      ? "0 8px 32px rgba(0,0,0,0.16), 0 2px 12px rgba(0,0,0,0.1), 0 0 0 1px rgba(255,255,255,0.06), 0 0 24px rgba(227,93,36,0.08)"
                      : "0 8px 32px rgba(61,57,41,0.1), 0 2px 12px rgba(61,57,41,0.06), 0 0 0 1px rgba(61,57,41,0.05), 0 0 24px rgba(227,93,36,0.06)")
                    : (isDark
                      ? "0 4px 20px rgba(0,0,0,0.1), 0 1px 6px rgba(0,0,0,0.06), inset 0 1px 0 rgba(255,255,255,0.04)"
                      : "0 4px 20px rgba(61,57,41,0.06), 0 1px 6px rgba(61,57,41,0.04), inset 0 1px 0 rgba(255,255,255,0.4)"),
                }}
              >
                {/* Flashlight hover effect overlay */}
                <div
                  className="absolute inset-0 pointer-events-none rounded-2xl transition-opacity duration-300"
                  style={{
                    opacity: isHovering ? 1 : 0,
                    background: isDark
                      ? `radial-gradient(300px circle at ${mouseX}px ${mouseY}px, rgba(255, 255, 255, 0.05), transparent 70%)`
                      : `radial-gradient(320px circle at ${mouseX}px ${mouseY}px, rgba(61, 57, 41, 0.12) 0%, rgba(61, 57, 41, 0.06) 35%, rgba(61, 57, 41, 0.02) 60%, transparent 80%)`,
                    zIndex: 1,
                  }}
                />
                {/* Additional depth layer for light theme - creates subtle shadow effect */}
                {!isDark && (
                  <div
                    className="absolute inset-0 pointer-events-none rounded-2xl transition-opacity duration-300"
                    style={{
                      opacity: isHovering ? 0.7 : 0,
                      background: `radial-gradient(280px circle at ${mouseX}px ${mouseY}px, rgba(0, 0, 0, 0.04), transparent 65%)`,
                      zIndex: 1,
                    }}
                  />
                )}
                <div style={{ position: 'relative', zIndex: 10 }}>
                  {activeMode === "agent" ? (
                    <div className="flex items-center gap-2">
                      {/* Input Container with Mode Selector as Prefix */}
                      <div className="flex-1 flex items-center min-h-[44px]">
                        {/* Mode Dropdown - Prefix Element */}
                        <div className="shrink-0 pl-2 pr-1.5 flex items-center">
                          <DropdownMenu open={modeDropdownOpen} onOpenChange={setModeDropdownOpen}>
                            <DropdownMenuTrigger asChild>
                              <button
                                className="shrink-0 px-2 py-1 rounded-lg transition-all focus:outline-none flex items-center gap-1.5 text-xs font-medium"
                                style={{
                                  background: isDark ? `rgba(255,255,255,0.06)` : `rgba(61,57,41,0.05)`,
                                  color: textMuted,
                                  border: "none",
                                  height: "28px",
                                  lineHeight: "1.5",
                                }}
                                onMouseEnter={(e) => {
                                  e.currentTarget.style.background = isDark ? `rgba(255,255,255,0.1)` : `rgba(61,57,41,0.08)`;
                                  e.currentTarget.style.color = textPrimary;
                                }}
                                onMouseLeave={(e) => {
                                  e.currentTarget.style.background = isDark ? `rgba(255,255,255,0.06)` : `rgba(61,57,41,0.05)`;
                                  e.currentTarget.style.color = textMuted;
                                }}
                                onClick={(e) => {
                                  e.stopPropagation();
                                }}
                              >
                                <div className="shrink-0 w-3.5 h-3.5 flex items-center justify-center">
                                  <Sparkles className="h-3 w-3" style={{ display: "block" }} />
                                </div>
                                <span style={{ lineHeight: "1.5" }}>Agent Mode</span>
                                <ChevronDown className="h-2.5 w-2.5 shrink-0" />
                              </button>
                            </DropdownMenuTrigger>
                            <DropdownMenuContent
                              align="start"
                              className="w-64 p-2"
                              style={{
                                background: bgSurface,
                                border: `1px solid ${borderColor}`,
                                boxShadow: isDark
                                  ? "0 8px 32px rgba(0,0,0,0.24), 0 0 0 1px rgba(255,255,255,0.08)"
                                  : "0 8px 32px rgba(61,57,41,0.12), 0 0 0 1px rgba(61,57,41,0.08)",
                              }}
                            >
                              <DropdownMenuLabel className="px-3 py-2 text-xs font-semibold" style={{ color: textMuted }}>
                                Select Mode
                              </DropdownMenuLabel>
                              <DropdownMenuSeparator style={{ background: borderColor, margin: "4px 0" }} />
                              {(() => {
                                const currentMode: ActiveMode = activeMode as ActiveMode; // Type assertion to avoid narrowing
                                return (
                                  <>
                                    <DropdownMenuItem
                                      onClick={() => {
                                        switchToMode("agent");
                                        setModeDropdownOpen(false);
                                      }}
                                      className="px-3 py-2.5 rounded-lg cursor-pointer"
                                      style={{
                                        background: currentMode === "agent"
                                          ? (isDark ? "rgba(227,93,36,0.12)" : "rgba(227,93,36,0.1)")
                                          : "transparent",
                                      }}
                                      onMouseEnter={(e) => {
                                        if (currentMode !== "agent") {
                                          e.currentTarget.style.background = isDark ? `rgba(255,255,255,${opacityLight})` : `rgba(61,57,41,${opacityLight})`;
                                        }
                                      }}
                                      onMouseLeave={(e) => {
                                        if (currentMode !== "agent") {
                                          e.currentTarget.style.background = "transparent";
                                        }
                                      }}
                                    >
                                      <div className="flex items-center gap-3 w-full">
                                        <div
                                          className="p-1.5 rounded-lg shrink-0"
                                          style={{
                                            background: isDark ? "rgba(227,93,36,0.15)" : "rgba(227,93,36,0.12)",
                                          }}
                                        >
                                          <Sparkles className="h-4 w-4" style={{ color: "#E35D24" }} />
                                        </div>
                                        <div className="flex-1 min-w-0">
                                          <div className="flex items-center gap-2">
                                            <span className="text-sm font-medium" style={{ color: textPrimary }}>Agent Mode</span>
                                            {currentMode === "agent" && (
                                              <Check className="h-3.5 w-3.5" style={{ color: "#E35D24" }} />
                                            )}
                                          </div>
                                          <p className="text-xs mt-0.5" style={{ color: textMuted }}>
                                            AI-powered query and analysis
                                          </p>
                                        </div>
                                      </div>
                                    </DropdownMenuItem>
                                    <DropdownMenuItem
                                      onClick={() => {
                                        switchToMode("ticket");
                                        setModeDropdownOpen(false);
                                      }}
                                      className="px-3 py-2.5 rounded-lg cursor-pointer mt-1"
                                      style={{
                                        background: currentMode === "ticket"
                                          ? (isDark ? "rgba(227,93,36,0.12)" : "rgba(227,93,36,0.1)")
                                          : "transparent",
                                      }}
                                      onMouseEnter={(e) => {
                                        if (currentMode !== "ticket") {
                                          e.currentTarget.style.background = isDark ? `rgba(255,255,255,${opacityLight})` : `rgba(61,57,41,${opacityLight})`;
                                        }
                                      }}
                                      onMouseLeave={(e) => {
                                        if (currentMode !== "ticket") {
                                          e.currentTarget.style.background = "transparent";
                                        }
                                      }}
                                    >
                                      <div className="flex items-center gap-3 w-full">
                                        <div
                                          className="p-1.5 rounded-lg shrink-0"
                                          style={{
                                            background: isDark ? "rgba(227,93,36,0.15)" : "rgba(227,93,36,0.12)",
                                          }}
                                        >
                                          <FileText className="h-4 w-4" style={{ color: "#E35D24" }} />
                                        </div>
                                        <div className="flex-1 min-w-0">
                                          <div className="flex items-center gap-2">
                                            <span className="text-sm font-medium" style={{ color: textPrimary }}>Ticket Analyser</span>
                                            {currentMode === "ticket" && (
                                              <Check className="h-3.5 w-3.5" style={{ color: "#E35D24" }} />
                                            )}
                                          </div>
                                          <p className="text-xs mt-0.5" style={{ color: textMuted }}>
                                            Ticket analysis for TASK/RITM
                                          </p>
                                        </div>
                                      </div>
                                    </DropdownMenuItem>
                                    <DropdownMenuItem
                                      onClick={() => {
                                        switchToMode("csv");
                                        setModeDropdownOpen(false);
                                      }}
                                      className="px-3 py-2.5 rounded-lg cursor-pointer mt-1"
                                      style={{
                                        background: currentMode === "csv"
                                          ? (isDark ? "rgba(227,93,36,0.12)" : "rgba(227,93,36,0.1)")
                                          : "transparent",
                                      }}
                                      onMouseEnter={(e) => {
                                        if (currentMode !== "csv") {
                                          e.currentTarget.style.background = isDark ? `rgba(255,255,255,${opacityLight})` : `rgba(61,57,41,${opacityLight})`;
                                        }
                                      }}
                                      onMouseLeave={(e) => {
                                        if (currentMode !== "csv") {
                                          e.currentTarget.style.background = "transparent";
                                        }
                                      }}
                                    >
                                      <div className="flex items-center gap-3 w-full">
                                        <div
                                          className="p-1.5 rounded-lg shrink-0"
                                          style={{
                                            background: isDark ? "rgba(227,93,36,0.15)" : "rgba(227,93,36,0.12)",
                                          }}
                                        >
                                          <Download className="h-4 w-4" style={{ color: "#E35D24" }} />
                                        </div>
                                        <div className="flex-1 min-w-0">
                                          <div className="flex items-center gap-2">
                                            <span className="text-sm font-medium" style={{ color: textPrimary }}>CSV Generator</span>
                                            {currentMode === "csv" && (
                                              <Check className="h-3.5 w-3.5" style={{ color: "#E35D24" }} />
                                            )}
                                          </div>
                                          <p className="text-xs mt-0.5" style={{ color: textMuted }}>
                                            Export data to CSV format
                                          </p>
                                        </div>
                                      </div>
                                    </DropdownMenuItem>
                                  </>
                                );
                              })()}
                            </DropdownMenuContent>
                          </DropdownMenu>
                        </div>
                        {/* Textarea - Main input with auto-resize */}
                        <div className="flex-1 relative min-w-0">
                          <Textarea
                            ref={textareaRef}
                            placeholder="What would you like to explore?"
                            value={agentQuery}
                            onChange={(e) => {
                              setAgentQuery(e.target.value);
                              // Auto-resize will be handled by useEffect
                            }}
                            onFocus={() => {
                              setChatFocused(true);
                              setChatBarCollapsed(false);
                            }}
                            onBlur={() => setChatFocused(false)}
                            onKeyDown={(e) => {
                              if (e.key === "Enter" && !e.shiftKey && !agentLoading) {
                                e.preventDefault();
                                handleSubmit();
                              }
                              // Escape key to collapse
                              if (e.key === "Escape" && inputExpanded) {
                                e.preventDefault();
                                handleInputCollapse();
                              }
                            }}
                            disabled={agentLoading}
                            className="flex-1 resize-none border-0 bg-transparent focus:ring-0 focus-visible:ring-0 text-sm disabled:opacity-50 disabled:cursor-not-allowed"
                            style={{
                              color: textPrimary,
                              minHeight: "44px",
                              height: `${inputHeight}px`,
                              maxHeight: "200px",
                              paddingLeft: "12px",
                              paddingRight: "20px",
                              paddingTop: "14px",
                              paddingBottom: "14px",
                              fontSize: "15px",
                              lineHeight: "1.5",
                              overflowY: inputHeight >= 200 ? "auto" : "hidden",
                              transition: "height 0.2s ease-out, opacity 0.2s ease-out",
                            }}
                            rows={1}
                            aria-label="Message input"
                          />
                        </div>
                      </div>
                      <div className="flex items-center gap-2">

                        {/* Action Buttons - Right side */}
                        <div className="flex items-center gap-1.5 shrink-0" style={{ marginRight: "4px" }}>
                          {/* Send/Stop Button */}
                          {agentLoading ? (
                            <button
                              onClick={stopGeneration}
                              className="p-2.5 rounded-full transition-all focus:outline-none focus:ring-0"
                              style={{
                                background: isDark ? "rgba(239,68,68,0.12)" : "rgba(239,68,68,0.1)",
                                color: isDark ? "#FCA5A5" : "#DC2626",
                                border: "none",
                                boxShadow: "none",
                                transition: "all 0.2s ease-out",
                              }}
                              onMouseEnter={(e) => {
                                e.currentTarget.style.background = isDark ? "rgba(239,68,68,0.18)" : "rgba(239,68,68,0.15)";
                                e.currentTarget.style.boxShadow = "0 2px 8px rgba(239,68,68,0.2)";
                                e.currentTarget.style.transform = "scale(1.05)";
                              }}
                              onMouseLeave={(e) => {
                                e.currentTarget.style.background = isDark ? "rgba(239,68,68,0.12)" : "rgba(239,68,68,0.1)";
                                e.currentTarget.style.boxShadow = "none";
                                e.currentTarget.style.transform = "scale(1)";
                              }}
                              title="Stop generation"
                            >
                              <Square className="h-4 w-4" />
                            </button>
                          ) : (
                            <button
                              onClick={handleSubmit}
                              disabled={!agentQuery.trim() || isLoading}
                              className="p-2.5 rounded-full transition-all disabled:opacity-35 focus:outline-none focus:ring-0"
                              style={{
                                background: agentQuery.trim() ? "#E35D24" : (isDark ? `rgba(255,255,255,${opacityLight})` : `rgba(61,57,41,${opacityLight})`),
                                color: agentQuery.trim() ? "#fff" : textMuted,
                                border: "none",
                                boxShadow: "none",
                                transition: "all 0.2s ease-out",
                              }}
                              onMouseEnter={(e) => {
                                if (!e.currentTarget.disabled && agentQuery.trim()) {
                                  e.currentTarget.style.boxShadow = "0 2px 12px rgba(227,93,36,0.25)";
                                  e.currentTarget.style.transform = "scale(1.05)";
                                }
                              }}
                              onMouseLeave={(e) => {
                                e.currentTarget.style.boxShadow = "none";
                                e.currentTarget.style.transform = "scale(1)";
                              }}
                              title="Send message"
                            >
                              <Send className="h-4 w-4" />
                            </button>
                          )}
                        </div>
                      </div>
                    </div>
                  ) : activeMode === "ticket" ? (
                    <div className="flex flex-col gap-2">
                      <div className="flex items-center gap-1.5 pl-3">
                        {["TASK", "RITM"].map((m) => (
                          <button
                            key={m}
                            onClick={() => setTicketMode(m as "TASK" | "RITM")}
                            className="px-4 py-2 rounded-full text-xs font-medium transition-all focus:outline-none focus:ring-2 focus:ring-offset-0"
                            style={{
                              background: ticketMode === m
                                ? (isDark ? "rgba(227,93,36,0.08)" : "rgba(227,93,36,0.06)")
                                : (isDark ? "rgba(255,255,255,0.03)" : "rgba(61,57,41,0.03)"),
                              border: "none",
                              color: ticketMode === m ? "#E35D24" : textMuted,
                              boxShadow: "none",
                            }}
                            onMouseEnter={(e) => {
                              if (ticketMode !== m) {
                                e.currentTarget.style.background = isDark ? "rgba(255,255,255,0.05)" : "rgba(61,57,41,0.05)";
                                e.currentTarget.style.boxShadow = "0 1px 4px rgba(0,0,0,0.04)";
                              }
                            }}
                            onMouseLeave={(e) => {
                              if (ticketMode !== m) {
                                e.currentTarget.style.background = isDark ? "rgba(255,255,255,0.03)" : "rgba(61,57,41,0.03)";
                                e.currentTarget.style.boxShadow = "none";
                              }
                            }}
                            onMouseDown={(e) => {
                              e.currentTarget.style.boxShadow = "none";
                            }}
                            onMouseUp={(e) => {
                              if (ticketMode !== m) {
                                e.currentTarget.style.boxShadow = "0 1px 4px rgba(0,0,0,0.04)";
                              }
                            }}
                          >
                            {m === "TASK" ? "TASK (RTSK)" : "RITM"}
                          </button>
                        ))}
                      </div>
                      <div className="flex items-center gap-3">
                        {/* Input Container with Mode Selector as Prefix */}
                        <div className="flex-1 flex items-center min-h-[44px]">
                          {/* Mode Dropdown - Prefix Element */}
                          <div className="shrink-0 pl-2 pr-1.5 flex items-center">
                            <DropdownMenu open={modeDropdownOpen} onOpenChange={setModeDropdownOpen}>
                              <DropdownMenuTrigger asChild>
                                <button
                                  className="shrink-0 px-2 py-1 rounded-lg transition-all focus:outline-none flex items-center gap-1.5 text-xs font-medium"
                                  style={{
                                    background: isDark ? `rgba(255,255,255,0.06)` : `rgba(61,57,41,0.05)`,
                                    color: textMuted,
                                    border: "none",
                                    height: "28px",
                                    lineHeight: "1.5",
                                  }}
                                  onMouseEnter={(e) => {
                                    e.currentTarget.style.background = isDark ? `rgba(255,255,255,0.1)` : `rgba(61,57,41,0.08)`;
                                    e.currentTarget.style.color = textPrimary;
                                  }}
                                  onMouseLeave={(e) => {
                                    e.currentTarget.style.background = isDark ? `rgba(255,255,255,0.06)` : `rgba(61,57,41,0.05)`;
                                    e.currentTarget.style.color = textMuted;
                                  }}
                                  onClick={(e) => {
                                    e.stopPropagation();
                                  }}
                                >
                                  <div className="shrink-0 w-3.5 h-3.5 flex items-center justify-center">
                                    <FileText className="h-3 w-3" style={{ display: "block" }} />
                                  </div>
                                  <span style={{ lineHeight: "1.5" }}>Ticket Analyser</span>
                                  <ChevronDown className="h-2.5 w-2.5 shrink-0" />
                                </button>
                              </DropdownMenuTrigger>
                              <DropdownMenuContent
                                align="start"
                                className="w-64 p-2"
                                style={{
                                  background: bgSurface,
                                  border: `1px solid ${borderColor}`,
                                  boxShadow: isDark
                                    ? "0 8px 32px rgba(0,0,0,0.24), 0 0 0 1px rgba(255,255,255,0.08)"
                                    : "0 8px 32px rgba(61,57,41,0.12), 0 0 0 1px rgba(61,57,41,0.08)",
                                }}
                              >
                                <DropdownMenuLabel className="px-3 py-2 text-xs font-semibold" style={{ color: textMuted }}>
                                  Select Mode
                                </DropdownMenuLabel>
                                <DropdownMenuSeparator style={{ background: borderColor, margin: "4px 0" }} />
                                {(() => {
                                  const currentMode: ActiveMode = activeMode as ActiveMode; // Type assertion to avoid narrowing
                                  return (
                                    <>
                                      <DropdownMenuItem
                                        onClick={() => {
                                          switchToMode("agent");
                                          setModeDropdownOpen(false);
                                        }}
                                        className="px-3 py-2.5 rounded-lg cursor-pointer"
                                        style={{
                                          background: currentMode === "agent"
                                            ? (isDark ? "rgba(227,93,36,0.12)" : "rgba(227,93,36,0.1)")
                                            : "transparent",
                                        }}
                                        onMouseEnter={(e) => {
                                          if (currentMode !== "agent") {
                                            e.currentTarget.style.background = isDark ? `rgba(255,255,255,${opacityLight})` : `rgba(61,57,41,${opacityLight})`;
                                          }
                                        }}
                                        onMouseLeave={(e) => {
                                          if (currentMode !== "agent") {
                                            e.currentTarget.style.background = "transparent";
                                          }
                                        }}
                                      >
                                        <div className="flex items-center gap-3 w-full">
                                          <div
                                            className="p-1.5 rounded-lg shrink-0"
                                            style={{
                                              background: isDark ? "rgba(227,93,36,0.15)" : "rgba(227,93,36,0.12)",
                                            }}
                                          >
                                            <Sparkles className="h-4 w-4" style={{ color: "#E35D24" }} />
                                          </div>
                                          <div className="flex-1 min-w-0">
                                            <div className="flex items-center gap-2">
                                              <span className="text-sm font-medium" style={{ color: textPrimary }}>Agent Mode</span>
                                              {currentMode === "agent" && (
                                                <Check className="h-3.5 w-3.5" style={{ color: "#E35D24" }} />
                                              )}
                                            </div>
                                            <p className="text-xs mt-0.5" style={{ color: textMuted }}>
                                              AI-powered query and analysis
                                            </p>
                                          </div>
                                        </div>
                                      </DropdownMenuItem>
                                      <DropdownMenuItem
                                        onClick={() => {
                                          switchToMode("ticket");
                                          setModeDropdownOpen(false);
                                        }}
                                        className="px-3 py-2.5 rounded-lg cursor-pointer mt-1"
                                        style={{
                                          background: currentMode === "ticket"
                                            ? (isDark ? "rgba(227,93,36,0.12)" : "rgba(227,93,36,0.1)")
                                            : "transparent",
                                        }}
                                        onMouseEnter={(e) => {
                                          if (currentMode !== "ticket") {
                                            e.currentTarget.style.background = isDark ? `rgba(255,255,255,${opacityLight})` : `rgba(61,57,41,${opacityLight})`;
                                          }
                                        }}
                                        onMouseLeave={(e) => {
                                          if (currentMode !== "ticket") {
                                            e.currentTarget.style.background = "transparent";
                                          }
                                        }}
                                      >
                                        <div className="flex items-center gap-3 w-full">
                                          <div
                                            className="p-1.5 rounded-lg shrink-0"
                                            style={{
                                              background: isDark ? "rgba(227,93,36,0.15)" : "rgba(227,93,36,0.12)",
                                            }}
                                          >
                                            <FileText className="h-4 w-4" style={{ color: "#E35D24" }} />
                                          </div>
                                          <div className="flex-1 min-w-0">
                                            <div className="flex items-center gap-2">
                                              <span className="text-sm font-medium" style={{ color: textPrimary }}>Ticket Analyser</span>
                                              {currentMode === "ticket" && (
                                                <Check className="h-3.5 w-3.5" style={{ color: "#E35D24" }} />
                                              )}
                                            </div>
                                            <p className="text-xs mt-0.5" style={{ color: textMuted }}>
                                              Ticket analysis for TASK/RITM
                                            </p>
                                          </div>
                                        </div>
                                      </DropdownMenuItem>
                                      <DropdownMenuItem
                                        onClick={() => {
                                          switchToMode("csv");
                                          setModeDropdownOpen(false);
                                        }}
                                        className="px-3 py-2.5 rounded-lg cursor-pointer mt-1"
                                        style={{
                                          background: currentMode === "csv"
                                            ? (isDark ? "rgba(227,93,36,0.12)" : "rgba(227,93,36,0.1)")
                                            : "transparent",
                                        }}
                                        onMouseEnter={(e) => {
                                          if (currentMode !== "csv") {
                                            e.currentTarget.style.background = isDark ? `rgba(255,255,255,${opacityLight})` : `rgba(61,57,41,${opacityLight})`;
                                          }
                                        }}
                                        onMouseLeave={(e) => {
                                          if (currentMode !== "csv") {
                                            e.currentTarget.style.background = "transparent";
                                          }
                                        }}
                                      >
                                        <div className="flex items-center gap-3 w-full">
                                          <div
                                            className="p-1.5 rounded-lg shrink-0"
                                            style={{
                                              background: isDark ? "rgba(227,93,36,0.15)" : "rgba(227,93,36,0.12)",
                                            }}
                                          >
                                            <Download className="h-4 w-4" style={{ color: "#E35D24" }} />
                                          </div>
                                          <div className="flex-1 min-w-0">
                                            <div className="flex items-center gap-2">
                                              <span className="text-sm font-medium" style={{ color: textPrimary }}>CSV Generator</span>
                                              {currentMode === "csv" && (
                                                <Check className="h-3.5 w-3.5" style={{ color: "#E35D24" }} />
                                              )}
                                            </div>
                                            <p className="text-xs mt-0.5" style={{ color: textMuted }}>
                                              Export data to CSV format
                                            </p>
                                          </div>
                                        </div>
                                      </DropdownMenuItem>
                                    </>
                                  );
                                })()}
                              </DropdownMenuContent>
                            </DropdownMenu>
                          </div>
                          {/* Input Field */}
                          <div className="flex-1 relative min-w-0">
                            <Input
                              ref={inputRef}
                              placeholder="Enter a ticket ID to begin analysis"
                              value={ticketMode === "TASK" ? taskNumber : ritmNumber}
                              onChange={(e) => ticketMode === "TASK" ? setTaskNumber(e.target.value) : setRitmNumber(e.target.value)}
                              onFocus={() => {
                                setChatFocused(true);
                                setChatBarCollapsed(false);
                              }}
                              onBlur={() => setChatFocused(false)}
                              onKeyDown={(e) => {
                                if (e.key === "Enter") handleSubmit();
                              }}
                              className="flex-1 border-0 bg-transparent focus:ring-0 focus-visible:ring-0 text-sm disabled:opacity-50 disabled:cursor-not-allowed"
                              style={{
                                color: textPrimary,
                                paddingLeft: "12px",
                                paddingRight: "20px",
                                paddingTop: "14px",
                                paddingBottom: "14px",
                              }}
                            />
                          </div>
                        </div>
                        <div className="flex items-center gap-1.5 shrink-0" style={{ marginRight: "4px" }}>
                          <button
                            onClick={handleSubmit}
                            disabled={isLoading || !(ticketMode === "TASK" ? taskNumber : ritmNumber).trim()}
                            className="p-2.5 rounded-full transition-all disabled:opacity-35 focus:outline-none focus:ring-0"
                            style={{
                              background: (ticketMode === "TASK" ? taskNumber : ritmNumber).trim() ? "#E35D24" : (isDark ? `rgba(255,255,255,${opacityLight})` : `rgba(61,57,41,${opacityLight})`),
                              color: (ticketMode === "TASK" ? taskNumber : ritmNumber).trim() ? "#fff" : textMuted,
                              border: "none",
                              boxShadow: "none",
                              transition: "all 0.2s ease-out",
                            }}
                            onMouseEnter={(e) => {
                              if (!e.currentTarget.disabled && (ticketMode === "TASK" ? taskNumber : ritmNumber).trim()) {
                                e.currentTarget.style.boxShadow = "0 2px 12px rgba(227,93,36,0.25)";
                                e.currentTarget.style.transform = "scale(1.05)";
                              }
                            }}
                            onMouseLeave={(e) => {
                              e.currentTarget.style.boxShadow = "none";
                              e.currentTarget.style.transform = "scale(1)";
                            }}
                            title="Generate RCA"
                          >
                            <Send className="h-4 w-4" />
                          </button>
                        </div>
                      </div>
                    </div>
                  ) : activeMode === "csv" ? (
                    <div className="flex items-center gap-2">
                      {/* Input Container with Mode Selector as Prefix */}
                      <div className="flex-1 flex items-center min-h-[44px]">
                        {/* Mode Dropdown - Prefix Element */}
                        <div className="shrink-0 pl-2 pr-1.5 flex items-center">
                          <DropdownMenu open={modeDropdownOpen} onOpenChange={setModeDropdownOpen}>
                            <DropdownMenuTrigger asChild>
                              <button
                                className="shrink-0 px-2 py-1 rounded-lg transition-all focus:outline-none flex items-center gap-1.5 text-xs font-medium"
                                style={{
                                  background: isDark ? `rgba(255,255,255,0.06)` : `rgba(61,57,41,0.05)`,
                                  color: textMuted,
                                  border: "none",
                                  height: "28px",
                                  lineHeight: "1.5",
                                }}
                                onMouseEnter={(e) => {
                                  e.currentTarget.style.background = isDark ? `rgba(255,255,255,0.1)` : `rgba(61,57,41,0.08)`;
                                  e.currentTarget.style.color = textPrimary;
                                }}
                                onMouseLeave={(e) => {
                                  e.currentTarget.style.background = isDark ? `rgba(255,255,255,0.06)` : `rgba(61,57,41,0.05)`;
                                  e.currentTarget.style.color = textMuted;
                                }}
                                onClick={(e) => {
                                  e.stopPropagation();
                                }}
                              >
                                <div className="shrink-0 w-3.5 h-3.5 flex items-center justify-center">
                                  <Download className="h-3 w-3" style={{ display: "block" }} />
                                </div>
                                <span style={{ lineHeight: "1.5" }}>CSV Generator</span>
                                <ChevronDown className="h-2.5 w-2.5 shrink-0" />
                              </button>
                            </DropdownMenuTrigger>
                            <DropdownMenuContent
                              align="start"
                              className="w-64 p-2"
                              style={{
                                background: bgSurface,
                                border: `1px solid ${borderColor}`,
                                boxShadow: isDark
                                  ? "0 8px 32px rgba(0,0,0,0.24), 0 0 0 1px rgba(255,255,255,0.08)"
                                  : "0 8px 32px rgba(61,57,41,0.12), 0 0 0 1px rgba(61,57,41,0.08)",
                              }}
                            >
                              <DropdownMenuLabel className="px-3 py-2 text-xs font-semibold" style={{ color: textMuted }}>
                                Select Mode
                              </DropdownMenuLabel>
                              <DropdownMenuSeparator style={{ background: borderColor, margin: "4px 0" }} />
                              {(() => {
                                const currentMode: ActiveMode = activeMode as ActiveMode;
                                return (
                                  <>
                                    <DropdownMenuItem
                                      onClick={() => {
                                        switchToMode("agent");
                                        setModeDropdownOpen(false);
                                      }}
                                      className="px-3 py-2.5 rounded-lg cursor-pointer"
                                      style={{
                                        background: currentMode === "agent"
                                          ? (isDark ? "rgba(227,93,36,0.12)" : "rgba(227,93,36,0.1)")
                                          : "transparent",
                                      }}
                                    >
                                      <div className="flex items-center gap-3 w-full">
                                        <div className="p-1.5 rounded-lg shrink-0" style={{ background: isDark ? "rgba(227,93,36,0.15)" : "rgba(227,93,36,0.12)" }}>
                                          <Sparkles className="h-4 w-4" style={{ color: "#E35D24" }} />
                                        </div>
                                        <div className="flex-1 min-w-0">
                                          <div className="flex items-center gap-2">
                                            <span className="text-sm font-medium" style={{ color: textPrimary }}>Agent Mode</span>
                                            {currentMode === "agent" && (<Check className="h-3.5 w-3.5" style={{ color: "#E35D24" }} />)}
                                          </div>
                                          <p className="text-xs mt-0.5" style={{ color: textMuted }}>AI-powered query and analysis</p>
                                        </div>
                                      </div>
                                    </DropdownMenuItem>
                                    <DropdownMenuItem
                                      onClick={() => {
                                        switchToMode("ticket");
                                        setModeDropdownOpen(false);
                                      }}
                                      className="px-3 py-2.5 rounded-lg cursor-pointer mt-1"
                                      style={{
                                        background: currentMode === "ticket"
                                          ? (isDark ? "rgba(227,93,36,0.12)" : "rgba(227,93,36,0.1)")
                                          : "transparent",
                                      }}
                                    >
                                      <div className="flex items-center gap-3 w-full">
                                        <div className="p-1.5 rounded-lg shrink-0" style={{ background: isDark ? "rgba(227,93,36,0.15)" : "rgba(227,93,36,0.12)" }}>
                                          <FileText className="h-4 w-4" style={{ color: "#E35D24" }} />
                                        </div>
                                        <div className="flex-1 min-w-0">
                                          <div className="flex items-center gap-2">
                                            <span className="text-sm font-medium" style={{ color: textPrimary }}>Ticket Analyser</span>
                                            {currentMode === "ticket" && (<Check className="h-3.5 w-3.5" style={{ color: "#E35D24" }} />)}
                                          </div>
                                          <p className="text-xs mt-0.5" style={{ color: textMuted }}>Ticket analysis for TASK/RITM</p>
                                        </div>
                                      </div>
                                    </DropdownMenuItem>
                                    <DropdownMenuItem
                                      onClick={() => {
                                        switchToMode("csv");
                                        setModeDropdownOpen(false);
                                      }}
                                      className="px-3 py-2.5 rounded-lg cursor-pointer mt-1"
                                      style={{
                                        background: currentMode === "csv"
                                          ? (isDark ? "rgba(227,93,36,0.12)" : "rgba(227,93,36,0.1)")
                                          : "transparent",
                                      }}
                                    >
                                      <div className="flex items-center gap-3 w-full">
                                        <div className="p-1.5 rounded-lg shrink-0" style={{ background: isDark ? "rgba(227,93,36,0.15)" : "rgba(227,93,36,0.12)" }}>
                                          <Download className="h-4 w-4" style={{ color: "#E35D24" }} />
                                        </div>
                                        <div className="flex-1 min-w-0">
                                          <div className="flex items-center gap-2">
                                            <span className="text-sm font-medium" style={{ color: textPrimary }}>CSV Generator</span>
                                            {currentMode === "csv" && (<Check className="h-3.5 w-3.5" style={{ color: "#E35D24" }} />)}
                                          </div>
                                          <p className="text-xs mt-0.5" style={{ color: textMuted }}>Export data to CSV format</p>
                                        </div>
                                      </div>
                                    </DropdownMenuItem>
                                  </>
                                );
                              })()}
                            </DropdownMenuContent>
                          </DropdownMenu>
                        </div>
                        {/* Input Field */}
                        <div className="flex-1 relative min-w-0">
                          <Input
                            placeholder="Enter query to generate CSV..."
                            value={csvQuery}
                            onChange={(e) => setCsvQuery(e.target.value)}
                            onFocus={() => {
                              setChatFocused(true);
                              setChatBarCollapsed(false);
                            }}
                            onBlur={() => setChatFocused(false)}
                            onKeyDown={(e) => {
                              if (e.key === "Enter") handleSubmit();
                            }}
                            className="flex-1 border-0 bg-transparent focus:ring-0 focus-visible:ring-0 text-sm disabled:opacity-50 disabled:cursor-not-allowed"
                            style={{
                              color: textPrimary,
                              paddingLeft: "12px",
                              paddingRight: "20px",
                              paddingTop: "14px",
                              paddingBottom: "14px",
                            }}
                          />
                        </div>
                      </div>
                      <div className="flex items-center gap-1.5 shrink-0" style={{ marginRight: "4px" }}>
                        <button
                          onClick={handleSubmit}
                          disabled={csvLoading || !csvQuery.trim()}
                          className="p-2.5 rounded-full transition-all disabled:opacity-35 focus:outline-none focus:ring-0"
                          style={{
                            background: csvQuery.trim() ? "#E35D24" : (isDark ? `rgba(255,255,255,${opacityLight})` : `rgba(61,57,41,${opacityLight})`),
                            color: csvQuery.trim() ? "#fff" : textMuted,
                            border: "none",
                            boxShadow: "none",
                            transition: "all 0.2s ease-out",
                          }}
                          onMouseEnter={(e) => {
                            if (!e.currentTarget.disabled && csvQuery.trim()) {
                              e.currentTarget.style.boxShadow = "0 2px 12px rgba(227,93,36,0.25)";
                              e.currentTarget.style.transform = "scale(1.05)";
                            }
                          }}
                          onMouseLeave={(e) => {
                            e.currentTarget.style.boxShadow = "none";
                            e.currentTarget.style.transform = "scale(1)";
                          }}
                          title="Generate CSV"
                        >
                          <Download className="h-4 w-4" />
                        </button>
                      </div>
                    </div>
                  ) : null}
                </div>
              </motion.div>
            </div>
          </div>
        )}
      </div>

      {/* Right Insights Panel - Copilot Style (Only visible in Agent mode) */}
      <AnimatePresence>
        {activeMode === "agent" && rightPanelOpen && conversation.length > 0 && (
          <motion.aside
            ref={insightsPanelRef}
            initial="closed"
            animate="open"
            exit="closed"
            variants={{
              open: {
                width: `${insightsPanelWidth}px`,
                opacity: 1,
                transition: {
                  duration: 0.24,
                  ease: [0.4, 0, 0.2, 1]
                }
              },
              closed: {
                width: 0,
                opacity: 0,
                transition: {
                  duration: 0.24,
                  ease: [0.4, 0, 0.2, 1]
                }
              }
            }}
            className="h-full overflow-hidden shrink-0"
            style={{
              borderLeft: `1px solid ${borderColor}`,
              background: isDark ? "#121210" : "#F5F0E8",
              minWidth: 0,
              maxWidth: '560px',
              willChange: 'width, opacity',
              contain: 'layout style paint'
            }}
          >
            {/* Resize Handle */}
            <div
              ref={resizeHandleRef}
              onMouseDown={(e) => {
                e.preventDefault();
                setIsResizing(true);
              }}
              className="cursor-col-resize hover:bg-opacity-20 transition-colors z-10 absolute left-0 top-0"
              style={{
                width: '4px',
                height: '100%',
                background: isResizing ? borderColor : 'transparent',
              }}
            />
            <div className="h-full flex flex-col">
              <div className="flex items-center justify-between px-5 h-14 shrink-0" style={{ borderBottom: `1px solid ${borderColor}` }}>
                <div className="flex items-center gap-2.5">
                  <BarChart3 className="h-4 w-4" style={{ color: "#E35D24" }} />
                  <span className="text-sm font-medium" style={{ color: textPrimary }}>Insights</span>
                  {activeVizData?.chart_type && (
                    <Badge variant="outline" className="ml-1 text-xs" style={{ borderColor, color: textMuted }}>{activeVizData.chart_type.toUpperCase()}</Badge>
                  )}
                </div>
                <button
                  onClick={() => setRightPanelOpen(false)}
                  className="p-1.5 rounded-lg transition-colors hover:bg-opacity-10"
                  style={{
                    color: textMuted,
                    background: isDark ? `rgba(255,255,255,${opacitySubtle})` : `rgba(61,57,41,${opacitySubtle})`
                  }}
                  title="Hide Insights"
                >
                  <PanelRightClose className="h-4 w-4" />
                </button>
              </div>
              <div className="flex-1 overflow-y-auto" style={{ padding: '24px' }}>
                {(() => {
                  const chartDataForRender = activeVizData || agentData;
                  const finalOption: any = chartOption || chartDataForRender?.chart_spec;
                  const isPieChart = chartDataForRender?.chart_type === "pie";
                  const isBarChart = chartDataForRender?.chart_type === "bar" || chartDataForRender?.chart_type === "column";
                  const isLineChart = chartDataForRender?.chart_type === "line";

                  // Extract series data for interactive legend
                  const seriesData: Array<{ name: string; color: string; visible: boolean }> = [];
                  if (finalOption?.series) {
                    const colors = finalOption.color || ["#2A9D8F", "#E8704F", "#C85A5A", "#4A90E2", "#F5A623"];
                    finalOption.series.forEach((s: any, idx: number) => {
                      const seriesName = s.name || `Series ${idx + 1}`;
                      const isHidden = hiddenSeries.has(seriesName);
                      const isIsolated = isolatedSeries !== null && isolatedSeries !== seriesName;
                      seriesData.push({
                        name: seriesName,
                        color: s.itemStyle?.color || colors[idx % colors.length],
                        visible: !isHidden && !isIsolated
                      });
                    });
                  }

                  // Extract legend data for pie charts (use original data, not filtered)
                  let pieLegendData: Array<{ name: string; value: number; percentage: number; color: string }> = [];
                  const chartDataForPie = activeVizData || agentData;
                  if (isPieChart && chartDataForPie?.chart_spec?.series?.[0]?.data) {
                    const pieData = chartDataForPie.chart_spec.series[0].data;
                    const total = pieData.reduce((sum: number, item: any) => sum + (item.value || 0), 0);
                    const colors = chartDataForPie.chart_spec.color || finalOption?.color || ["#2A9D8F", "#E8704F", "#C85A5A"];
                    pieLegendData = pieData.map((item: any, idx: number) => ({
                      name: item.name || '',
                      value: item.value || 0,
                      percentage: total > 0 ? Math.round((item.value / total) * 100) : 0,
                      color: item.itemStyle?.color || colors[idx % colors.length]
                    }));
                  }

                  // Check if we have a visualization to show
                  const chartDataForCheck = activeVizData || agentData;
                  const hasVisualization = chartDataForCheck?.needs_visualization && chartDataForCheck?.chart_spec;

                  // Show message when no visualization
                  if (!hasVisualization || !finalOption || !finalOption.series || finalOption.series.length === 0) {
                    // Show loading skeleton only if we're actively loading
                    if (agentLoading && !hasVisualization) {
                      return (
                        <div
                          className="flex flex-col items-center justify-center"
                          style={{
                            width: "100%",
                            height: '200px',
                            color: textMuted,
                            gap: '12px'
                          }}
                        >
                          <div className="animate-pulse flex flex-col items-center gap-3 w-full">
                            <div
                              style={{
                                width: '100%',
                                height: '120px',
                                background: isDark ? "rgba(255,255,255,0.02)" : "rgba(61,57,41,0.02)",
                                borderRadius: '8px'
                              }}
                            />
                          </div>
                          <span className="text-xs" style={{ color: textMuted }}>Loading insights...</span>
                        </div>
                      );
                    }

                    // Show "no visualization" message when not loading
                    return (
                      <div
                        className="flex flex-col items-center justify-center"
                        style={{
                          width: "100%",
                          height: '100%',
                          minHeight: '300px',
                          color: textMuted,
                          gap: '16px'
                        }}
                      >
                        <BarChart3
                          className="h-12 w-12"
                          style={{
                            color: textMuted,
                            opacity: 0.3
                          }}
                        />
                        <div className="flex flex-col items-center gap-2">
                          <span className="text-sm font-medium" style={{ color: textPrimary }}>No Visualization to Show</span>
                          <span className="text-xs text-center max-w-xs" style={{ color: textMuted }}>
                            Ask a question that requires data visualization to see charts and insights here.
                          </span>
                        </div>
                      </div>
                    );
                  }

                  return (
                    <div className="space-y-5">
                      {/* Chart Container - Primary Visualization */}
                      <div className="space-y-2.5">
                        <div className="flex items-center justify-between">
                          <div className="flex items-center gap-2">
                            <BarChart3 className="h-4 w-4" style={{ color: textMuted }} />
                            <h3 className="text-sm font-medium" style={{ color: textPrimary }}>Visualization</h3>
                          </div>
                          <div className="flex items-center gap-1.5">
                            {/* Download Button */}
                            <button
                              onClick={() => {
                                if (chartRef.current) {
                                  try {
                                    const instance = chartRef.current.getEchartsInstance();
                                    if (instance) {
                                      const url = instance.getDataURL({
                                        type: 'png',
                                        pixelRatio: 2,
                                        backgroundColor: isDark ? '#121210' : '#F5F0E8'
                                      });
                                      const link = document.createElement('a');
                                      link.download = `sre-intelligence-chart-${Date.now()}.png`;
                                      link.href = url;
                                      link.click();
                                      toast.success("Chart downloaded successfully");
                                    }
                                  } catch (error) {
                                    console.error("Error downloading chart:", error);
                                    toast.error("Failed to download chart");
                                  }
                                }
                              }}
                              className="p-1.5 rounded-lg transition-all duration-150 ease-out"
                              style={{
                                color: textMuted,
                                background: 'transparent',
                              }}
                              onMouseEnter={(e) => {
                                e.currentTarget.style.background = isDark ? `rgba(255,255,255,0.08)` : `rgba(61,57,41,0.08)`;
                                e.currentTarget.style.transform = "translateY(-1px)";
                              }}
                              onMouseLeave={(e) => {
                                e.currentTarget.style.background = "transparent";
                                e.currentTarget.style.transform = "translateY(0)";
                              }}
                              title="Download chart"
                              aria-label="Download chart"
                            >
                              <Download className="h-4 w-4" />
                            </button>
                            {/* Fullscreen Button */}
                            <button
                              onClick={() => setChartFullscreen(true)}
                              className="p-1.5 rounded-lg transition-all duration-150 ease-out"
                              style={{
                                color: textMuted,
                                background: 'transparent',
                              }}
                              onMouseEnter={(e) => {
                                e.currentTarget.style.background = isDark ? `rgba(255,255,255,0.08)` : `rgba(61,57,41,0.08)`;
                                e.currentTarget.style.transform = "translateY(-1px)";
                              }}
                              onMouseLeave={(e) => {
                                e.currentTarget.style.background = "transparent";
                                e.currentTarget.style.transform = "translateY(0)";
                              }}
                              title="View in fullscreen"
                              aria-label="View in fullscreen"
                            >
                              <Maximize2 className="h-4 w-4" />
                            </button>
                          </div>
                        </div>
                        <div
                          className="rounded-xl"
                          style={{
                            background: isDark ? "rgba(255,255,255,0.04)" : "rgba(61,57,41,0.04)",
                            border: `1px solid ${borderColor}`,
                            padding: '20px',
                            position: "relative",
                            width: "100%",
                          }}
                        >
                          <div
                            ref={chartContainerRef}
                            style={{
                              width: "100%",
                              height: isPieChart ? "280px" : "240px",
                              minHeight: isPieChart ? "280px" : "240px",
                              position: "relative" as const,
                            }}
                          >
                            <ReactECharts
                              key={`chart-${chartKey}-${chartDataForRender?.chart_type || 'default'}`}
                              ref={chartRef}
                              option={finalOption}
                              style={{
                                height: "100%",
                                width: "100%",
                                display: "block"
                              }}
                              opts={{
                                renderer: "canvas",
                                devicePixelRatio: Math.min(window.devicePixelRatio || 1, 2),
                                locale: 'en'
                              }}
                              notMerge={true}
                              lazyUpdate={false}
                              onEvents={{
                                mouseover: (params: any) => {
                                  setHoveredElement(params);
                                },
                                mouseout: () => {
                                  setHoveredElement(null);
                                }
                              }}
                              onChartReady={(chart: any) => {
                                if (chart && chart.resize) {
                                  requestAnimationFrame(() => chart.resize());
                                  setTimeout(() => chart.resize(), 50);
                                  setTimeout(() => chart.resize(), 150);
                                  setTimeout(() => chart.resize(), 300);
                                }
                              }}
                            />
                          </div>
                        </div>
                      </div>

                      {/* Dynamic Insights Section */}
                      <div className="space-y-3">
                        <div className="flex items-center gap-2">
                          <Brain className="h-4 w-4" style={{ color: "#E35D24" }} />
                          <h3 className="text-sm font-medium" style={{ color: textPrimary }}>Insights</h3>
                        </div>
                        <div className="space-y-2.5">
                          {currentInsights.length > 0 ? (
                            currentInsights.map((insight, idx) => (
                              <motion.div
                                key={idx}
                                initial={{ opacity: 0, y: 4 }}
                                animate={{ opacity: 1, y: 0 }}
                                transition={{ delay: idx * 0.05 }}
                                className="text-sm leading-relaxed"
                                style={{
                                  color: textPrimary,
                                  padding: '12px',
                                  background: isDark ? "rgba(255,255,255,0.03)" : "rgba(61,57,41,0.03)",
                                  borderRadius: '8px',
                                  border: `1px solid ${isDark ? "rgba(255,255,255,0.05)" : "rgba(61,57,41,0.05)"}`
                                }}
                              >
                                {insight}
                              </motion.div>
                            ))
                          ) : (
                            <div className="text-sm" style={{ color: textMuted }}>
                              Analyzing chart data...
                            </div>
                          )}
                        </div>
                      </div>

                      {/* Analysis Actions */}
                      <div className="space-y-2.5">
                        <div className="flex items-center gap-2">
                          <Zap className="h-4 w-4" style={{ color: textMuted }} />
                          <h3 className="text-sm font-medium" style={{ color: textPrimary }}>Analysis</h3>
                        </div>
                        <div className="flex flex-wrap gap-2">
                          <button
                            onClick={() => setInsightContext(insightContext === "comparison" ? "default" : "comparison")}
                            className="text-xs px-3 py-1.5 rounded-lg transition-all"
                            style={{
                              background: insightContext === "comparison"
                                ? (isDark ? "rgba(227,93,36,0.15)" : "rgba(227,93,36,0.12)")
                                : (isDark ? "rgba(255,255,255,0.05)" : "rgba(61,57,41,0.05)"),
                              color: insightContext === "comparison" ? "#E35D24" : textPrimary,
                              border: `1px solid ${insightContext === "comparison" ? "rgba(227,93,36,0.3)" : borderColor}`,
                              cursor: "pointer"
                            }}
                            onMouseEnter={(e) => {
                              if (insightContext !== "comparison") {
                                e.currentTarget.style.background = isDark ? "rgba(255,255,255,0.08)" : "rgba(61,57,41,0.08)";
                              }
                            }}
                            onMouseLeave={(e) => {
                              if (insightContext !== "comparison") {
                                e.currentTarget.style.background = isDark ? "rgba(255,255,255,0.05)" : "rgba(61,57,41,0.05)";
                              }
                            }}
                          >
                            Compare periods
                          </button>
                          <button
                            onClick={() => setInsightContext(insightContext === "anomaly" ? "default" : "anomaly")}
                            className="text-xs px-3 py-1.5 rounded-lg transition-all"
                            style={{
                              background: insightContext === "anomaly"
                                ? (isDark ? "rgba(227,93,36,0.15)" : "rgba(227,93,36,0.12)")
                                : (isDark ? "rgba(255,255,255,0.05)" : "rgba(61,57,41,0.05)"),
                              color: insightContext === "anomaly" ? "#E35D24" : textPrimary,
                              border: `1px solid ${insightContext === "anomaly" ? "rgba(227,93,36,0.3)" : borderColor}`,
                              cursor: "pointer"
                            }}
                            onMouseEnter={(e) => {
                              if (insightContext !== "anomaly") {
                                e.currentTarget.style.background = isDark ? "rgba(255,255,255,0.08)" : "rgba(61,57,41,0.08)";
                              }
                            }}
                            onMouseLeave={(e) => {
                              if (insightContext !== "anomaly") {
                                e.currentTarget.style.background = isDark ? "rgba(255,255,255,0.05)" : "rgba(61,57,41,0.05)";
                              }
                            }}
                          >
                            Explain spike
                          </button>
                          <button
                            onClick={() => setInsightContext(insightContext === "trend" ? "default" : "trend")}
                            className="text-xs px-3 py-1.5 rounded-lg transition-all"
                            style={{
                              background: insightContext === "trend"
                                ? (isDark ? "rgba(227,93,36,0.15)" : "rgba(227,93,36,0.12)")
                                : (isDark ? "rgba(255,255,255,0.05)" : "rgba(61,57,41,0.05)"),
                              color: insightContext === "trend" ? "#E35D24" : textPrimary,
                              border: `1px solid ${insightContext === "trend" ? "rgba(227,93,36,0.3)" : borderColor}`,
                              cursor: "pointer"
                            }}
                            onMouseEnter={(e) => {
                              if (insightContext !== "trend") {
                                e.currentTarget.style.background = isDark ? "rgba(255,255,255,0.08)" : "rgba(61,57,41,0.08)";
                              }
                            }}
                            onMouseLeave={(e) => {
                              if (insightContext !== "trend") {
                                e.currentTarget.style.background = isDark ? "rgba(255,255,255,0.05)" : "rgba(61,57,41,0.05)";
                              }
                            }}
                          >
                            Why did this change?
                          </button>
                        </div>
                      </div>

                      {/* Interactive Legend */}
                      {(seriesData.length > 0 || pieLegendData.length > 0) && (
                        <div className="space-y-2.5">
                          <div className="flex items-center gap-2">
                            <BarChart3 className="h-4 w-4" style={{ color: textMuted }} />
                            <h3 className="text-sm font-medium" style={{ color: textPrimary }}>Metrics</h3>
                          </div>
                          <div className="space-y-1.5">
                            {(isPieChart ? pieLegendData : seriesData).map((item, idx) => {
                              const isHidden = hiddenSeries.has(item.name);
                              const isIsolated = isolatedSeries === item.name;
                              return (
                                <div
                                  key={idx}
                                  className="flex items-center gap-2.5 group cursor-pointer"
                                  onClick={() => {
                                    if (isolatedSeries === item.name) {
                                      setIsolatedSeries(null);
                                    } else if (hiddenSeries.has(item.name)) {
                                      setHiddenSeries(prev => {
                                        const next = new Set(prev);
                                        next.delete(item.name);
                                        return next;
                                      });
                                    } else {
                                      setHiddenSeries(prev => new Set(prev).add(item.name));
                                    }
                                  }}
                                  onContextMenu={(e) => {
                                    e.preventDefault();
                                    if (isolatedSeries === item.name) {
                                      setIsolatedSeries(null);
                                    } else {
                                      setIsolatedSeries(item.name);
                                      setHiddenSeries(new Set());
                                    }
                                  }}
                                  style={{
                                    padding: '8px 10px',
                                    borderRadius: '6px',
                                    background: isIsolated
                                      ? (isDark ? "rgba(227,93,36,0.12)" : "rgba(227,93,36,0.1)")
                                      : (isDark ? "rgba(255,255,255,0.02)" : "rgba(61,57,41,0.02)"),
                                    opacity: isHidden ? 0.4 : 1,
                                    transition: "all 0.2s ease"
                                  }}
                                  onMouseEnter={(e) => {
                                    if (!isIsolated) {
                                      e.currentTarget.style.background = isDark ? "rgba(255,255,255,0.05)" : "rgba(61,57,41,0.05)";
                                    }
                                  }}
                                  onMouseLeave={(e) => {
                                    if (!isIsolated) {
                                      e.currentTarget.style.background = isDark ? "rgba(255,255,255,0.02)" : "rgba(61,57,41,0.02)";
                                    }
                                  }}
                                  title={isIsolated ? "Click to show all | Right-click to isolate" : isHidden ? "Click to show" : "Click to hide | Right-click to isolate"}
                                >
                                  <div
                                    style={{
                                      width: '8px',
                                      height: '8px',
                                      borderRadius: '50%',
                                      background: item.color,
                                      flexShrink: 0,
                                      opacity: isHidden ? 0.3 : 1
                                    }}
                                  />
                                  <span
                                    className="text-sm flex-1"
                                    style={{
                                      color: isIsolated ? "#E35D24" : textPrimary,
                                      fontWeight: isIsolated ? 500 : 400,
                                      textDecoration: isHidden ? "line-through" : "none"
                                    }}
                                  >
                                    {item.name}
                                    {isPieChart && 'value' in item && (
                                      <> â€” {item.value.toLocaleString()} ({item.percentage}%)</>
                                    )}
                                  </span>
                                  {isIsolated && (
                                    <span className="text-xs" style={{ color: "#E35D24" }}>Focused</span>
                                  )}
                                </div>
                              );
                            })}
                          </div>
                        </div>
                      )}
                    </div>
                  );
                })()}
              </div>
            </div>
          </motion.aside>
        )}
      </AnimatePresence>

      {/* Fullscreen Chart Modal */}
      <AnimatePresence>
        {chartFullscreen && (
          <motion.div
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            exit={{ opacity: 0 }}
            className="fixed inset-0 z-50 flex items-center justify-center"
            style={{
              background: isDark ? 'rgba(0,0,0,0.85)' : 'rgba(0,0,0,0.75)',
              backdropFilter: 'blur(4px)',
            }}
            onClick={() => setChartFullscreen(false)}
          >
            <motion.div
              initial={{ scale: 0.9, opacity: 0 }}
              animate={{ scale: 1, opacity: 1 }}
              exit={{ scale: 0.9, opacity: 0 }}
              transition={{ duration: 0.2 }}
              className="relative w-full h-full max-w-[95vw] max-h-[95vh] m-4 flex flex-col"
              style={{
                background: isDark ? "#121210" : "#F5F0E8",
                borderRadius: '12px',
                border: `1px solid ${borderColor}`,
                boxShadow: isDark
                  ? '0 20px 60px rgba(0,0,0,0.5)'
                  : '0 20px 60px rgba(61,57,41,0.2)',
              }}
              onClick={(e) => e.stopPropagation()}
            >
              {/* Modal Header */}
              <div className="flex items-center justify-between px-6 h-16 shrink-0" style={{ borderBottom: `1px solid ${borderColor}` }}>
                <div className="flex items-center gap-3">
                  <BarChart3 className="h-5 w-5" style={{ color: "#E35D24" }} />
                  <h2 className="text-lg font-semibold" style={{ color: textPrimary }}>
                    Chart Visualization
                  </h2>
                  <Badge variant="outline" className="text-xs" style={{ borderColor, color: textMuted }}>
                    {agentData?.chart_type?.toUpperCase() || "CHART"}
                  </Badge>
                </div>
                <div className="flex items-center gap-2">
                  {/* Download Button in Modal */}
                  <button
                    onClick={() => {
                      if (chartRef.current) {
                        try {
                          const instance = chartRef.current.getEchartsInstance();
                          if (instance) {
                            const url = instance.getDataURL({
                              type: 'png',
                              pixelRatio: 3,
                              backgroundColor: isDark ? '#121210' : '#F5F0E8'
                            });
                            const link = document.createElement('a');
                            link.download = `sre-intelligence-chart-${Date.now()}.png`;
                            link.href = url;
                            link.click();
                            toast.success("Chart downloaded successfully");
                          }
                        } catch (error) {
                          console.error("Error downloading chart:", error);
                          toast.error("Failed to download chart");
                        }
                      }
                    }}
                    className="p-2 rounded-lg transition-all duration-150 ease-out"
                    style={{
                      color: textMuted,
                      background: 'transparent',
                    }}
                    onMouseEnter={(e) => {
                      e.currentTarget.style.background = isDark ? `rgba(255,255,255,0.08)` : `rgba(61,57,41,0.08)`;
                    }}
                    onMouseLeave={(e) => {
                      e.currentTarget.style.background = "transparent";
                    }}
                    title="Download chart"
                    aria-label="Download chart"
                  >
                    <Download className="h-5 w-5" />
                  </button>
                  {/* Close Button */}
                  <button
                    onClick={() => setChartFullscreen(false)}
                    className="p-2 rounded-lg transition-all duration-150 ease-out"
                    style={{
                      color: textMuted,
                      background: 'transparent',
                    }}
                    onMouseEnter={(e) => {
                      e.currentTarget.style.background = isDark ? `rgba(255,255,255,0.08)` : `rgba(61,57,41,0.08)`;
                    }}
                    onMouseLeave={(e) => {
                      e.currentTarget.style.background = "transparent";
                    }}
                    title="Close fullscreen"
                    aria-label="Close fullscreen"
                  >
                    <X className="h-5 w-5" />
                  </button>
                </div>
              </div>
              {/* Fullscreen Chart Container */}
              <div className="flex-1 overflow-hidden p-6">
                <div
                  className="w-full h-full rounded-lg"
                  style={{
                    background: isDark ? "rgba(255,255,255,0.04)" : "rgba(61,57,41,0.04)",
                    border: `1px solid ${borderColor}`,
                    padding: '24px',
                  }}
                >
                  {(() => {
                    const finalOption: any = chartOption || agentData?.chart_spec;
                    if (!finalOption || !finalOption.series || finalOption.series.length === 0) {
                      return (
                        <div className="flex items-center justify-center h-full" style={{ color: textMuted }}>
                          No chart data available
                        </div>
                      );
                    }
                    return (
                      <ReactECharts
                        key={`chart-fullscreen-${chartKey}-${agentData?.chart_type || 'default'}`}
                        option={finalOption}
                        style={{
                          height: "100%",
                          width: "100%",
                          display: "block"
                        }}
                        opts={{
                          renderer: "canvas",
                          devicePixelRatio: Math.min(window.devicePixelRatio || 1, 3),
                          locale: 'en'
                        }}
                        notMerge={true}
                        lazyUpdate={false}
                        onChartReady={(chart: any) => {
                          if (chart && chart.resize) {
                            requestAnimationFrame(() => chart.resize());
                            setTimeout(() => chart.resize(), 50);
                            setTimeout(() => chart.resize(), 150);
                          }
                        }}
                      />
                    );
                  })()}
                </div>
              </div>
            </motion.div>
          </motion.div>
        )}
      </AnimatePresence>
    </div>
  );
}

export default CopilotLayout;
