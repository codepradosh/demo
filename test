#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Pull incident data from PostgreSQL for the last 3 months.
Detailed handling of date columns to prevent CSV/Excel formatting issues.
"""

import os
import sys
import pandas as pd
import logging
import traceback
from datetime import datetime
from urllib.parse import quote_plus

# PostgreSQL client
try:
    from sqlalchemy import create_engine, text
    POSTGRES_AVAILABLE = True
except ImportError:
    POSTGRES_AVAILABLE = False
    print("ERROR: PostgreSQL libraries not available.")
    print("Please install: pip install psycopg2-binary sqlalchemy pandas")
    sys.exit(1)

# ------------------------------------------------------------------------
# Configuration
# ------------------------------------------------------------------------
POSTGRES_CONFIG = {
    'host': os.getenv('PGHOST', 'xd1e1159676dev.ubscloud-prod.msad.ubs.net'),
    'port': os.getenv('PGPORT', '5432'),
    'database': os.getenv('PGDATABASE', 'service_automation_db'),
    'user': os.getenv('PGUSER', 'powerbi_user'),
    'password': os.getenv('PGPASSWORD', 'Report@123'),
    'table_name': 'incident_data' 
}

OUTPUT_FILE = "incident_data_last_3_months.csv"

# ------------------------------------------------------------------------
# Logging Configuration
# ------------------------------------------------------------------------
def setup_logging():
    """Set up logging to console."""
    logging.basicConfig(
        level=logging.INFO,
        format='%(asctime)s - %(levelname)s - %(message)s',
        datefmt='%Y-%m-%d %H:%M:%S'
    )

# ------------------------------------------------------------------------
# Main Function
# ------------------------------------------------------------------------
def pull_incidents():
    """
    Connect to PostgreSQL, run robust query, and save to CSV.
    """
    setup_logging()
    
    if not POSTGRES_AVAILABLE:
        logging.error("PostgreSQL libraries are missing.")
        return False

    try:
        logging.info("="*80)
        logging.info("üì• Pulling Incident Data from PostgreSQL")
        logging.info("="*80)
        
        # Connection details
        user = POSTGRES_CONFIG['user']
        password = POSTGRES_CONFIG['password']
        host = POSTGRES_CONFIG['host']
        port = POSTGRES_CONFIG['port']
        database = POSTGRES_CONFIG['database']
        
        # Create connection string
        if password:
            encoded_password = quote_plus(password)
            connection_string = f"postgresql://{user}:{encoded_password}@{host}:{port}/{database}"
        else:
            connection_string = f"postgresql://{user}@{host}:{port}/{database}"
            
        logging.info(f"   Connecting to {host}:{port}/{database}...")
        engine = create_engine(connection_string)
        
        # The Query
        # 1. Filters for incidents opened on or after Oct 1st, 2025
        # 2. Formats opened_at as string to prevent CSV corruption
        query = """
        SELECT 
            TO_CHAR(opened_at, 'YYYY-MM-DD HH24:MI:SS') as opened_at_formatted,
            *
        FROM incident_data 
        WHERE 
            opened_at >= '2025-10-01'
        ORDER BY opened_at DESC;
        """
        
        logging.info("   Executing query (Last 3 Months from 2025-10-01)...")
        
        # specialized execution to prevent memory issues with huge datasets if helpful, 
        # but for 3 months `pd.read_sql` should be fine.
        df = pd.read_sql(query, engine)
        
        row_count = len(df)
        logging.info(f"‚úÖ Query successful. Retrieved {row_count:,} records.")
        
        if row_count > 0:
            logging.info(f"   Sample formatted date: {df['opened_at_formatted'].iloc[0]}")
            
            logging.info(f"‚è≥ Saving to {OUTPUT_FILE}...")
            # Save to CSV
            # index=False: don't save the pandas row index
            # coding='utf-8-sig': helps Excel open UTF-8 files correctly with BOM
            df.to_csv(OUTPUT_FILE, index=False, encoding='utf-8-sig')
            
            logging.info(f"‚úÖ File saved successfully: {os.path.abspath(OUTPUT_FILE)}")
            logging.info(f"   File size: {os.path.getsize(OUTPUT_FILE) / (1024*1024):.2f} MB")
        else:
            logging.warning("‚ö†Ô∏è  No data found for the specified date range.")

    except Exception as e:
        logging.error(f"‚ùå Error: {e}")
        logging.error(traceback.format_exc())
        return False
        
    return True

if __name__ == "__main__":
    pull_incidents()
