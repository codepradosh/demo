#!/usr/bin/env python3
"""
RAW CSV Cleaner - Reads file as text, checks incident_number column
"""

import sys

if len(sys.argv) < 3:
    print("Usage: python clean_raw.py input.csv output.csv")
    sys.exit(1)

input_file = sys.argv[1]
output_file = sys.argv[2]

print("=" * 60)
print("ğŸ§¹ RAW CSV CLEANER (Text-based)")
print("=" * 60)
print(f"Input:  {input_file}")
print(f"Output: {output_file}")

# Read as raw text
print("\nğŸ“– Reading file as raw text...")
with open(input_file, 'r', encoding='utf-8', errors='replace') as f:
    lines = f.readlines()

total_lines = len(lines)
print(f"   Total lines: {total_lines:,}")

# Parse header to find incident_number column index
header = lines[0]
header_fields = header.strip().split(',')
print(f"\nğŸ” Header columns: {len(header_fields)}")

# Find incident_number column
incident_col_idx = None
for i, col in enumerate(header_fields):
    if 'incident_number' in col.lower():
        incident_col_idx = i
        print(f"   Found 'incident_number' at column index {i} (column name: '{col}')")
        break

if incident_col_idx is None:
    print("âŒ ERROR: 'incident_number' column not found in header!")
    print(f"   Available columns: {header_fields[:10]}...")
    sys.exit(1)

# Show sample lines
print("\nğŸ” First 5 data lines (incident_number values):")
for i, line in enumerate(lines[1:6], start=1):
    fields = line.strip().split(',')
    if len(fields) > incident_col_idx:
        inc_val = fields[incident_col_idx]
        print(f"   Line {i}: incident_number = '{inc_val[:50]}'")

print("\nğŸ” Last 5 data lines (incident_number values):")
for i, line in enumerate(lines[-5:], start=total_lines-5):
    fields = line.strip().split(',')
    if len(fields) > incident_col_idx:
        inc_val = fields[incident_col_idx]
        print(f"   Line {i}: incident_number = '{inc_val[:50]}'")

# Filter: Keep only lines where incident_number starts with 'INC'
print("\nğŸ” Filtering lines based on incident_number column...")

valid_lines = [header]  # Keep header
invalid_count = 0
invalid_examples = []

for i, line in enumerate(lines[1:], start=1):
    fields = line.strip().split(',')
    
    # Get incident_number value
    if len(fields) > incident_col_idx:
        inc_value = fields[incident_col_idx].strip()
        
        if inc_value.startswith('INC'):
            valid_lines.append(line)
        else:
            invalid_count += 1
            if len(invalid_examples) < 20:
                invalid_examples.append(f"Line {i}: '{inc_value[:60]}'")
    else:
        # Row has fewer columns than expected
        invalid_count += 1
        if len(invalid_examples) < 20:
            invalid_examples.append(f"Line {i}: <missing columns>")

print(f"\nâŒ Found {invalid_count:,} INVALID lines")
if invalid_examples:
    print("   Examples of invalid incident_number values:")
    for ex in invalid_examples:
        print(f"      {ex}")

print(f"\nâœ… Valid lines: {len(valid_lines):,} (including header)")

# Write output
print(f"\nğŸ’¾ Saving to {output_file}...")
with open(output_file, 'w', encoding='utf-8') as f:
    f.writelines(valid_lines)

print("\n" + "=" * 60)
print("ğŸ“Š SUMMARY")
print("=" * 60)
print(f"   Original lines: {total_lines:,}")
print(f"   Invalid removed: {invalid_count:,}")
print(f"   Final lines: {len(valid_lines):,}")
print("âœ… DONE!")
