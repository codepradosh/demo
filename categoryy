#!/usr/bin/env python3
"""
CSV Cleaner - Removes rows where Cluster Group OR RCA Category is empty
"""

import pandas as pd
import sys

if len(sys.argv) < 3:
    print("Usage: python clean_csv_final.py input.csv output.csv")
    sys.exit(1)

input_file = sys.argv[1]
output_file = sys.argv[2]

print("=" * 60)
print("ðŸ§¹ CSV CLEANER (Remove Blank Cluster Group / RCA Category)")
print("=" * 60)
print(f"Input:  {input_file}")
print(f"Output: {output_file}")

# Read CSV
print("\nðŸ“– Loading CSV...")
df = pd.read_csv(input_file, low_memory=False)
initial_rows = len(df)
print(f"   Loaded {initial_rows:,} rows")

# Find columns (handle different naming)
cluster_col = None
rca_col = None

for col in df.columns:
    if 'cluster' in col.lower() and 'group' in col.lower():
        cluster_col = col
    if 'rca' in col.lower() and 'category' in col.lower():
        rca_col = col

print(f"\nðŸ” Found columns:")
print(f"   Cluster Group: {cluster_col}")
print(f"   RCA Category: {rca_col}")

# Count blanks before filtering
blank_cluster = 0
blank_rca = 0

if cluster_col:
    blank_cluster = df[cluster_col].isna().sum() + (df[cluster_col].astype(str).str.strip() == '').sum()
    print(f"\n   Blank Cluster Group: {blank_cluster:,}")

if rca_col:
    blank_rca = df[rca_col].isna().sum() + (df[rca_col].astype(str).str.strip() == '').sum()
    print(f"   Blank RCA Category: {blank_rca:,}")

# Filter: Keep only rows where BOTH Cluster Group AND RCA Category are NOT empty
print(f"\nðŸ” Filtering rows...")

valid_mask = pd.Series([True] * len(df))

if cluster_col:
    valid_mask &= df[cluster_col].notna() & (df[cluster_col].astype(str).str.strip() != '')

if rca_col:
    valid_mask &= df[rca_col].notna() & (df[rca_col].astype(str).str.strip() != '')

df_clean = df[valid_mask].copy()
invalid_count = initial_rows - len(df_clean)

print(f"\nâŒ Removed {invalid_count:,} rows with blank values")

# Show examples
if invalid_count > 0:
    invalid_df = df[~valid_mask]
    print("\n   Examples of removed rows (incident_number):")
    for idx in invalid_df.head(15).index:
        inc_num = df.loc[idx, 'incident_number'] if 'incident_number' in df.columns else 'N/A'
        cg = df.loc[idx, cluster_col] if cluster_col else 'N/A'
        print(f"      Row {idx}: inc='{str(inc_num)[:40]}', cluster='{str(cg)[:20]}'")

print(f"\nâœ… Valid rows: {len(df_clean):,}")

# Save
print(f"\nðŸ’¾ Saving to {output_file}...")
df_clean.to_csv(output_file, index=False, encoding='utf-8')

print("\n" + "=" * 60)
print("ðŸ“Š SUMMARY")
print("=" * 60)
print(f"   Original rows:  {initial_rows:,}")
print(f"   Removed:        {invalid_count:,}")
print(f"   Final rows:     {len(df_clean):,}")
print("âœ… DONE!")
