#!/usr/bin/env python3
"""
Fix CSV - Remove newlines from inside cell values
This fixes the Excel vs Python parsing difference
"""

import csv
import sys
import re

if len(sys.argv) < 3:
    print("Usage: python fix_csv.py input.csv output.csv")
    sys.exit(1)

input_file = sys.argv[1]
output_file = sys.argv[2]

print("=" * 60)
print("ðŸ”§ FIX CSV - REMOVE EMBEDDED NEWLINES")
print("=" * 60)
print(f"Input:  {input_file}")
print(f"Output: {output_file}")

# Read with csv module
print("\nðŸ“– Reading CSV...")
with open(input_file, 'r', encoding='utf-8', errors='replace', newline='') as f:
    reader = csv.reader(f)
    all_rows = list(reader)

total_rows = len(all_rows)
print(f"   Rows read: {total_rows:,}")

# Clean each cell - remove newlines and garbage
print("\nðŸ§¹ Cleaning cells...")
cleaned_rows = []
cells_cleaned = 0

for row in all_rows:
    cleaned_row = []
    for cell in row:
        original = cell
        # Remove embedded newlines
        cleaned = cell.replace('\n', ' ').replace('\r', ' ')
        # Remove multiple spaces
        cleaned = re.sub(r'\s+', ' ', cleaned).strip()
        
        if cleaned != original:
            cells_cleaned += 1
        
        cleaned_row.append(cleaned)
    cleaned_rows.append(cleaned_row)

print(f"   Cells with newlines removed: {cells_cleaned:,}")

# Also filter valid rows (INC + non-blank CG)
print("\nðŸ” Filtering valid rows...")
header = cleaned_rows[0]

# Find column indices
inc_idx = None
cg_idx = None
for i, col in enumerate(header):
    if 'incident_number' in col.lower():
        inc_idx = i
    if 'cluster' in col.lower():
        cg_idx = i

print(f"   incident_number: column {inc_idx}")
print(f"   Cluster Group: column {cg_idx}")

valid_rows = [header]
removed_inc = 0
removed_cg = 0

for row in cleaned_rows[1:]:
    if len(row) <= max(inc_idx or 0, cg_idx or 0):
        removed_inc += 1
        continue
    
    # Check INC
    inc_val = row[inc_idx].strip() if inc_idx is not None else ''
    if not inc_val.startswith('INC'):
        removed_inc += 1
        continue
    
    # Check CG
    cg_val = row[cg_idx].strip() if cg_idx is not None else ''
    if cg_val == '' or cg_val.lower() == 'nan':
        removed_cg += 1
        continue
    
    valid_rows.append(row)

print(f"   Removed (no INC): {removed_inc:,}")
print(f"   Removed (blank CG): {removed_cg:,}")

# Save
print(f"\nðŸ’¾ Saving to {output_file}...")
with open(output_file, 'w', encoding='utf-8', newline='') as f:
    writer = csv.writer(f, quoting=csv.QUOTE_ALL)  # Quote all fields to prevent issues
    writer.writerows(valid_rows)

print("\n" + "=" * 60)
print("ðŸ“Š SUMMARY")
print("=" * 60)
print(f"   Original rows: {total_rows:,}")
print(f"   Cells cleaned: {cells_cleaned:,}")
print(f"   Final rows:    {len(valid_rows):,}")
print("\nâœ… Open this in Excel - should be clean now!")
