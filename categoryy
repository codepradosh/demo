#!/usr/bin/env python3
"""
CSV to Excel - Two-step approach:
1. First convert CSV to XLSX (raw)
2. Then read XLSX, filter INC rows, save cleaned XLSX
"""

import pandas as pd
import sys
import os

if len(sys.argv) < 3:
    print("Usage: python to_excel.py input.csv output.xlsx")
    sys.exit(1)

input_file = sys.argv[1]
output_file = sys.argv[2]

print("=" * 60)
print("ðŸ“Š CSV TO EXCEL (TWO-STEP APPROACH)")
print("=" * 60)

# ========== STEP 1: Convert CSV to XLSX (raw) ==========
print("\n" + "=" * 40)
print("STEP 1: Convert CSV to XLSX (raw)")
print("=" * 40)

temp_xlsx = "temp_raw.xlsx"

print(f"\nðŸ“– Reading CSV: {input_file}")
df = pd.read_csv(input_file, low_memory=False)
print(f"   Loaded {len(df):,} rows")

print(f"\nðŸ’¾ Saving to temp XLSX: {temp_xlsx}")
df.to_excel(temp_xlsx, index=False, engine='openpyxl')
print(f"   âœ… Saved!")

# ========== STEP 2: Read XLSX, filter, save ==========
print("\n" + "=" * 40)
print("STEP 2: Read XLSX, filter INC rows, save")
print("=" * 40)

print(f"\nðŸ“– Reading XLSX: {temp_xlsx}")
df2 = pd.read_excel(temp_xlsx, engine='openpyxl')
print(f"   Loaded {len(df2):,} rows")

# Filter: Keep only rows where incident_number starts with 'INC'
print("\nðŸ” Filtering: Keep only INC rows...")
if 'incident_number' in df2.columns:
    initial = len(df2)
    mask = df2['incident_number'].astype(str).str.startswith('INC')
    df2 = df2[mask].copy()
    removed = initial - len(df2)
    print(f"   Removed {removed:,} non-INC rows")
    print(f"   Remaining: {len(df2):,}")

# Clean newlines
print("\nðŸ§¹ Cleaning newlines...")
for col in df2.columns:
    if df2[col].dtype == 'object':
        df2[col] = df2[col].astype(str).str.replace('\n', ' ', regex=False)
        df2[col] = df2[col].astype(str).str.replace('\r', ' ', regex=False)

# Save final
print(f"\nðŸ’¾ Saving final XLSX: {output_file}")
df2.to_excel(output_file, index=False, engine='openpyxl')
print(f"   âœ… Saved!")

# Cleanup temp file
os.remove(temp_xlsx)
print(f"   ðŸ—‘ï¸ Removed temp file")

print("\n" + "=" * 60)
print("ðŸ“Š FINAL SUMMARY")
print("=" * 60)
print(f"   Final rows: {len(df2):,}")
print(f"\nâœ… Open {output_file} in Excel!")
