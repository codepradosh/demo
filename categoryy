#!/usr/bin/env python3
"""
Extract ONLY valid INC lines from corrupted CSV
"""

import sys

if len(sys.argv) < 3:
    print("Usage: python extract_valid.py input.csv output.csv")
    sys.exit(1)

input_file = sys.argv[1]
output_file = sys.argv[2]

print("=" * 70)
print("ðŸ”§ EXTRACTING VALID LINES FROM CORRUPTED CSV")
print("=" * 70)
print(f"Input:  {input_file}")
print(f"Output: {output_file}")

# Read file
print("\nðŸ“– Reading file...")
with open(input_file, 'r', encoding='utf-8', errors='replace') as f:
    lines = f.readlines()

total_lines = len(lines)
print(f"   Total lines in file: {total_lines:,}")

# Extract valid lines
print("\nðŸ” Extracting valid lines...")
valid_lines = []
header_saved = False
blank_count = 0
garbage_count = 0

for i, line in enumerate(lines):
    # Get first field
    first_field = line.split(',')[0].strip()
    
    # Save header (first non-empty line with 'incident_number')
    if not header_saved:
        if 'incident_number' in first_field.lower():
            valid_lines.append(line)
            header_saved = True
            print(f"   Found header at line {i}")
            continue
    
    # Check if line starts with INC
    if first_field.startswith('INC'):
        valid_lines.append(line)
    elif first_field == '' or first_field.lower() == 'nan':
        blank_count += 1
    else:
        garbage_count += 1
        if garbage_count <= 10:
            print(f"   Garbage line {i}: '{first_field[:50]}'")

print(f"\nðŸ“Š Results:")
print(f"   Valid INC lines: {len(valid_lines):,}")
print(f"   Blank lines removed: {blank_count:,}")
print(f"   Garbage lines removed: {garbage_count:,}")

# Save valid lines
print(f"\nðŸ’¾ Saving to {output_file}...")
with open(output_file, 'w', encoding='utf-8') as f:
    f.writelines(valid_lines)

print(f"\nâœ… DONE!")
print(f"   Output file has {len(valid_lines):,} lines (including header)")
print(f"\n   Open {output_file} in Excel - no more blanks or garbage!")
