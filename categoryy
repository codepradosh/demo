#!/usr/bin/env python3
"""
CSV Cleaner - Removes rows where cleaned_description is empty
"""

import pandas as pd
import sys

if len(sys.argv) < 3:
    print("Usage: python clean_csv_final.py input.csv output.csv")
    sys.exit(1)

input_file = sys.argv[1]
output_file = sys.argv[2]

print("=" * 60)
print("ğŸ§¹ CSV CLEANER (cleaned_description validation)")
print("=" * 60)
print(f"Input:  {input_file}")
print(f"Output: {output_file}")

# Read CSV with pandas
print("\nğŸ“– Loading CSV with pandas...")
df = pd.read_csv(input_file, low_memory=False)
initial_rows = len(df)
print(f"   Loaded {initial_rows:,} rows, {len(df.columns)} columns")

# Check if cleaned_description column exists
if 'cleaned_description' not in df.columns:
    print("âŒ ERROR: 'cleaned_description' column not found!")
    print(f"   Available columns: {df.columns.tolist()[:10]}...")
    sys.exit(1)

print(f"\nğŸ” Checking 'cleaned_description' column...")

# Show sample values
print("\n   First 5 cleaned_description values:")
for idx, val in df['cleaned_description'].head(5).items():
    is_empty = pd.isna(val) or str(val).strip() == ''
    status = "âŒ EMPTY" if is_empty else "âœ… OK"
    print(f"      Row {idx}: '{str(val)[:40]}...' {status}")

# Filter: Keep only rows where cleaned_description is NOT empty
print(f"\nğŸ” Filtering rows...")

# Create mask for valid rows (not NaN and not empty string)
valid_mask = df['cleaned_description'].notna() & (df['cleaned_description'].astype(str).str.strip() != '')
df_clean = df[valid_mask].copy()

invalid_count = initial_rows - len(df_clean)

if invalid_count > 0:
    print(f"\nâŒ Found {invalid_count:,} rows with EMPTY cleaned_description")
    
    # Show examples with incident_number
    invalid_df = df[~valid_mask]
    print("\n   Examples of incident_number values being removed:")
    for idx in invalid_df.head(20).index:
        inc_num = df.loc[idx, 'incident_number'] if 'incident_number' in df.columns else 'N/A'
        print(f"      Row {idx}: '{str(inc_num)[:60]}'")
else:
    print(f"\nâœ… All rows have valid cleaned_description values")

print(f"\nâœ… Valid rows: {len(df_clean):,}")

# Save cleaned CSV
print(f"\nğŸ’¾ Saving to {output_file}...")
df_clean.to_csv(output_file, index=False, encoding='utf-8')

print("\n" + "=" * 60)
print("ğŸ“Š SUMMARY")
print("=" * 60)
print(f"   Original rows:  {initial_rows:,}")
print(f"   Invalid removed: {invalid_count:,}")
print(f"   Final rows:     {len(df_clean):,}")
print("âœ… DONE!")
