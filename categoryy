#!/usr/bin/env python3
"""
CSV Cleaner Script
Removes rows with empty/null values from a CSV file.

Usage:
    python clean_csv.py input.csv output.csv
    python clean_csv.py input.csv output.csv --threshold 0
    python clean_csv.py input.csv output.csv --columns incident_number opened_at short_description
"""

import pandas as pd
import argparse
import sys
from pathlib import Path


def remove_empty_rows(df, check_columns=None, threshold=3, check_all=False):
    """
    Remove rows with too many empty cells (NaNs or empty strings).
    
    Args:
        df (pd.DataFrame): The input DataFrame.
        check_columns (list): List of column names to check.
        threshold (int): Maximum allowed empty cells before a row is removed.
        check_all (bool): If True, checks all columns in the DataFrame.
        
    Returns:
        tuple: (cleaned DataFrame, number of rows removed)
    """
    
    # Initial check: if no columns are specified and check_all is False, do nothing
    if not check_all and not check_columns:
        return df, 0

    initial_rows = len(df)

    # Determine columns to check
    if check_all:
        cols_to_check = df.columns.tolist()
    else:
        cols_to_check = []
        for col in check_columns:
            if col in df.columns:
                cols_to_check.append(col)
            # Handle 1-based integer indexing for columns
            elif isinstance(col, int) and 0 < col <= len(df.columns):
                cols_to_check.append(df.columns[col - 1])

    # If no valid columns were found, return the original dataframe
    if not cols_to_check:
        print(f"‚ö†Ô∏è Warning: None of the specified columns were found in the CSV")
        print(f"   Available columns: {df.columns.tolist()}")
        return df, 0

    print(f"   Checking columns: {cols_to_check}")

    # 1. Count NaN values across the specified columns (axis=1 is row-wise)
    empty_count = df[cols_to_check].isna().sum(axis=1)

    # 2. Count empty or whitespace-only strings
    for col in cols_to_check:
        if df[col].dtype == "object":
            # Adds 1 to the count if the value is a string and is empty after stripping
            empty_count += df[col].apply(
                lambda x: 1 if isinstance(x, str) and x.strip() == "" else 0
            )

    # Remove rows where the total empty count exceeds the threshold
    df_cleaned = df[empty_count <= threshold].copy()
    
    rows_removed = initial_rows - len(df_cleaned)

    return df_cleaned, rows_removed


def remove_invalid_incidents(df):
    """
    Remove rows where incident_number doesn't start with INC1 or INC2.
    """
    if 'incident_number' not in df.columns:
        return df, 0
    
    initial_rows = len(df)
    
    def is_valid_incident(val):
        if pd.isna(val):
            return False
        s = str(val).strip()
        return s.startswith('INC1') or s.startswith('INC2')
    
    valid_mask = df['incident_number'].apply(is_valid_incident)
    df_cleaned = df[valid_mask].copy()
    
    rows_removed = initial_rows - len(df_cleaned)
    return df_cleaned, rows_removed


def main():
    parser = argparse.ArgumentParser(
        description='Clean CSV file by removing rows with empty values',
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
Examples:
  python clean_csv.py input.csv output.csv
  python clean_csv.py input.csv output.csv --threshold 0
  python clean_csv.py input.csv output.csv --columns incident_number opened_at short_description
  python clean_csv.py input.csv output.csv --check-all --threshold 5
        """
    )
    
    parser.add_argument('input_csv', help='Path to input CSV file')
    parser.add_argument('output_csv', help='Path to output CSV file')
    parser.add_argument('--columns', nargs='+', 
                        default=['incident_number', 'opened_at', 'short_description'],
                        help='Columns to check for empty values (default: incident_number opened_at short_description)')
    parser.add_argument('--threshold', type=int, default=0,
                        help='Maximum allowed empty cells per row (default: 0 = no empty cells allowed)')
    parser.add_argument('--check-all', action='store_true',
                        help='Check all columns instead of specified ones')
    parser.add_argument('--validate-inc', action='store_true', default=True,
                        help='Remove rows where incident_number does not start with INC1 or INC2 (default: True)')
    
    args = parser.parse_args()
    
    # Check input file exists
    input_path = Path(args.input_csv)
    if not input_path.exists():
        print(f"‚ùå Error: Input file not found: {args.input_csv}")
        sys.exit(1)
    
    print("=" * 60)
    print("üßπ CSV CLEANER")
    print("=" * 60)
    print(f"üìÇ Input:  {args.input_csv}")
    print(f"üìÇ Output: {args.output_csv}")
    print(f"üìã Columns to check: {args.columns if not args.check_all else 'ALL'}")
    print(f"üî¢ Threshold: {args.threshold} (max empty cells allowed)")
    print("")
    
    # Load CSV
    print("üìñ Loading CSV...")
    try:
        df = pd.read_csv(args.input_csv)
        print(f"   Loaded {len(df):,} rows, {len(df.columns)} columns")
    except Exception as e:
        print(f"‚ùå Error loading CSV: {e}")
        sys.exit(1)
    
    total_removed = 0
    
    # Step 1: Remove rows with invalid incident_number (INC1/INC2 check)
    if args.validate_inc:
        print("\nüîç Step 1: Validating incident_number (INC1/INC2)...")
        df, removed = remove_invalid_incidents(df)
        if removed > 0:
            print(f"   ‚úÖ Removed {removed:,} rows with invalid incident_number")
        else:
            print(f"   ‚úÖ All incident numbers are valid")
        total_removed += removed
    
    # Step 2: Remove rows with empty values
    print(f"\nüîç Step 2: Checking for empty values (threshold: {args.threshold})...")
    df, removed = remove_empty_rows(
        df, 
        check_columns=args.columns if not args.check_all else None,
        threshold=args.threshold,
        check_all=args.check_all
    )
    if removed > 0:
        print(f"   ‚úÖ Removed {removed:,} rows with too many empty values")
    else:
        print(f"   ‚úÖ No rows exceeded the empty threshold")
    total_removed += removed
    
    # Save output
    print(f"\nüíæ Saving cleaned CSV...")
    try:
        df.to_csv(args.output_csv, index=False, encoding='utf-8')
        print(f"   ‚úÖ Saved to: {args.output_csv}")
        print(f"   üìä Final row count: {len(df):,}")
    except Exception as e:
        print(f"‚ùå Error saving CSV: {e}")
        sys.exit(1)
    
    # Summary
    print("\n" + "=" * 60)
    print("üìä SUMMARY")
    print("=" * 60)
    print(f"   Original rows:  {len(df) + total_removed:,}")
    print(f"   Rows removed:   {total_removed:,}")
    print(f"   Final rows:     {len(df):,}")
    print("‚úÖ Done!")


if __name__ == "__main__":
    main()
