#!/usr/bin/env python3
"""
CSV Cleaner - Uses pandas to properly parse CSV
Removes rows where opened_at is blank or not a valid datetime
"""

import pandas as pd
import sys
import re

if len(sys.argv) < 3:
    print("Usage: python clean_csv_datetime.py input.csv output.csv")
    sys.exit(1)

input_file = sys.argv[1]
output_file = sys.argv[2]

print("=" * 60)
print("ğŸ§¹ CSV CLEANER (opened_at datetime validation)")
print("=" * 60)
print(f"Input:  {input_file}")
print(f"Output: {output_file}")

# Datetime pattern: YYYY-MM-DD
datetime_pattern = re.compile(r'^\d{4}-\d{2}-\d{2}')

def is_valid_datetime(value):
    """Check if value looks like a datetime"""
    if pd.isna(value):
        return False
    val_str = str(value).strip()
    if val_str == '' or val_str == 'nan':
        return False
    return bool(datetime_pattern.match(val_str))

# Read CSV with pandas
print("\nğŸ“– Loading CSV with pandas...")
df = pd.read_csv(input_file, low_memory=False)
initial_rows = len(df)
print(f"   Loaded {initial_rows:,} rows, {len(df.columns)} columns")

# Check if opened_at column exists
if 'opened_at' not in df.columns:
    print("âŒ ERROR: 'opened_at' column not found!")
    print(f"   Available columns: {df.columns.tolist()[:10]}...")
    sys.exit(1)

print(f"\nğŸ” Checking 'opened_at' column...")

# Show sample values
print("\n   First 5 opened_at values:")
for idx, val in df['opened_at'].head(5).items():
    valid = "âœ…" if is_valid_datetime(val) else "âŒ"
    print(f"      Row {idx}: '{str(val)[:40]}' {valid}")

print("\n   Last 5 opened_at values:")
for idx, val in df['opened_at'].tail(5).items():
    valid = "âœ…" if is_valid_datetime(val) else "âŒ"
    print(f"      Row {idx}: '{str(val)[:40]}' {valid}")

# Filter: Keep only rows with valid datetime in opened_at
print(f"\nğŸ” Filtering rows...")
valid_mask = df['opened_at'].apply(is_valid_datetime)
df_clean = df[valid_mask].copy()

invalid_count = initial_rows - len(df_clean)

if invalid_count > 0:
    print(f"\nâŒ Found {invalid_count:,} INVALID rows")
    
    # Show examples
    invalid_df = df[~valid_mask]
    print("\n   Examples of invalid rows:")
    for idx in invalid_df.head(10).index:
        inc_num = df.loc[idx, 'incident_number'] if 'incident_number' in df.columns else 'N/A'
        opened_val = df.loc[idx, 'opened_at']
        print(f"      Row {idx}: incident='{str(inc_num)[:30]}', opened_at='{str(opened_val)[:30]}'")
else:
    print(f"\nâœ… All rows have valid opened_at values")

print(f"\nâœ… Valid rows: {len(df_clean):,}")

# Save cleaned CSV
print(f"\nğŸ’¾ Saving to {output_file}...")
df_clean.to_csv(output_file, index=False, encoding='utf-8')

print("\n" + "=" * 60)
print("ğŸ“Š SUMMARY")
print("=" * 60)
print(f"   Original rows:  {initial_rows:,}")
print(f"   Invalid removed: {invalid_count:,}")
print(f"   Final rows:     {len(df_clean):,}")
print("âœ… DONE!")
