#!/usr/bin/env python3
"""
CSV to Excel - Clean illegal characters before saving
"""

import pandas as pd
import sys
import re

if len(sys.argv) < 3:
    print("Usage: python to_excel.py input.csv output.xlsx")
    sys.exit(1)

input_file = sys.argv[1]
output_file = sys.argv[2]

# Function to remove illegal Excel characters
ILLEGAL_CHARS_RE = re.compile(r'[\x00-\x08\x0b\x0c\x0e-\x1f]')

def clean_illegal_chars(val):
    if pd.isna(val):
        return val
    return ILLEGAL_CHARS_RE.sub('', str(val))

print("=" * 60)
print("ðŸ“Š CSV TO EXCEL")
print("=" * 60)

# Step 1: Read CSV
print(f"\nðŸ“– Reading CSV: {input_file}")
df = pd.read_csv(input_file, low_memory=False)
print(f"   Loaded {len(df):,} rows")

# Step 2: Filter INC rows
print("\nðŸ” Filtering: Keep only INC rows...")
if 'incident_number' in df.columns:
    initial = len(df)
    mask = df['incident_number'].astype(str).str.startswith('INC')
    df = df[mask].copy()
    print(f"   Removed {initial - len(df):,} non-INC rows")
    print(f"   Remaining: {len(df):,}")

# Step 3: Clean ALL text columns (remove newlines + illegal chars)
print("\nðŸ§¹ Cleaning text columns...")
for col in df.columns:
    if df[col].dtype == 'object':
        # Remove newlines
        df[col] = df[col].astype(str).str.replace('\n', ' ', regex=False)
        df[col] = df[col].astype(str).str.replace('\r', ' ', regex=False)
        # Remove illegal Excel characters
        df[col] = df[col].apply(clean_illegal_chars)

print("   âœ… Cleaned!")

# Step 4: Save to Excel
print(f"\nðŸ’¾ Saving to Excel: {output_file}")
df.to_excel(output_file, index=False, engine='openpyxl')
print("   âœ… Saved!")

print("\n" + "=" * 60)
print(f"âœ… DONE! Final: {len(df):,} rows")
print(f"   Open {output_file} in Excel")
