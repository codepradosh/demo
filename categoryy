#!/usr/bin/env python3
"""
Clean CSV Post-Processor
Uses Python's csv module for proper parsing
Removes rows where:
1. incident_number doesn't start with 'INC'
2. Cluster Group is blank
"""

import csv
import sys

if len(sys.argv) < 3:
    print("Usage: python post_process.py input.csv output.csv")
    sys.exit(1)

input_file = sys.argv[1]
output_file = sys.argv[2]

print("=" * 60)
print("ðŸ§¹ CSV POST-PROCESSOR")
print("=" * 60)
print(f"Input:  {input_file}")
print(f"Output: {output_file}")

# Read with csv module
print("\nðŸ“– Reading CSV...")
with open(input_file, 'r', encoding='utf-8', errors='replace', newline='') as f:
    reader = csv.reader(f)
    all_rows = list(reader)

total_rows = len(all_rows)
print(f"   Total rows (including header): {total_rows:,}")

if total_rows == 0:
    print("âŒ Empty file!")
    sys.exit(1)

# Get header and find column indices
header = all_rows[0]
print(f"   Columns: {len(header)}")

# Find incident_number and Cluster Group columns
inc_idx = None
cg_idx = None
for i, col in enumerate(header):
    if 'incident_number' in col.lower():
        inc_idx = i
    if 'cluster' in col.lower():
        cg_idx = i

print(f"   incident_number column index: {inc_idx}")
print(f"   Cluster Group column index: {cg_idx}")

# Filter rows
print("\nðŸ” Filtering...")
valid_rows = [header]  # Keep header
removed_no_inc = 0
removed_blank_cg = 0

for row in all_rows[1:]:
    # Check if row has enough columns
    if len(row) <= max(inc_idx or 0, cg_idx or 0):
        removed_no_inc += 1
        continue
    
    # Check incident_number starts with INC
    inc_val = row[inc_idx].strip() if inc_idx is not None else ''
    if not inc_val.startswith('INC'):
        removed_no_inc += 1
        continue
    
    # Check Cluster Group not blank
    cg_val = row[cg_idx].strip() if cg_idx is not None else ''
    if cg_val == '' or cg_val.lower() == 'nan':
        removed_blank_cg += 1
        continue
    
    # Valid row
    valid_rows.append(row)

print(f"   Removed (no INC): {removed_no_inc:,}")
print(f"   Removed (blank CG): {removed_blank_cg:,}")
print(f"   Valid rows: {len(valid_rows) - 1:,}")  # Minus header

# Write output
print(f"\nðŸ’¾ Saving to {output_file}...")
with open(output_file, 'w', encoding='utf-8', newline='') as f:
    writer = csv.writer(f)
    writer.writerows(valid_rows)

print("\n" + "=" * 60)
print("ðŸ“Š SUMMARY")
print("=" * 60)
print(f"   Original: {total_rows - 1:,} rows")
print(f"   Removed:  {removed_no_inc + removed_blank_cg:,} rows")
print(f"   Final:    {len(valid_rows) - 1:,} rows")
print("\nâœ… DONE! Use this file for your Pivot Table.")
